<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painless Mesh Gateway - Device Management</title>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    <!-- Coloris Color Picker - 使用内联实现 -->
    <style>
        /* 简化的颜色选择器样式 */
        input[type="color"] {
            width: 40px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 3px;
        }
    </style>
    
    <script>
        // 简化的Coloris实现
        window.Coloris = {
            init: function() {
                console.log('Coloris initialized (inline version)');
                return this;
            },
            
            open: function(input) {
                console.log('Opening color picker for:', input);
                if (input && input.click) {
                    input.click();
                }
                return this;
            },
            
            close: function() {
                console.log('Closing color picker');
                return this;
            }
        };
        
        // 配置函数
        window.Coloris = function(options) {
            console.log('Configuring Coloris with options:', options);
            if (options && options.el) {
                const elements = document.querySelectorAll(options.el);
                console.log('Found', elements.length, 'elements for Coloris');
                elements.forEach((el, index) => {
                    console.log(`Element ${index}:`, el);
                    if (el.type !== 'color') {
                        el.type = 'color';
                    }
                    
                    if (options.onChange) {
                        el.addEventListener('input', function() {
                            console.log('Color changed:', this.value, 'for element:', this);
                            options.onChange(this.value, this);
                        });
                        
                        el.addEventListener('change', function() {
                            console.log('Color change event:', this.value, 'for element:', this);
                            options.onChange(this.value, this);
                        });
                    }
                });
            }
            return window.Coloris;
        };
        
        // 重新添加方法到函数对象
        window.Coloris.init = function() {
            console.log('Coloris initialized (inline version)');
            return this;
        };
        
        window.Coloris.open = function(input) {
            console.log('Opening color picker for:', input);
            if (input && input.click) {
                input.click();
            }
            return this;
        };
        
        window.Coloris.close = function() {
            console.log('Closing color picker');
            return this;
        };
        
        console.log('Coloris inline implementation loaded');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            .loading-message, .no-devices-message {
                text-align: center;
                padding: 40px 20px;
                color: #64748b;
                font-size: 16px;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #e2e8f0;
                border-top: 4px solid #3b82f6;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 16px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .error-message {
                background: #fee2e2;
                border: 1px solid #fecaca;
                color: #dc2626;
                padding: 12px 16px;
                border-radius: 8px;
                margin: 16px 0;
                text-align: center;
            }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* 移动端响应式设计 */
        @media (max-width: 1240px) {
            .container {
                width: 95%;
                margin: 0 auto;
            }
            
            body {
                padding: 10px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .navigation-tabs {
                margin: 0 20px 20px 20px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 14px;
                min-height: 44px; /* 增加触摸目标大小 */
            }

            .main-content {
                padding: 20px;
            }

            .table-header {
                grid-template-columns: minmax(110px, 1.4fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(100px, 1fr) minmax(60px, 0.8fr) minmax(100px, 1fr);
                font-size: 12px;
            }

            .header-cell {
                padding: 15px 5px;
                font-size: 11px;
            }

            .table-row {
                grid-template-columns: minmax(110px, 1.4fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(100px, 1fr) minmax(60px, 0.8fr) minmax(100px, 1fr);
            }

            .table-cell {
                padding: 12px 5px;
                font-size: 13px;
            }

            .table-cell:first-child {
                padding-left: 10px;
            }

            .function-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .function-card {
                padding: 20px;
            }

            .functions-panel {
                padding: 20px;
            }

            /* 优化按钮触摸体验 */
            .action-button {
                min-height: 44px;
                padding: 12px 16px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .container {
                width: 100%;
                border-radius: 0;
                margin: 0;
            }

            body {
                padding: 0;
            }

            .header {
                padding: 12px 15px;
                border-radius: 0;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .navigation-tabs {
                margin: 0 15px 15px 15px;
                border-radius: 6px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 13px;
                min-height: 48px; /* 更大的触摸目标 */
            }
            
            /* 优化按钮触摸体验 */
            .action-btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 65px;
                min-height: 36px;
                margin: 1px;
            }
            
            .actions {
                gap: 3px;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
            }

            /* 优化表格单元格显示 */
            .table-cell {
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                min-height: 40px;
                align-items: flex-start;
                flex-wrap: wrap;
                word-break: break-word;
            }

            /* 优化设备名称显示 */
            .device-name {
                max-width: none;
                white-space: normal;
                word-break: break-word;
            }

            .main-content {
                padding: 15px;
            }

            /* 表格在小屏幕上的优化 */
            .devices-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
            }

            .table-header {
                grid-template-columns: minmax(120px, 1.2fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(100px, 1fr) minmax(60px, 0.6fr) minmax(80px, 0.8fr) minmax(200px, 2fr);
                font-size: 11px;
                min-width: 710px;
            }

            .header-cell {
                padding: 15px 8px;
                font-size: 10px;
                white-space: nowrap;
            }

            .table-row {
                grid-template-columns: minmax(120px, 1.2fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(100px, 1fr) minmax(60px, 0.6fr) minmax(80px, 0.8fr) minmax(200px, 2fr);
                min-width: 710px;
            }

            .table-cell {
                padding: 12px 8px;
                font-size: 12px;
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                min-height: 40px;
                align-items: flex-start;
                flex-wrap: wrap;
            }

            .table-cell:first-child {
                padding-left: 12px;
            }

            /* 优化设备名称显示 */
            .device-name {
                font-weight: 600;
                max-width: none;
                overflow: visible;
                text-overflow: unset;
                white-space: normal;
                word-break: break-word;
            }

            /* 优化按钮 */
            .action-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 60px;
                min-height: 32px;
            }
            
            .actions {
                gap: 4px;
                flex-wrap: wrap;
                justify-content: center;
            }

            /* 功能面板优化 */
            .function-card {
                padding: 20px 15px;
                margin-bottom: 15px;
            }

            .function-card h3 {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }

            .function-card p {
                font-size: 14px;
                line-height: 1.5;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .nav-tab {
                padding: 10px 12px;
                font-size: 12px;
            }

            .table-header {
                grid-template-columns: minmax(90px, 1fr) minmax(70px, 0.8fr) minmax(60px, 0.7fr) minmax(80px, 0.9fr) minmax(50px, 0.6fr) minmax(70px, 0.8fr) minmax(150px, 1.5fr);
                min-width: 570px;
            }

            .table-row {
                grid-template-columns: minmax(90px, 1fr) minmax(70px, 0.8fr) minmax(60px, 0.7fr) minmax(80px, 0.9fr) minmax(50px, 0.6fr) minmax(70px, 0.8fr) minmax(150px, 1.5fr);
                min-width: 570px;
            }

            .action-btn {
                padding: 6px 8px;
                font-size: 11px;
                min-width: 50px;
                min-height: 30px;
                margin: 1px;
            }
            
            .actions {
                gap: 2px;
                flex-wrap: wrap;
                justify-content: center;
            }

            /* 优化表格单元格显示 */
            .table-cell {
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                min-height: 35px;
                align-items: flex-start;
                flex-wrap: wrap;
                word-break: break-word;
                font-size: 11px;
            }

            /* 优化设备名称显示 */
            .device-name {
                max-width: none;
                white-space: normal;
                word-break: break-word;
                font-size: 11px;
            }

             /* 移动端表格头部文本优化 */
             .header-cell[data-sort="name"]::after {
                 content: " (Name)";
                 display: none;
             }
             
             .header-cell[data-sort="type"]::after {
                 content: " (Type)";
                 display: none;
             }
         }

        .actions {
                gap: 3px;
            }

            .action-btn {
                padding: 4px 6px;
                font-size: 10px;
                min-width: 35px;
            }

            .function-card {
                padding: 15px;
                margin-bottom: 10px;
            }

            .function-card h3 {
                font-size: 16px;
            }

            .function-card p {
                font-size: 13px;
            }

            .function-icon {
                font-size: 36px;
                margin-bottom: 10px;
            }

            .functions-panel {
                padding: 15px;
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4facfe 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            filter: invert(1);
        }

        .navigation-tabs {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            flex: 1;
        }

        .header .navigation-tabs {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: transparent;
            border-radius: 0;
            margin: 0;
            overflow: hidden;
            justify-content: center;
            width: 100%;
        }

        .header .nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border-radius: 6px;
            margin: 0 4px;
            flex: 1;
        }

        .header .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        .header .nav-tab.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff9ff3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transform: translateY(-1px);
        }

        .navigation-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4facfe 100%);
            padding: 0 40px 20px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }

        .navigation-tabs {
            display: flex;
            background: transparent;
            border-radius: 8px;
            margin: 0;
            overflow: hidden;
            justify-content: center;
        }

        .nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border-radius: 6px;
            margin: 0 4px;
            flex: 1;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff9ff3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transform: translateY(-1px);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .connection-status .status-indicator {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-content {
            padding: 30px;
        }

        .navigation-tabs {
            display: flex;
            border-radius: 8px;
            margin: 0 0px 30px 0px;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }

        .nav-tab.active {
            background: #213353;
            color: white;
        }

        /* 可排序表格标题样式 */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .sortable:hover {
            background-color: rgba(255, 107, 107, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .sort-arrow {
            margin-left: 5px;
            font-size: 10px;
            color: #adb5bd;
            transition: all 0.3s ease;
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 6px solid currentColor;
            vertical-align: middle;
            transform-origin: center bottom;
        }

        .sortable[data-direction="asc"] .sort-arrow {
            color: #4facfe;
            transform: rotateX(0deg);
        }

        .sortable[data-direction="desc"] .sort-arrow {
            color: #4facfe;
            transform: rotateX(180deg);
        }

        .color-preview {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 15px;
            vertical-align: middle;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .color-preview:hover {
            transform: scale(1.05);
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .color-preview::after {
            content: '🎨';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .color-preview:hover::after {
            opacity: 0.8;
        }
        
        .color-input-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .color-input-container input[type="color"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }

        .color-input-container input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #495057;
            min-width: 100px;
        }
        
        .button-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .cancel-button {
            background-color: #f1f1f1;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .save-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .cancel-button:hover {
            background-color: #e0e0e0;
        }
        
        .save-button:hover {
            background-color: #45a049;
        }

        .sortable[data-direction="none"] .sort-arrow {
            color: #adb5bd;
            transform: rotateX(0deg);
        }

        .functions-panel {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .functions-panel h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }

        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .function-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .function-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #4F4F4F;
        }

        .function-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .function-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .function-card p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .function-btn {
            background: #4F4F4F;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .function-btn:hover {
            background: #363636;
            transform: translateY(-1px);
        }

        /* 确认弹窗样式 */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .confirmation-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-dialog {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: scale(0.8) translateY(30px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        .confirmation-dialog::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #6f42c1);
            border-radius: 20px 20px 0 0;
        }

        .confirmation-modal.show .confirmation-dialog {
            transform: scale(1) translateY(0);
        }

        .confirmation-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .confirmation-icon {
            font-size: 36px;
            margin-right: 16px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .confirmation-icon.delete {
            color: #dc3545;
        }

        .confirmation-icon.rediscovery {
            color: #ffc107;
        }

        .confirmation-title {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .confirmation-message {
            color: #495057;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 28px;
            font-weight: 400;
        }

        .device-info {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px;
            padding: 18px;
            margin: 18px 0;
            border-left: 4px solid #007bff;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .device-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }

        .device-info-item:last-child {
            margin-bottom: 0;
        }

        .device-info-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .device-info-value {
            color: #2c3e50;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .confirmation-buttons {
            display: flex;
            gap: 14px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        .confirmation-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 100px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .confirmation-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .confirmation-btn:hover::before {
            left: 100%;
        }

        .confirmation-btn.cancel {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .confirmation-btn.cancel:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }

        .confirmation-btn.confirm {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .confirmation-btn.confirm:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
        }

        .confirmation-btn.confirm.rediscovery {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .confirmation-btn.confirm.rediscovery:hover {
            background: linear-gradient(135deg, #e0a800, #d39e00);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #657786;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e1e8ed;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: #4facfe;
            color: #4facfe;
        }

        .filter-btn.active {
            background: #4facfe;
            border-color: #4facfe;
            color: white;
        }

        .devices-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            overflow: hidden;
        }

        .table-header {
            display: grid;
            grid-template-columns: minmax(140px, 1.5fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(120px, 1.2fr) minmax(60px, 0.6fr) minmax(70px, 0.8fr) minmax(160px, 1.8fr);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4facfe 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: gradientShift 6s ease-in-out infinite;
        }

        .header-cell {
            padding: 15px 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white !important;
            word-wrap: break-word;
            overflow: hidden;
        }

        .header-cell:first-child {
            justify-content: flex-start;
            padding-left: 12px;
        }

        .table-row {
            display: grid;
            grid-template-columns: minmax(140px, 1.5fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(120px, 1.2fr) minmax(60px, 0.6fr) minmax(70px, 0.8fr) minmax(160px, 1.8fr);
            border-bottom: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .table-row:hover {
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .table-cell {
            padding: 12px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #2c3e50;
            text-align: center;
            word-wrap: break-word;
            overflow: visible;
            min-height: 40px;
        }

        .table-cell:first-child {
            justify-content: flex-start;
            padding-left: 12px;
        }

        .table-cell .actions {
            width: 100%;
            justify-content: center;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .header-cell {
            padding: 20px;
            font-size: 13px;
        }

        .device-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .device-icon {
            font-size: 18px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-indicator.connected {
            background-color: #2ed573;
        }

        .status-indicator.disconnected {
            background-color: #ff4757;
        }

        .status-text {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            text-transform: uppercase;
        }

        .status-text.online {
            color: #2ed573;
            background-color: rgba(46, 213, 115, 0.1);
        }

        .status-text.offline {
            color: #ff4757;
            background-color: rgba(255, 71, 87, 0.1);
        }

        .auto-discovery {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .auto-discovery.enabled {
            color: #2ed573;
        }

        .auto-discovery.disabled {
            color: #ff4757;
        }

        .actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 50px;
            margin: 1px;
        }

        .action-btn.primary {
            background: #007bff;
            color: white;
        }

        #systemContainer, #actionsContainer {
            display: none;
            padding: 20px;
        }

        .system-card, .action-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .system-card h3, .action-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .restart-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .restart-btn:hover {
            background: #c82333;
        }

        .restart-btn:active {
            background: #bd2130;
        }

        .add-action-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 0;
        }

        .add-action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5em 1em;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            height: auto;
            line-height: 1.2;
            margin: 0 auto;
        }

        .add-action-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .add-action-btn:active {
            background: #004085;
            transform: translateY(0);
        }

        .add-icon {
            font-size: 20px;
            font-weight: bold;
        }

        /* Actions list styles */
        .actions-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
        }

        .action-card {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            width: 250px;
            height: 190px;
            display: flex;
            flex-direction: column;
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .action-card-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .action-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-card-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .action-card-btn.edit {
            background: #28a745;
            color: white;
        }

        .action-card-btn.edit:hover {
            background: #218838;
        }

        .action-card-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-card-btn.execute:hover {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 233, 123, 0.4);
        }

        .action-card-btn.edit:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .action-card-btn.delete:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        /* Action card actions container */
        .action-card-actions {
            padding: 10px 15px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: space-between;
            margin-top: 0;
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        .action-card-btn.execute {
            flex: 1;
            margin-right: 5px;
            background-color: #2F4F4F;
            color: white;
            transition: all 0.3s ease;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .action-card-btn.edit {
            flex: 1;
            margin: 0 5px;
            background-color: #28a745;
            color: white;
            transition: all 0.3s ease;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .action-card-btn.delete {
            flex: 1;
            margin-left: 5px;
            background-color: #dc3545;
            color: white;
            transition: all 0.3s ease;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        /* Action card header styles */
        .action-card-header {
            background: linear-gradient(135deg, #FF6A6A 0%, #FF4757 50%, #FF3742 100%) !important;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 10px 15px;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
            position: relative;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            animation: gradientShift 6s ease-in-out infinite;
        }

        .action-name-left {
            font-weight: bold;
            font-size: 16px;
            color: white !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Device action icons styles */
        .device-action-icon {
            cursor: pointer;
            margin-left: 8px;
            font-size: 18px;
            color: #667eea;
            transition: all 0.3s ease;
            padding: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .device-action-icon:hover {
            transform: scale(1.3);
        }

        .device-action-icon[title="查看"] {
            color: #4facfe;
        }

        .device-action-icon[title="查看"]:hover {
            color: #2196f3;
        }

        .device-action-icon[title="执行"] {
            color: #43e97b;
        }

        .device-action-icon[title="执行"]:hover {
            color: #00c851;
        }

        /* Font Awesome icon specific styles */
        .device-action-icon i {
            font-size: 16px;
            line-height: 1;
        }

        /* Modal styles for Add Action */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
        }

        .close-modal {
            color: #6c757d;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: #dc3545;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #ffffff;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }

        /* Network Configuration Modal Styles */
        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .config-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .form-checkbox {
            width: auto !important;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .config-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .staged-command {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            margin-bottom: 5px;
            font-size: 12px; /* 减小字体大小 */
        }

        .staged-command span {
            font-size: 12px; /* 设备名和命令字体大小 */
            color: #333;
        }

        .staged-command-buttons {
            display: flex;
            gap: 5px;
        }

        .staged-command-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 45px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .staged-command-edit {
            background-color: #17a2b8;
            color: white;
        }

        .staged-command-edit:hover {
            background-color: #138496;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
        }

        .staged-command-delete {
            background-color: #dc3545;
            color: white;
        }

        .staged-command-delete:hover {
            background-color: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .modal-button {
            margin-left: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            background-color: #FF8247;
            color: white;
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .modal-button:hover {
            background-color: #FF6B1A;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 130, 71, 0.3);
        }

        .cancel-button {
            background-color: #f44336;
            color: white;
        }

        .cancel-button:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .modal-footer button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .action-btn.secondary:hover {
            background: #545b62;
        }

        .action-btn.danger {
            background: #dc3545;
            color: white;
        }

        .action-btn.danger:hover {
            background: #c82333;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #657786;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 15px;
        }
    }

    /* 消息提示弹窗样式 */
    #notificationContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 420px;
        pointer-events: none;
    }

    .notification {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 12px;
        opacity: 0;
        transform: translateX(100%) scale(0.95);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: auto;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        position: relative;
    }

    .notification::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 16px 16px 0 0;
    }

    .notification.show {
        opacity: 1;
        transform: translateX(0) scale(1);
    }

    .notification.success::before {
        background: linear-gradient(90deg, #28a745, #20c997);
    }

    .notification.warning::before {
        background: linear-gradient(90deg, #ffc107, #fd7e14);
    }

    .notification.error::before {
        background: linear-gradient(90deg, #dc3545, #e83e8c);
    }

    .notification.info::before {
        background: linear-gradient(90deg, #17a2b8, #6f42c1);
    }

    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        background: rgba(255, 255, 255, 0.5);
    }

    .notification-title {
        display: flex;
        align-items: center;
        font-weight: 600;
        font-size: 15px;
        color: #2c3e50;
        letter-spacing: -0.02em;
    }

    .notification-icon {
        margin-right: 10px;
        font-size: 18px;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
    }

    .notification.success .notification-icon {
        color: #28a745;
    }

    .notification.warning .notification-icon {
        color: #ffc107;
    }

    .notification.error .notification-icon {
        color: #dc3545;
    }

    .notification.info .notification-icon {
        color: #17a2b8;
    }

    .notification-close {
        background: rgba(255, 255, 255, 0.8);
        border: none;
        font-size: 16px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .notification-close:hover {
        background: rgba(248, 249, 250, 0.95);
        color: #495057;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .notification-message {
        padding: 12px 20px 16px;
        color: #495057;
        font-size: 14px;
        line-height: 1.5;
        font-weight: 400;
    }

    .notification-progress {
        height: 4px;
        background: rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
        border-radius: 0 0 16px 16px;
    }

    .notification-progress::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: inherit;
        animation: progressSlide 3s linear forwards;
        border-radius: 0 0 16px 16px;
    }

    @keyframes progressSlide {
        from {
            transform: translateX(0);
        }
        to {
            transform: translateX(-100%);
        }
    }

    .notification.success .notification-progress {
        background: linear-gradient(90deg, rgba(40, 167, 69, 0.3), rgba(32, 201, 151, 0.3));
    }

    .notification.warning .notification-progress {
        background: linear-gradient(90deg, rgba(255, 193, 7, 0.3), rgba(253, 126, 20, 0.3));
    }

    .notification.error .notification-progress {
        background: linear-gradient(90deg, rgba(220, 53, 69, 0.3), rgba(232, 62, 140, 0.3));
    }

    .notification.info .notification-progress {
        background: linear-gradient(90deg, rgba(23, 162, 184, 0.3), rgba(111, 66, 193, 0.3));
    }

    /* 消息提示弹窗样式 - 已删除 */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 8% auto; 
            padding: 35px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            width: 85%; 
            max-width: 600px;
            border-radius: 20px !important;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: scale(0.8) translateY(30px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #6f42c1);
            border-radius: 20px 20px 0 0;
        }

        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .close-button {
            color: #6c757d;
            float: right;
            font-size: 24px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.8);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: -10px -10px 0 0;
        }

        .close-button:hover,
        .close-button:focus {
            color: #495057;
            background: rgba(248, 249, 250, 0.95);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
            cursor: pointer;
        }

        /* Command Examples Styles */
        .command-examples {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .command-examples p {
            margin: 0 0 10px 0;
            font-weight: 600;
            color: #495057;
        }

        .example-section {
            margin-bottom: 15px;
        }

        .example-section:last-child {
            margin-bottom: 0;
        }

        .example-section p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }

        .example-tag {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .example-tag:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .example-tag:active {
            transform: translateY(0);
        }

        /* System Monitor Styles */
        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .info-section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .info-item .label {
            font-weight: 500;
            color: #6c757d;
            flex: 1;
        }

        .info-item .value {
            font-weight: 600;
            color: #495057;
            text-align: right;
            flex: 1;
        }

        .status-online {
            color: #28a745 !important;
        }

        .status-offline {
            color: #dc3545 !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
    </style>
</head>
<body>
    <!-- 消息提示容器 -->
    <div id="notificationContainer"></div>
    
    <div class="container">
        <div class="header">
              <div class="title-container">
                  <img src="logo.svg" alt="logo" class="logo"><h1>Painless Mesh Gateway</h1>
              </div>
              <div class="navigation-tabs">
                <button class="nav-tab active" onclick="switchTab('devices')">Devices</button>
                  <button class="nav-tab" onclick="switchTab('actions')">Actions</button>
                <button class="nav-tab" onclick="switchTab('functions')">Functions</button>
            </div>
        </div>

        <div class="main-content">

            <div class="stats-bar" style="display: none;">
                <div class="stat-item">
                    <div class="stat-number" id="totalDevices">6</div>
                    <div class="stat-label">Total Devices</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="onlineDevices">4</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="offlineDevices">2</div>
                    <div class="stat-label">Offline</div>
                </div>
            </div>

            <div id="devicesContainer">
                <div class="devices-table">
                    <div class="table-header">
                        <div class="table-cell header-cell sortable" data-sort="name">
                            Device Name
                            <span class="sort-arrow" data-direction="none"></span>
                        </div>
                        <div class="table-cell header-cell sortable" data-sort="type">
                            Type
                            <span class="sort-arrow" data-direction="none"></span>
                        </div>
                        <div class="table-cell header-cell">Node ID</div>
                        <div class="table-cell header-cell">MAC Address</div>
                        <div class="table-cell header-cell sortable" data-sort="status">
                            Status
                            <span class="sort-arrow" data-direction="none"></span>
                        </div>
                        <div class="table-cell header-cell sortable" data-sort="discovery">
                            Discovery
                            <span class="sort-arrow" data-direction="none"></span>
                        </div>
                        <div class="table-cell header-cell">Actions</div>
                    </div>
                    
                <!-- Device rows will be dynamically populated here -->
                <div id="loading-message" class="loading-message" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Loading devices from gateway...</span>
                </div>
                <div id="no-devices-message" class="no-devices-message" style="display: none;">
                    <span>No devices found. Make sure the gateway is running and devices are connected.</span>
                </div>
                </div>
            </div>

            <div id="actionsContainer" style="display: none;">
                <div class="actions-panel">
                    <div class="add-action-container">
                        <button class="add-action-btn" onclick="addAction()">
                            <span class="add-icon">+</span>
                            Add Action
                        </button>
                    </div>
                    <div id="actionsList" class="actions-list">
                        <!-- Action cards will be dynamically loaded here -->
                        <div class="loading-message" id="actions-loading">
                            <div class="loading-spinner"></div>
                            <span>Loading actions...</span>
                        </div>
                        <div class="no-actions-message" id="no-actions-message" style="display: none;">
                            <span>No actions found. Create a new action using the Add Action button.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="functionsContainer" style="display: none;">
                <div class="functions-panel">
                    <h2>System Functions</h2>
                    <div class="function-grid">
                        <div class="function-card">
                            <div class="function-icon">🔧</div>
                            <h3>Network Configuration</h3>
                            <p>Configure mesh network settings and parameters</p>
                            <button class="function-btn">Configure</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">📊</div>
                            <h3>System Monitor</h3>
                            <p>Monitor system performance and network statistics</p>
                            <button class="function-btn">Monitor</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">🔄</div>
                            <h3>Firmware Update</h3>
                            <p>Update firmware for connected devices</p>
                            <button class="function-btn">Update</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">📝</div>
                            <h3>System Logs</h3>
                            <p>View and manage system logs and events</p>
                            <button class="function-btn">View Logs</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">⚙️</div>
                            <h3>Device Settings</h3>
                            <p>Configure global device settings and policies</p>
                            <button class="function-btn">Settings</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">🔒</div>
                            <h3>Security</h3>
                            <p>Manage security settings and access control</p>
                            <button class="function-btn">Security</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认弹窗 -->
    <div id="confirmationModal" class="confirmation-modal">
        <div class="confirmation-dialog">
            <div class="confirmation-header">
                <div id="confirmationIcon" class="confirmation-icon">⚠️</div>
                <h3 id="confirmationTitle" class="confirmation-title">Confirm Action</h3>
            </div>
            <div id="confirmationMessage" class="confirmation-message">
                Are you sure you want to perform this action?
            </div>
            <div id="deviceInfo" class="device-info" style="display: none;">
                <div class="device-info-item">
                    <span class="device-info-label">Device Name:</span>
                    <span id="deviceName" class="device-info-value">-</span>
                </div>
                <div class="device-info-item">
                    <span class="device-info-label">Device Type:</span>
                    <span id="confirmationDeviceType" class="device-info-value">-</span>
                </div>
                <div class="device-info-item">
                    <span class="device-info-label">MAC Address:</span>
                    <span id="deviceMac" class="device-info-value">-</span>
                </div>
                <div class="device-info-item">
                    <span class="device-info-label">Status:</span>
                    <span id="deviceStatus" class="device-info-value">-</span>
                </div>
            </div>
            <div class="confirmation-buttons">
                <button id="cancelBtn" class="confirmation-btn cancel">Cancel</button>
                <button id="confirmBtn" class="confirmation-btn confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ===== 调试工具函数 =====
        window.DebugLogger = {
            enabled: true, // 可以通过控制台设置 window.DebugLogger.enabled = false 来关闭调试
            
            logApiRequest: function(url, method, data = null) {
                if (!this.enabled) return;
                console.group(`🔵 API Request: ${method} ${url}`);
                console.log('Timestamp:', new Date().toISOString());
                console.log('URL:', url);
                console.log('Method:', method);
                if (data) {
                    console.log('Request Data:', data);
                }
                console.groupEnd();
            },
            
            logApiResponse: function(url, method, response, data = null) {
                if (!this.enabled) return;
                const status = response.status;
                const statusIcon = status >= 200 && status < 300 ? '✅' : '❌';
                
                console.group(`${statusIcon} API Response: ${method} ${url} (${status})`);
                console.log('Timestamp:', new Date().toISOString());
                console.log('Status:', status, response.statusText);
                console.log('Headers:', Object.fromEntries(response.headers.entries()));
                if (data) {
                    console.log('Response Data:', data);
                    console.log('Data Type:', typeof data);
                    console.log('Data Length:', Array.isArray(data) ? data.length : 
                                              typeof data === 'string' ? data.length : 
                                              typeof data === 'object' ? Object.keys(data).length : 'N/A');
                }
                console.groupEnd();
            },
            
            logApiError: function(url, method, error) {
                if (!this.enabled) return;
                console.group(`🔴 API Error: ${method} ${url}`);
                console.log('Timestamp:', new Date().toISOString());
                console.error('Error:', error);
                console.log('Error Type:', error.constructor.name);
                console.log('Error Message:', error.message);
                if (error.stack) {
                    console.log('Stack Trace:', error.stack);
                }
                console.groupEnd();
            }
        };
        
        // 增强fetch函数，自动添加调试信息
        const originalFetch = window.fetch;
        window.fetch = async function(url, options = {}) {
            const method = options.method || 'GET';
            
            // 记录请求
            window.DebugLogger.logApiRequest(url, method, options.body);
            
            try {
                const response = await originalFetch(url, options);
                
                // 克隆响应以便多次读取
                const responseClone = response.clone();
                
                // 尝试解析响应数据
                let responseData = null;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        responseData = await responseClone.json();
                    } else {
                        responseData = await responseClone.text();
                    }
                } catch (parseError) {
                    console.warn('Failed to parse response data:', parseError);
                }
                
                // 记录响应
                window.DebugLogger.logApiResponse(url, method, response, responseData);
                
                return response;
            } catch (error) {
                // 记录错误
                window.DebugLogger.logApiError(url, method, error);
                throw error;
            }
        };
        
        class DemoDeviceManager {
            constructor() {
            // console.log('DeviceManager: constructor called');
            this.devices = [];
            this.filteredDevices = [];
            this.currentFilter = 'all';
            this.searchTerm = '';
            this.refreshInterval = null;
            this.refreshRate = 5000; // 5秒刷新一次
            this.gatewayUrl = getGatewayUrl(); // Gateway IP from project rules
            this.previousDevices = []; // 用于跟踪设备状态变化
            this.ws = null; // WebSocket连接
            this.isInitialLoad = true; // 标记是否为初始加载
            this.isSilentLoad = false; // 标记是否为静默加载
            this.hasLoadedOnce = false; // 标记是否已经加载过一次
            
            // 添加排序状态保持
            this.currentSortBy = 'name'; // 默认按名称排序
            this.currentSortOrder = 'desc'; // 默认降序（向上箭头表示降序）
            
            this.init();
        }

        init() {
            this.initializeEventListeners();
            this.initializeWebSocket();
            // 不在这里立即加载设备，等WebSocket连接建立后再加载
            this.startAutoRefresh();
        }

        initializeWebSocket() {
            try {
                const wsUrl = getWebSocketUrl();
                console.log('Connecting to WebSocket:', wsUrl);
                
                this.ws = new WebSocket(wsUrl);
                this.setupWebSocketHandlers();
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                this.showErrorMessage(`Failed to connect to gateway at ${this.gatewayUrl}. Please check if the gateway is running and accessible.`);
            }
        }

        setupWebSocketHandlers() {
            this.ws.onopen = () => {
                console.log('WebSocket connected');
                // WebSocket连接建立后立即请求设备列表（静默模式，避免初始通知）
                this.loadDevicesFromGateway(true);
            };

            this.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                }
            };

            this.ws.onclose = () => {
                console.log('WebSocket disconnected');
                // 尝试重连
                setTimeout(() => {
                    this.initializeWebSocket();
                }, 5000);
            };

            this.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        handleWebSocketMessage(data) {
            // console.log('DeviceManager: handleWebSocketMessage received:', data);
            switch (data.type) {
                case 'devices_list':
                    // 处理设备列表更新
                    if (data.devices) {
                        const wasSilent = this.isSilentLoad; // 保存静默状态
                        this.updateDevicesFromWebSocket(data.devices, wasSilent);
                        this.hideLoadingMessage();
                        this.isSilentLoad = false; // 重置静默标记
                    }
                    break;
                case 'device_list':
                    // 处理设备列表更新（兼容旧格式）
                    if (data.devices) {
                        const wasSilent = this.isSilentLoad; // 保存静默状态
                        this.updateDevicesFromWebSocket(data.devices, wasSilent);
                        this.hideLoadingMessage();
                        this.isSilentLoad = false; // 重置静默标记
                    }
                    break;
                case 'device_status':
                    // 处理单个设备状态更新
                    this.handleDeviceStatusUpdate(data);
                    break;
                case 'rediscovery_response':
                    // 处理rediscovery响应
                    this.handleRediscoveryResponse(data);
                    break;
                case 'delete_device_response':
                    // 处理删除设备响应
                    this.handleDeleteDeviceResponse(data);
                    break;
                case 'device_deleted':
                    // 处理设备删除广播消息
                    this.handleDeviceDeleted(data);
                    break;
                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }

        updateDevicesFromWebSocket(devices, silent = false) {
            // console.log(`DeviceManager: updateDevicesFromWebSocket called. Silent: ${silent}, isInitialLoad: ${this.isInitialLoad}, hasLoadedOnce: ${this.hasLoadedOnce}`);
            // 首次加载时，只保存设备状态，不检测变化，不显示通知
            if (!this.hasLoadedOnce) {
                this.hasLoadedOnce = true;
                this.previousDevices = JSON.parse(JSON.stringify(devices));
                this.isInitialLoad = false;
                // 首次加载时不调用detectDeviceChanges，直接跳过通知逻辑
            } else if (!silent) {
                // 非首次加载且非静默模式时才检测设备变化
                this.detectDeviceChanges(devices, false);
            } else {
                // 静默模式下只更新previousDevices，不检测变化
                this.detectDeviceChanges(devices, true);
            }
            
            this.devices = devices.map(device => ({
                name: device.name || 'Unknown Device',
                macAddress: device.macAddress || device.mac || 'Unknown MAC',
                type: device.type || 'Unknown',
                isOnline: device.isOnline || device.online || false,
                nodeId: device.nodeId || 0,
                hasBeenDiscovered: device.hasBeenDiscovered || false,
                lastSeenTimestamp: device.lastSeenTimestamp || 0,
                // 保留原始设备数据以供其他功能使用
                ...device
            }));
            
            // 应用当前的排序设置
            this.sortDevices(this.currentSortBy, this.currentSortOrder);
            
            this.renderDevices();
            this.updateStats();
            
            // console.log('Devices updated from WebSocket:', this.devices.length);
        }

        handleDeviceStatusUpdate(data) {
            // console.log('Handling device status update:', data);
            
            // 在初始加载阶段，不处理设备状态更新通知
            if (!this.hasLoadedOnce || this.isInitialLoad) {
                console.log('Skipping notifications during initial load');
                return;
            }
            
            // 更新特定设备的状态
            const deviceIndex = this.devices.findIndex(d => d.macAddress === data.mac);
            if (deviceIndex !== -1) {
                const oldDevice = JSON.parse(JSON.stringify(this.devices[deviceIndex])); // 保存旧状态
                
                // 更新设备的在线状态
                if (data.hasOwnProperty('online')) {
                    this.devices[deviceIndex].isOnline = data.online;
                }
                
                // 更新设备的discovery状态
                if (data.hasOwnProperty('hasBeenDiscovered')) {
                    this.devices[deviceIndex].hasBeenDiscovered = data.hasBeenDiscovered;
                }
                
                // 根据status字段进行特定处理和通知
                if (data.status === 'online') {
                    this.devices[deviceIndex].isOnline = true;
                    notificationManager.showDeviceOnline(this.devices[deviceIndex].name, data.mac);
                } else if (data.status === 'offline') {
                    this.devices[deviceIndex].isOnline = false;
                    notificationManager.showDeviceOffline(this.devices[deviceIndex].name, data.mac);
                } else if (data.status === 'discovered') {
                    this.devices[deviceIndex].hasBeenDiscovered = true;
                    notificationManager.showAutoDiscoveryEnabled(this.devices[deviceIndex].name, data.mac);
                } else if (data.status === 'rediscovery_initiated') {
                    this.devices[deviceIndex].hasBeenDiscovered = false;
                    notificationManager.showAutoDiscoveryDisabled(this.devices[deviceIndex].name, data.mac);
                } else if (data.status === 'led_status_update') {
                    // 处理LED状态更新
                    if (data.ledConfig) {
                        // console.log('Updating LED config for device:', this.devices[deviceIndex].name, data.ledConfig);
                        // 更新设备的LED配置信息
                        this.devices[deviceIndex].ledConfig = data.ledConfig;
                        
                        // 如果当前正在显示该设备的LED配置模态框，立即更新显示
                        if (currentDeviceMac === data.mac && document.getElementById('ledConfigModal').style.display === 'block') {
                            const onColorValue = rgbToHex(data.ledConfig.onColor);
                            const offColorValue = rgbToHex(data.ledConfig.offColor);
                            
                            document.getElementById('onColor').value = onColorValue;
                            document.getElementById('offColor').value = offColorValue;
                            document.getElementById('onColorPreview').style.backgroundColor = onColorValue;
                            document.getElementById('offColorPreview').style.backgroundColor = offColorValue;
                            
                            document.getElementById('brightness_on').value = data.ledConfig.brightnessOn ?? 255;
                            document.getElementById('brightness_off').value = data.ledConfig.brightnessOff ?? 0;
                            document.getElementById('isDaytime').value = data.ledConfig.isDaytime ? 'Yes' : 'No';
                            document.getElementById('daylightThreshold').value = data.ledConfig.daylightThreshold ?? data.ledConfig.daylightThresholdLx ?? 0;
                            
                            // 更新亮度值显示
                            updateBrightnessValue('brightness_on', 'brightness_on_value');
                            updateBrightnessValue('brightness_off', 'brightness_off_value');
                            
                            // 更新关联传感器选择
                            const linkedSensorSelect = document.getElementById('linkedSensor');
                            if (data.ledConfig.linkedSensor) {
                                linkedSensorSelect.value = data.ledConfig.linkedSensor;
                            }
                        }
                        
                        // 显示LED状态更新通知
                        notificationManager.show(`LED configuration updated for ${this.devices[deviceIndex].name}`, 'info');
                    }
                }
                
                // 应用当前的排序设置
                this.sortDevices(this.currentSortBy, this.currentSortOrder);
                
                this.renderDevices();
            } else {
                // 如果是新设备，可能需要重新加载设备列表
                // console.log('Device not found in current list, may be a new device');
                // 只有在非初始加载且已加载过一次后才显示新设备发现通知
                if (this.hasLoadedOnce && !this.isInitialLoad) {
                    notificationManager.showDeviceDiscovered('New Device', data.mac);
                }
            }
        }

        handleRediscoveryResponse(data) {
            if (data.status === 'success') {
                // 重新发现成功通知已删除
            } else {
                // 重新发现失败通知已删除
            }
        }

        handleDeleteDeviceResponse(data) {
            if (data.status === 'success') {
                // 设备删除成功通知已删除
                // 刷新设备列表
                this.loadDevicesFromGateway(true);
            } else {
                // 设备删除失败通知已删除
            }
        }

        handleDeviceDeleted(data) {
            // 处理设备删除广播消息，从本地列表中移除设备
            const deviceIndex = this.devices.findIndex(d => d.macAddress === data.macAddress);
            if (deviceIndex !== -1) {
                this.devices.splice(deviceIndex, 1);
                this.renderDevices();
                this.updateStats();
                // console.log(`Device ${data.deviceName} removed from local list`);
            }
        }

        sendWebSocketMessage(message) {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify(message));
                return true;
            } else {
                console.error('WebSocket is not connected');
                return false;
            }
        }

        startAutoRefresh() {
            // 清除现有的定时器
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
            }
            
            // 设置新的定时器
            this.refreshInterval = setInterval(() => {
                // 只有在WebSocket连接可用时才加载设备
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.loadDevicesFromGateway(true); // 静默刷新
                }
            }, this.refreshRate);
        }

        stopAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
                this.refreshInterval = null;
            }
        }

            initializeEventListeners() {
                // 移除搜索和过滤功能相关的事件监听器
            }

            async loadDevicesFromGateway(silent = false) {
                // console.log(`DeviceManager: loadDevicesFromGateway called. Silent: ${silent}, isInitialLoad: ${this.isInitialLoad}, hasLoadedOnce: ${this.hasLoadedOnce}`);
                try {
                    if (!silent) {
                        this.showLoadingMessage();
                    }
                    
                    // 设置静默加载标记
                    this.isSilentLoad = silent;
                    
                    // 使用WebSocket请求设备列表
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const message = {
                            type: 'get_devices'
                        };
                        
                        // 发送WebSocket消息请求设备列表
                        this.ws.send(JSON.stringify(message));
                        
                        if (!silent) {
                            // console.log('Device list request sent via WebSocket');
                        }
                    } else {
                        throw new Error('WebSocket connection not available');
                    }
                    
                } catch (error) {
                    console.error('Error loading devices:', error);
                    this.hideLoadingMessage(); // 确保隐藏加载消息
                    if (!silent) {
                        this.showErrorMessage(`Failed to connect to gateway at ${this.gatewayUrl}. Please check if the gateway is running and accessible.`);
                        // 连接错误通知已删除
                    }
                }
            }

            detectDeviceChanges(newDevices, wasSilent = false) {
                // 如果还没有加载过，或者是静默加载，不显示通知
                if (!this.hasLoadedOnce || this.previousDevices.length === 0 || wasSilent) {
                    this.previousDevices = JSON.parse(JSON.stringify(newDevices));
                    return;
                }

                // 创建设备映射以便快速查找
                const previousMap = new Map();
                const newMap = new Map();
                
                this.previousDevices.forEach(device => {
                    // 使用macAddress属性，与渲染保持一致
                    previousMap.set(device.macAddress, device);
                });
                
                newDevices.forEach(device => {
                    // 使用macAddress属性，与渲染保持一致
                    newMap.set(device.macAddress, device);
                });

                // 检测新设备 - 只有在非静默模式且已加载过一次后才显示通知
                if (!wasSilent && this.hasLoadedOnce) {
                    newDevices.forEach(device => {
                        if (!previousMap.has(device.macAddress)) {
                            notificationManager.showDeviceDiscovered(device.name, device.macAddress);
                        }
                    });

                    // 检测设备状态变化
                    this.previousDevices.forEach(prevDevice => {
                        const currentDevice = newMap.get(prevDevice.macAddress);
                        if (currentDevice) {
                            // 检测在线状态变化
                            if (prevDevice.isOnline !== currentDevice.isOnline) {
                                if (currentDevice.isOnline) {
                                    notificationManager.showDeviceOnline(currentDevice.name, currentDevice.macAddress);
                                } else {
                                    notificationManager.showDeviceOffline(currentDevice.name, currentDevice.macAddress);
                                }
                            }

                            // 检测自动发现状态变化
                            if (prevDevice.hasBeenDiscovered !== currentDevice.hasBeenDiscovered) {
                                if (currentDevice.hasBeenDiscovered) {
                                    // 自动发现启用通知已删除
                                } else {
                                    // 自动发现禁用通知已删除
                                }
                            }
                        }
                    });
                }

                // 更新之前的设备状态
                this.previousDevices = JSON.parse(JSON.stringify(newDevices));
            }

            hideLoadingMessage() {
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
            }

            showLoadingMessage() {
                // 不显示加载消息
                return;
            }

            showErrorMessage(message) {
                const container = document.querySelector('.devices-table');
                if (container) {
                    container.innerHTML = `
                        <div class="error-message" style="display: block; margin: 20px; padding: 20px; background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; border-radius: 8px; text-align: center; font-size: 16px;">
                            <div><strong>Error:</strong> ${message}</div>
                        </div>
                    `;
                } else {
                    console.error('Error:', message);
                    // 如果找不到容器，尝试在主容器中显示
                    const mainContainer = document.querySelector('#devicesContainer');
                    if (mainContainer) {
                        mainContainer.innerHTML = `
                            <div class="error-message" style="display: block; margin: 20px; padding: 20px; background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; border-radius: 8px; text-align: center; font-size: 16px;">
                                <div><strong>Error:</strong> ${message}</div>
                            </div>
                        `;
                    }
                }
            }

            getDeviceIcon(type) {
                const icons = {
                    'MultiSwitch': '💡',
                    'EnvSensor': '🌡️',
                    'ServoController': '⚙️',
                    'PIR_Sensor': '👁️',
                    'Contact_Sensor': '🚪'
                };
                return icons[type] || '📱';
            }

            getDeviceActions(type, mac) {
                const actions = [];
                
                // 根据设备类型添加特定的操作按钮
                switch (type) {
                    case 'MultiSwitch':
                    case 'SmartSocket':
                        actions.push(`<button class="action-btn primary configure-btn" data-mac="${mac}">Configure</button>`);
                        break;
                    case 'EnvSensor':
                    case 'PIR_Sensor':
                        // Contact_Sensor 的 Read Data 按钮已删除
                        if (type !== 'Contact_Sensor') {
                            actions.push(`<button class="action-btn primary" onclick="handleDeviceAction('read', '${mac}')">Read Data</button>`);
                        }
                        break;
                    // ServoController 的 Move 按钮已删除
                    case 'ServoController':
                        // 不添加 Move 按钮
                        break;
                }
                
                // 所有设备都有的通用按钮
                actions.push(`<button class="action-btn secondary" onclick="handleDeviceAction('rediscovery', '${mac}')">Rediscovery</button>`);
                actions.push(`<button class="action-btn danger" onclick="handleDeviceAction('delete', '${mac}')">Delete</button>`);
                
                return actions.join('');
            }

            renderDevices() {
                const container = document.querySelector('.devices-table');
                if (!container) {
                    console.error('Devices table container not found');
                    return;
                }
                
                // 隐藏加载消息
                this.hideLoadingMessage();
                
                // Clear existing device rows (but keep header and messages)
                const existingRows = container.querySelectorAll('.table-row:not(.table-header)');
                existingRows.forEach(row => row.remove());

                if (this.devices.length === 0) {
                    const noDevicesMsg = document.getElementById('no-devices-message');
                    if (noDevicesMsg) {
                        noDevicesMsg.style.display = 'block';
                    }
                    return;
                } else {
                    const noDevicesMsg = document.getElementById('no-devices-message');
                    if (noDevicesMsg) {
                        noDevicesMsg.style.display = 'none';
                    }
                }

                this.devices.forEach(device => {
                    const statusClass = device.isOnline ? 'online' : 'offline';
                    const discoveryIcon = device.hasBeenDiscovered ? '✓' : '✗';
                    const discoveryClass = device.hasBeenDiscovered ? 'enabled' : 'disabled';

                    const deviceRow = document.createElement('div');
                    deviceRow.className = `table-row ${statusClass}`;
                    deviceRow.setAttribute('data-type', device.type);
                    deviceRow.setAttribute('data-status', statusClass);
                    deviceRow.setAttribute('data-name', device.name.toLowerCase());
                    deviceRow.setAttribute('data-mac', device.macAddress.toLowerCase());
                    deviceRow.setAttribute('data-nodeid', device.nodeId);
                    deviceRow.setAttribute('data-discovered', device.hasBeenDiscovered);

                    deviceRow.innerHTML = `
                        <div class="table-cell">
                            <div class="device-name">
                                ${device.name}
                            </div>
                        </div>
                        <div class="table-cell">${device.type || 'Unknown'}</div>
                        <div class="table-cell">${device.nodeId}</div>
                        <div class="table-cell">${device.macAddress}</div>
                        <div class="table-cell">
                            <span class="status-indicator ${device.isOnline ? 'connected' : 'disconnected'}"></span>
                        </div>
                        <div class="table-cell">
                            <span class="auto-discovery ${discoveryClass}">${discoveryIcon}</span>
                        </div>
                        <div class="table-cell">
                            <div class="actions">
                                ${this.getDeviceActions(device.type, device.macAddress)}
                            </div>
                        </div>
                    `;

                    container.appendChild(deviceRow);
                });

                this.updateStats();
                
                // 更新全局设备数据，供其他功能使用
                window.devicesData = this.devices;
                
                // 更新表格标题的排序状态显示
                updateHeaderStates();
            }

            updateStats() {
                const totalDevices = this.devices.length;
                const onlineDevices = this.devices.filter(d => d.isOnline).length;
                const offlineDevices = totalDevices - onlineDevices;

                document.getElementById('totalDevices').textContent = totalDevices;
                document.getElementById('onlineDevices').textContent = onlineDevices;
                document.getElementById('offlineDevices').textContent = offlineDevices;
            }
        }

        // Device action handler
        function handleDeviceAction(action, deviceMac) {
            console.log(`Action: ${action} for device: ${deviceMac}`);
            
            switch (action) {
                case 'toggle':
                    // Toggle device functionality
                    break;
                case 'configure':
                    // Open configuration for device
                    break;
                case 'rediscovery':
                    showConfirmationModal('rediscovery', deviceMac);
                    break;
                case 'delete':
                    showConfirmationModal('delete', deviceMac);
                    break;
                case 'read':
                    // Read sensor data from device
                    break;
                case 'move':
                    // Move servo on device
                    break;
                case 'ping':
                    // Attempt to reconnect device
                    break;
                default:
                    console.log(`Unknown action: ${action}`);
            }
        }

        // 显示确认弹窗
        function showConfirmationModal(action, deviceMac) {
            const device = window.deviceManager.devices.find(d => d.macAddress === deviceMac);
            if (!device) {
                // 设备未找到通知已删除
                return;
            }

            const modal = document.getElementById('confirmationModal');
            const icon = document.getElementById('confirmationIcon');
            const title = document.getElementById('confirmationTitle');
            const message = document.getElementById('confirmationMessage');
            const deviceInfo = document.getElementById('deviceInfo');
            const confirmBtn = document.getElementById('confirmBtn');

            // 填充设备信息
            document.getElementById('deviceName').textContent = device.name;
            document.getElementById('deviceType').textContent = device.type;
            document.getElementById('deviceMac').textContent = device.macAddress;
            document.getElementById('deviceStatus').textContent = device.isOnline ? 'Online' : 'Offline';

            if (action === 'delete') {
                icon.textContent = '🗑️';
                icon.className = 'confirmation-icon delete';
                title.textContent = 'Delete Device';
                message.textContent = 'Are you sure you want to delete this device? This action cannot be undone and will remove the device from the system permanently.';
                confirmBtn.textContent = 'Delete';
                confirmBtn.className = 'confirmation-btn confirm';
                confirmBtn.onclick = () => {
                    hideConfirmationModal();
                    handleDeleteDevice(deviceMac);
                };
            } else if (action === 'rediscovery') {
                icon.textContent = '🔄';
                icon.className = 'confirmation-icon rediscovery';
                title.textContent = 'Rediscover Device';
                message.textContent = 'Are you sure you want to initiate rediscovery for this device? This will refresh the device configuration and may temporarily interrupt its operation.';
                confirmBtn.textContent = 'Rediscover';
                confirmBtn.className = 'confirmation-btn confirm rediscovery';
                confirmBtn.onclick = () => {
                    hideConfirmationModal();
                    handleRediscovery(deviceMac);
                };
            }

            deviceInfo.style.display = 'block';
            modal.classList.add('show');

            // 设置取消按钮
            document.getElementById('cancelBtn').onclick = hideConfirmationModal;

            // 点击背景关闭弹窗
            modal.onclick = (e) => {
                if (e.target === modal) {
                    hideConfirmationModal();
                }
            };
        }

        // 隐藏确认弹窗
        function hideConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('show');
        }

        // Handle delete device action
        function handleDeleteDevice(deviceMac) {
            // 根据MAC地址找到设备名称
            const device = window.deviceManager.devices.find(d => d.macAddress === deviceMac);
            if (!device) {
                // 设备未找到通知已删除
                return;
            }

            // 发送WebSocket消息删除设备
            const message = {
                type: 'delete_device',
                deviceName: device.name,
                macAddress: device.macAddress
            };

            if (window.deviceManager.sendWebSocketMessage(message)) {
                // 删除设备进度通知已删除
            } else {
                // WebSocket连接不可用通知已删除
            }
        }

        // Handle rediscovery action
        function handleRediscovery(deviceMac) {
            // 根据MAC地址找到设备名称
            const device = window.deviceManager.devices.find(d => d.macAddress === deviceMac);
            if (!device) {
                // 设备未找到通知已删除
                return;
            }

            // 发送WebSocket消息
            const message = {
                type: 'rediscovery',
                deviceName: device.name
            };

            if (window.deviceManager.sendWebSocketMessage(message)) {
                // 重新发现进度通知已删除
            } else {
                // WebSocket连接不可用通知已删除
            }
        }

        // Initialize the device manager when the page loads
        let currentDeviceMac = null;
        let currentDeviceNodeId = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            function rgbToHex(rgb) {
                if (!rgb || typeof rgb.r === 'undefined') return '#000000';
                return "#" + ((1 << 24) + (rgb.r << 16) + (rgb.g << 8) + rgb.b).toString(16).slice(1).toUpperCase();
            }

            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            // 通知管理器已删除
            
            // 页面卸载时清理定时器
            window.addEventListener('beforeunload', () => {
                if (window.deviceManager) {
                    window.deviceManager.stopAutoRefresh();
                }
            });

            // 页面可见性变化时控制刷新
            document.addEventListener('visibilitychange', () => {
                if (window.deviceManager) {
                    if (document.hidden) {
                        window.deviceManager.stopAutoRefresh();
                    } else {
                        window.deviceManager.startAutoRefresh();
                        // 页面重新可见时立即刷新一次（只有在WebSocket连接可用时）
                        if (window.deviceManager.ws && window.deviceManager.ws.readyState === WebSocket.OPEN) {
                            window.deviceManager.loadDevicesFromGateway(true);
                        }
                    }
                }
            });

            // 初始化设备管理器
            window.deviceManager = new DemoDeviceManager();

            const ledConfigModal = document.getElementById('ledConfigModal');
            const saveButton = document.getElementById('saveLedConfig');
            const cancelButton = document.getElementById('cancelLedConfig');
            const closeButton = document.querySelector('.close-button');

            // 绑定关闭按钮事件
            if (closeButton) {
                closeButton.onclick = function() {
                    closeModal();
                }
            }

            // 更新颜色预览函数
            function updateColorPreview(inputId, previewId) {
                console.log(`updateColorPreview called: inputId=${inputId}, previewId=${previewId}`);
                const colorInput = document.getElementById(inputId);
                const previewElement = document.getElementById(previewId);
                
                if (!colorInput) {
                    console.error(`Color input element not found: ${inputId}`);
                    return;
                }
                
                if (!previewElement) {
                    console.error(`Preview element not found: ${previewId}`);
                    return;
                }
                
                const colorValue = colorInput.value;
                console.log(`Setting color ${colorValue} for preview ${previewId}`);
                previewElement.style.backgroundColor = colorValue;
            }
            
            // 更新亮度值显示
            function updateBrightnessValue(inputId, valueId) {
                const value = document.getElementById(inputId).value;
                document.getElementById(valueId).textContent = `(${value})`;
            }
            
            document.getElementById('brightness_on').addEventListener('input', function() {
                updateBrightnessValue('brightness_on', 'brightness_on_value');
            });
            
            document.getElementById('brightness_off').addEventListener('input', function() {
                updateBrightnessValue('brightness_off', 'brightness_off_value');
            });

            document.querySelector('.devices-table').addEventListener('click', (event) => {
                if (event.target.classList.contains('configure-btn')) {
                    currentDeviceMac = event.target.dataset.mac;
                    const device = window.deviceManager.devices.find(d => d.macAddress === currentDeviceMac);
                    if (device) {
                        currentDeviceNodeId = device.nodeId;
                        const onColorValue = rgbToHex(device.ledConfig?.onColor);
                        const offColorValue = rgbToHex(device.ledConfig?.offColor);
                        
                        document.getElementById('onColor').value = onColorValue;
                        document.getElementById('offColor').value = offColorValue;
                        document.getElementById('onColorPreview').style.backgroundColor = onColorValue;
                        document.getElementById('offColorPreview').style.backgroundColor = offColorValue;
                        
                        document.getElementById('brightness_on').value = device.ledConfig?.brightnessOn ?? device.config?.brightness_on ?? 255;
                        document.getElementById('brightness_off').value = device.ledConfig?.brightnessOff ?? device.config?.brightness_off ?? 0;
                        document.getElementById('isDaytime').value = device.ledConfig?.isDaytime ? 'Yes' : 'No';
                        document.getElementById('daylightThreshold').value = device.ledConfig?.daylightThreshold ?? device.ledConfig?.daylightThresholdLx ?? device.config?.daylightThreshold ?? 0;
                        
                        // 更新亮度值显示
                        updateBrightnessValue('brightness_on', 'brightness_on_value');
                        updateBrightnessValue('brightness_off', 'brightness_off_value');

                        const linkedSensorSelect = document.getElementById('linkedSensor');
                        linkedSensorSelect.innerHTML = ''; // Clear previous options
                        const envSensors = window.deviceManager.devices.filter(d => d.type === 'Env_Sensor');
                        envSensors.forEach(sensor => {
                            const option = document.createElement('option');
                            option.value = sensor.name;
                            option.textContent = sensor.name;
                            if (sensor.name === (device.ledConfig?.linkedSensorName ?? device.config?.linkedSensor ?? device.linkedEnvSensorName)) {
                                option.selected = true;
                            }
                            linkedSensorSelect.appendChild(option);
                        });
                    }
                    // 显示模态框并添加动画效果
                    ledConfigModal.style.display = 'block';
                    setTimeout(() => {
                        ledConfigModal.classList.add('show');
                    }, 10);
                }
            });

            window.onclick = function(event) {
                if (event.target == ledConfigModal) {
                    closeModal();
                }
            }
            
            cancelButton.onclick = function() {
                closeModal();
            }

            // 添加关闭模态框的函数
            function closeModal() {
                ledConfigModal.classList.remove('show');
                setTimeout(() => {
                    ledConfigModal.style.display = 'none';
                }, 400); // 等待动画完成
            }

            saveButton.onclick = function() {
                const message = {
                    type: 'mesh_command',
                    mac: currentDeviceMac,
                    payload: {
                        cmd: 'configLed',
                        to: currentDeviceNodeId,
                        payload: {
                            led_on_color: hexToRgb(document.getElementById('onColor').value),
                            led_off_color: hexToRgb(document.getElementById('offColor').value),
                            brightness_on: parseInt(document.getElementById('brightness_on').value, 10),
                            brightness_off: parseInt(document.getElementById('brightness_off').value, 10),
                            linked_env_sensor_name: document.getElementById('linkedSensor').value,
                            daylight_threshold_lx: parseInt(document.getElementById('daylightThreshold').value, 10)
                        }
                    }
                };

                window.deviceManager.sendWebSocketMessage(message);
                closeModal();
            };

            // 绑定表头点击事件
            const sortableHeaders = document.querySelectorAll('.sortable');
            sortableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const sortBy = header.getAttribute('data-sort');
                    handleHeaderClick(sortBy);
                });
            });
            
            // 初始化表格标题的排序状态
            setTimeout(() => {
                if (window.deviceManager) {
                    updateHeaderStates();
                }
            }, 100);
        });

        // 标签切换功能
        function switchTab(tabName) {
            // 更新标签样式
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // 动态调整导航标签宽度
            updateNavTabWidths();

            // 切换页面内容
            const devicesContainer = document.getElementById('devicesContainer');
            const actionsContainer = document.getElementById('actionsContainer');
            const functionsContainer = document.getElementById('functionsContainer');

            // 隐藏所有容器
            devicesContainer.style.display = 'none';
            actionsContainer.style.display = 'none';
            functionsContainer.style.display = 'none';

            // 显示对应的容器
            if (tabName === 'devices') {
                devicesContainer.style.display = 'block';
            } else if (tabName === 'actions') {
                actionsContainer.style.display = 'block';
                loadActions(); // 加载actions数据
            } else if (tabName === 'functions') {
                functionsContainer.style.display = 'block';
            }
        }

        // 动态调整导航标签宽度的函数
        function updateNavTabWidths() {
            // 使用CSS flex布局自动处理宽度分配，无需JavaScript干预
            console.log('Navigation tabs width updated automatically via CSS flex');
        }

        // 加载Actions数据的函数
        async function loadActions() {
            try {
                // 使用CONFIG中的网关URL
                const gatewayUrl = getGatewayUrl();
                console.log('请求URL:', `${gatewayUrl}/api/actions`);
                
                const response = await fetch(`${gatewayUrl}/api/actions`);
                console.log('响应状态:', response.status);
                console.log('响应头:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // 获取响应文本并打印
                const responseText = await response.text();
                console.log('API响应内容:', responseText);
                console.log('响应长度:', responseText.length);
                console.log('响应类型:', typeof responseText);
                
                // 检查响应是否为空
                if (!responseText || responseText.trim() === '') {
                    console.error('收到空响应');
                    notificationManager.show('收到空响应', 'error');
                    return;
                }
                
                // 如果响应是空数组的文本表示，直接显示空列表
                if (responseText.trim() === '[]') {
                    displayActions([]);
                    return;
                }
                
                // 处理文本格式的响应 (格式: actionName:actionData\nactionName2:actionData2)
                if (responseText.includes(':') && !responseText.startsWith('[') && !responseText.startsWith('{')) {
                    try {
                        // 将文本响应转换为JSON数组
                        const lines = responseText.split('\n');
                        const actions = [];
                        
                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            
                            const [actionName, actionData] = line.split(':', 2);
                            if (actionName && actionData) {
                                try {
                                    // 解析每个action的JSON数据
                                    const actionObj = JSON.parse(actionData);
                                    // 添加action名称
                                    actionObj.name = actionName;
                                    actions.push(actionObj);
                                } catch (parseErr) {
                                    console.error(`解析action数据失败: ${actionName}`, parseErr);
                                }
                            }
                        }
                        
                        console.log('转换后的actions数组:', actions);
                        displayActions(actions);
                        return;
                    } catch (conversionErr) {
                        console.error('转换文本响应失败:', conversionErr);
                    }
                }
                
                // 尝试解析JSON (如果是JSON格式)
                try {
                    if (responseText.trim().startsWith('[') || responseText.trim().startsWith('{')) {
                        console.log('尝试解析JSON响应...');
                        const actions = JSON.parse(responseText);
                        console.log('JSON解析成功，actions数据:', actions);
                        console.log('actions数组长度:', actions.length);
                        displayActions(actions);
                        return;
                    } else {
                        console.log('响应不是JSON格式，跳过JSON解析');
                    }
                } catch (parseError) {
                    console.error('JSON解析错误:', parseError);
                    console.error('解析失败的内容:', responseText);
                }
                
                // 如果所有解析方法都失败，显示原始响应
                document.getElementById('actionsContainer').innerHTML = 
                    `<div class="alert alert-info">收到响应: ${responseText}</div>`;
                notificationManager.show('成功接收到响应，但格式无法解析', 'warning');
            } catch (error) {
                console.error('Error loading actions:', error);
                notificationManager.show('Failed to load actions', 'error');
            }
        }

        // 显示Actions卡片的函数
        function displayActions(actions) {
            const actionsList = document.getElementById('actionsList');
            const loadingElement = document.getElementById('actions-loading');
            const noActionsMessage = document.getElementById('no-actions-message');
            
            // 将actions数据存储到localStorage中，以便后续使用
            localStorage.setItem('actions', JSON.stringify(actions));
            console.log('已将actions数据存储到localStorage:', actions);
            
            // 清除加载状态
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            
            // 清除现有内容
            actionsList.querySelectorAll('.action-card').forEach(card => card.remove());
            
            if (actions.length === 0) {
                if (noActionsMessage) {
                    noActionsMessage.style.display = 'block';
                }
                return;
            }
            
            if (noActionsMessage) {
                noActionsMessage.style.display = 'none';
            }

            actions.forEach(action => {
                const actionCard = document.createElement('div');
                actionCard.className = 'action-card';
                
                // 提取动作信息
                const actionName = action.actionName || action.name || 'Unnamed Action';
                const timestamp = action.timestamp ? new Date(action.timestamp).toLocaleString() : 'Unknown';
                
                // 提取设备和命令信息
                let devicesList = '';
                if (action.payload && action.payload.message && action.payload.message.payload && Array.isArray(action.payload.message.payload)) {
                    devicesList = action.payload.message.payload.map((msg, index) => {
                        const deviceName = msg.name || 'Unknown Device';
                        // 使用actionName作为唯一标识符，因为action.id可能不存在
                        const actionIdentifier = action.name || action.actionName || index;
                        // 只显示设备名称，不显示MAC地址和其他信息
                        return `<div class="action-device-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span class="action-device-name" style="font-size: 12px;">${deviceName}</span>
                            <div class="device-actions">
                                <span class="device-action-icon" title="查看" onclick="showDeviceActionDetails('${actionIdentifier}', ${index})"><i class="fas fa-eye"></i></span>
                                <span class="device-action-icon" title="执行" onclick="executeDeviceAction('${actionIdentifier}', ${index})"><i class="fas fa-play-circle"></i></span>
                            </div>
                        </div>`;
                    }).join('');
                } else if (action.payload && action.payload.message && action.payload.message.cmd) {
                    // 显示命令信息
                    devicesList = `<div class="action-device-item">
                        <span class="action-device-name">Command: ${action.payload.message.cmd}</span>
                    </div>`;
                }
                
                // 计算设备数量
                const deviceCount = action.payload && action.payload.message && 
                                   action.payload.message.payload ? 
                                   action.payload.message.payload.length : 0;
                
                // 确定动作类型并设置对应的色标
                function getActionTypeColor(action) {
                    console.log('分析动作类型:', action);
                    
                    // 检查是否为舵机动作
                    if (action.payload && action.payload.message && action.payload.message.payload) {
                        const devices = action.payload.message.payload;
                        const hasServo = devices.some(device => 
                            device.type === 'ServoController' || 
                            (device.name && device.name.toLowerCase().includes('servo'))
                        );
                        if (hasServo) {
                            console.log('识别为舵机动作');
                            return '#FF6B6B'; // 红色 - 舵机动作
                        }
                    }
                    
                    // 检查是否为开关动作 - 通过states字段识别
                    if (action.payload && action.payload.message && action.payload.message.payload) {
                        const devices = action.payload.message.payload;
                        const hasSwitch = devices.some(device => {
                            // 检查是否有states字段（开关动作的特征）
                            const hasStates = device.states && Array.isArray(device.states);
                            // 检查设备名称是否包含开关相关关键词
                            const nameIndicatesSwitch = device.name && 
                                (device.name.toLowerCase().includes('switch') || 
                                 device.name.toLowerCase().includes('socket') ||
                                 device.name.toLowerCase().includes('light') ||
                                 device.name.toLowerCase().includes('lamp'));
                            // 检查设备类型
                            const typeIndicatesSwitch = device.type === 'MultiSwitch' || device.type === 'SmartSocket';
                            
                            return hasStates || nameIndicatesSwitch || typeIndicatesSwitch;
                        });
                        if (hasSwitch) {
                            console.log('识别为开关动作');
                            return '#4ECDC4'; // 青色 - 开关动作
                        }
                    }
                    
                    // 检查是否为传感器动作
                    if (action.payload && action.payload.message && action.payload.message.payload) {
                        const devices = action.payload.message.payload;
                        const hasSensor = devices.some(device => 
                            device.type === 'EnvSensor' || 
                            device.type === 'PIR_Sensor' || 
                            device.type === 'Contact_Sensor' ||
                            (device.name && device.name.toLowerCase().includes('sensor'))
                        );
                        if (hasSensor) {
                            console.log('识别为传感器动作');
                            return '#45B7D1'; // 蓝色 - 传感器动作
                        }
                    }
                    
                    console.log('未识别动作类型，使用默认颜色');
                    // 默认颜色 - 混合或未知类型
                    return '#95A5A6'; // 灰色
                }
                
                const actionTypeColor = getActionTypeColor(action);
                
                actionCard.innerHTML = `
                    <div class="action-card-header">
                        <div class="action-name-left">${actionName}</div>
                        <div class="action-type-triangle" style="position: absolute; top: 0; right: 0; width: 0; height: 0; border-left: 20px solid transparent; border-top: 20px solid ${actionTypeColor}; border-top-right-radius: inherit;"></div>
                    </div>
                    <div class="action-card-content" style="padding: 10px 15px; flex: 1; overflow: hidden; height: 100px; max-height: 100px;">
                        <div class="action-devices-list" id="devicesList-${action.id}" style="overflow: hidden;" onmouseover="startScroll(this)" onmouseout="stopScroll(this)">
                            ${devicesList || '<div class="no-devices">No devices in this action</div>'}
                        </div>
                    </div>
                    <div class="action-card-actions">
                        <button class="action-card-btn execute" onclick="executeAction('${actionName}')">Execute</button>
                        <button class="action-card-btn edit" onclick="editAction('${actionName}')">Edit</button>
                        <button class="action-card-btn delete" onclick="deleteAction('${actionName}')">Delete</button>
                    </div>
                `;
                actionsList.appendChild(actionCard);
            });
        }

        // 检查是否为舵机动作的辅助函数
        function checkIfServoAction(action) {
            console.log('检查舵机动作:', action);
            
            // 检查设备类型是否为ServoController
            if (action.payload && action.payload.message && action.payload.message.payload) {
                const devices = action.payload.message.payload;
                for (let device of devices) {
                    console.log('检查设备类型:', device.type);
                    if (device.type === 'ServoController') {
                        console.log('识别为舵机动作 - 设备类型匹配');
                        return true;
                    }
                }
            }
            
            // 检查是否包含舵机特有的字段
            if (action.actionType || action.action_type) {
                const actionType = action.actionType || action.action_type;
                console.log('检查动作类型:', actionType);
                if (['sequence', 'back_forth', 'sweep_return', 'repeat'].includes(actionType)) {
                    console.log('识别为舵机动作 - 动作类型匹配');
                    return true;
                }
            }
            
            // 检查是否包含舵机特有的字段如actionName
            if (action.actionName && (action.angles || action.delays || action.repeatCount)) {
                console.log('识别为舵机动作 - 舵机字段匹配');
                return true;
            }
            
            // 检查是否包含PanTiltServo等舵机设备名称
            if (action.payload && action.payload.message && action.payload.message.payload) {
                const devices = action.payload.message.payload;
                for (let device of devices) {
                    if (device.name && device.name.includes('Servo')) {
                        console.log('识别为舵机动作 - 设备名称包含Servo');
                        return true;
                    }
                }
            }
            
            console.log('未识别为舵机动作');
            return false;
        }

        // 编辑Action的函数（暂时只显示提示）
        function editAction(actionName) {
            console.log('Edit action:', actionName);
            
            try {
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                const action = actions.find(a => a.name === actionName || a.actionName === actionName);
                
                if (!action) {
                    console.error('Action not found:', actionName);
                    notificationManager.show('Action data not found', 'error');
                    return;
                }
                
                // Create edit modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.style.opacity = '1';
                
                // Create modal content
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                modalContent.style.width = '80%';
                modalContent.style.maxWidth = '800px';
                modalContent.style.transform = 'scale(1) translateY(0)';
                
                // Create title and header
                const modalHeader = document.createElement('div');
                modalHeader.className = 'modal-header';
                modalHeader.style.display = 'flex';
                modalHeader.style.justifyContent = 'space-between';
                modalHeader.style.alignItems = 'center';
                modalHeader.style.marginBottom = '20px';
                
                const title = document.createElement('h2');
                title.textContent = `Edit Action: ${actionName}`;
                
                const closeButton = document.createElement('span');
                closeButton.innerHTML = '&times;';
                closeButton.className = 'close-modal';
                closeButton.style.cursor = 'pointer';
                closeButton.style.fontSize = '24px';
                closeButton.onclick = function() {
                    document.body.removeChild(modal);
                };
                
                modalHeader.appendChild(title);
                modalHeader.appendChild(closeButton);
                
                // 检查是否为舵机动作卡片
                const isServoAction = checkIfServoAction(action);
                
                // Create tabs (只有非舵机动作才显示Visual Editor)
                const tabContainer = document.createElement('div');
                tabContainer.style.display = 'flex';
                tabContainer.style.marginBottom = '20px';
                tabContainer.style.borderBottom = '1px solid #ccc';
                
                let visualTab, jsonTab;
                
                if (!isServoAction) {
                    // 非舵机动作：显示两个标签页
                    visualTab = document.createElement('div');
                    visualTab.textContent = 'Visual Editor';
                    visualTab.style.padding = '10px 20px';
                    visualTab.style.cursor = 'pointer';
                    visualTab.style.backgroundColor = '#007bff';
                    visualTab.style.color = 'white';
                    visualTab.style.borderTopLeftRadius = '5px';
                    visualTab.style.borderTopRightRadius = '5px';
                    
                    jsonTab = document.createElement('div');
                    jsonTab.textContent = 'JSON Editor';
                    jsonTab.style.padding = '10px 20px';
                    jsonTab.style.cursor = 'pointer';
                    jsonTab.style.backgroundColor = '#f0f0f0';
                    jsonTab.style.borderTopLeftRadius = '5px';
                    jsonTab.style.borderTopRightRadius = '5px';
                    jsonTab.style.marginLeft = '5px';
                    
                    tabContainer.appendChild(visualTab);
                    tabContainer.appendChild(jsonTab);
                } else {
                    // 舵机动作：只显示JSON Editor标签页
                    jsonTab = document.createElement('div');
                    jsonTab.textContent = 'JSON Editor';
                    jsonTab.style.padding = '10px 20px';
                    jsonTab.style.cursor = 'pointer';
                    jsonTab.style.backgroundColor = '#007bff';
                    jsonTab.style.color = 'white';
                    jsonTab.style.borderTopLeftRadius = '5px';
                    jsonTab.style.borderTopRightRadius = '5px';
                    
                    tabContainer.appendChild(jsonTab);
                }
                
                // 创建内容区域
                const contentArea = document.createElement('div');
                contentArea.style.padding = '10px';
                
                // 创建可视化编辑区域
                const visualEditor = document.createElement('div');
                visualEditor.id = 'visual-editor';
                
                // 创建动作名称输入
                // Action Name input removed as requested
                
                // Create device list area
                const devicesContainer = document.createElement('div');
                devicesContainer.style.marginBottom = '20px';
                
                const devicesTitle = document.createElement('h3');
                devicesTitle.textContent = 'Device List';
                devicesTitle.style.marginBottom = '10px';
                
                const devicesList = document.createElement('div');
                devicesList.id = 'devices-list';
                devicesList.style.border = '1px solid #ccc';
                devicesList.style.borderRadius = '4px';
                devicesList.style.padding = '10px';
                devicesList.style.maxHeight = '200px';
                devicesList.style.overflowY = 'auto';
                
                // Extract device list
                const devices = action.payload && action.payload.message && 
                               action.payload.message.payload ? 
                               action.payload.message.payload : [];
                
                // Add devices to list
                devices.forEach((device, index) => {
                    const deviceItem = document.createElement('div');
                    deviceItem.style.padding = '10px';
                    deviceItem.style.marginBottom = '5px';
                    deviceItem.style.backgroundColor = '#f9f9f9';
                    deviceItem.style.borderRadius = '4px';
                    deviceItem.style.display = 'flex';
                    deviceItem.style.justifyContent = 'space-between';
                    deviceItem.style.alignItems = 'center';
                    
                    const deviceInfo = document.createElement('div');
                    deviceInfo.innerHTML = `<strong>${device.name}</strong> (${device.mac})`;
                    
                    const statesContainer = document.createElement('div');
                    statesContainer.style.display = 'flex';
                    statesContainer.style.gap = '5px';
                    
                    // 显示状态
                    if (device.states && device.states.length > 0) {
                        device.states.forEach((state, stateIndex) => {
                            const stateTag = document.createElement('button');
                            stateTag.textContent = state;
                            stateTag.style.padding = '3px 12px';
                            stateTag.style.backgroundColor = '#007bff';
                            stateTag.style.color = 'white';
                            stateTag.style.border = 'none';
                            stateTag.style.borderRadius = '15px';
                            stateTag.style.cursor = 'pointer';
                            stateTag.style.transition = 'all 0.3s ease';
                            stateTag.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                            stateTag.style.marginRight = '5px';
                            stateTag.style.fontSize = '14px';
                            stateTag.style.fontFamily = 'Arial, sans-serif';
                            stateTag.style.minWidth = '60px';
                            stateTag.style.textAlign = 'center';
                            
                            // Add hover effects
                            stateTag.onmouseover = function() {
                                this.style.transform = 'scale(1.1)';
                                this.style.boxShadow = '0 3px 6px rgba(0,0,0,0.2)';
                                this.style.filter = 'brightness(110%)';
                            };
                            
                            stateTag.onmouseout = function() {
                                this.style.transform = 'scale(1)';
                                this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                                this.style.filter = 'brightness(100%)';
                            };
                            stateTag.onclick = function() {
                                // Cycle through states: toggle -> on -> off -> ignore -> toggle
                                const states = ['toggle', 'on', 'off', 'ignore'];
                                const currentState = stateTag.textContent;
                                const currentIndex = states.indexOf(currentState);
                                const nextIndex = (currentIndex + 1) % states.length;
                                const nextState = states[nextIndex];
                                
                                // Update device state data
                                device.states[stateIndex] = nextState;
                                
                                // Update DOM display
                                stateTag.textContent = nextState;
                                
                                // Optional: Update tag style based on state
                                if (nextState === 'on') {
                                    stateTag.style.backgroundColor = '#28a745'; // Green
                                } else if (nextState === 'off') {
                                    stateTag.style.backgroundColor = '#dc3545'; // Red
                                } else if (nextState === 'ignore') {
                                    stateTag.style.backgroundColor = '#6c757d'; // Gray
                                } else {
                                    stateTag.style.backgroundColor = '#007bff'; // Blue (toggle)
                                }
                                
                                console.log(`Device ${device.name} state changed to: ${nextState}`);
                            };
                            statesContainer.appendChild(stateTag);
                        });
                    }
                    
                    deviceItem.appendChild(deviceInfo);
                    deviceItem.appendChild(statesContainer);
                    devicesList.appendChild(deviceItem);
                });
                
                devicesContainer.appendChild(devicesTitle);
                devicesContainer.appendChild(devicesList);
                
                // 添加到可视化编辑器
                visualEditor.appendChild(devicesContainer);
                
                // 创建JSON编辑器
                const jsonEditor = document.createElement('textarea');
                jsonEditor.id = 'action-json-editor';
                jsonEditor.style.width = '100%';
                jsonEditor.style.height = '400px';
                jsonEditor.style.fontFamily = 'monospace';
                jsonEditor.style.fontSize = '14px';
                jsonEditor.style.padding = '10px';
                jsonEditor.style.marginBottom = '20px';
                jsonEditor.style.border = '1px solid #ccc';
                jsonEditor.style.borderRadius = '4px';
                jsonEditor.value = JSON.stringify(action, null, 2);
                
                // 根据是否为舵机动作决定初始显示状态
                if (isServoAction) {
                    jsonEditor.style.display = 'block';
                    visualEditor.style.display = 'none';
                } else {
                    jsonEditor.style.display = 'none';
                    visualEditor.style.display = 'block';
                }
                
                // 添加编辑器到内容区域
                contentArea.appendChild(visualEditor);
                contentArea.appendChild(jsonEditor);
                
                // 添加选项卡切换功能（只有非舵机动作才需要切换功能）
                if (!isServoAction && visualTab) {
                    visualTab.onclick = function() {
                        visualTab.style.backgroundColor = '#007bff';
                        visualTab.style.color = 'white';
                        jsonTab.style.backgroundColor = '#f0f0f0';
                        jsonTab.style.color = 'black';
                        visualEditor.style.display = 'block';
                        jsonEditor.style.display = 'none';
                    };
                }
                
                if (jsonTab) {
                    jsonTab.onclick = function() {
                        jsonTab.style.backgroundColor = '#007bff';
                        jsonTab.style.color = 'white';
                        if (visualTab) {
                            visualTab.style.backgroundColor = '#f0f0f0';
                            visualTab.style.color = 'black';
                        }
                        jsonEditor.style.display = 'block';
                        visualEditor.style.display = 'none';
                        
                        // 从可视化编辑器更新JSON（只有非舵机动作才需要）
                        if (!isServoAction) {
                            const updatedAction = {...action};
                            // 使用原始动作名称，因为输入框已被移除
                            updatedAction.name = action.name || action.actionName;
                    
                            // 更新设备状态
                            const deviceElements = devicesList.children;
                            for (let i = 0; i < deviceElements.length; i++) {
                                const stateTags = deviceElements[i].querySelectorAll('button:not([data-device-index])');
                                const states = Array.from(stateTags).map(tag => tag.textContent);
                                if (updatedAction.payload && updatedAction.payload.message && 
                                    updatedAction.payload.message.payload && updatedAction.payload.message.payload[i]) {
                                    updatedAction.payload.message.payload[i].states = states;
                                }
                            }
                    
                            jsonEditor.value = JSON.stringify(updatedAction, null, 2);
                        }
                    };
                }
                
                // 创建按钮容器
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.justifyContent = 'flex-end';
                buttonContainer.style.gap = '10px';
                buttonContainer.style.marginTop = '20px';
                
                // Create save button
                const saveButton = document.createElement('button');
                saveButton.textContent = 'Save';
                saveButton.style.padding = '8px 16px';
                saveButton.style.backgroundColor = '#007bff';
                saveButton.style.color = 'white';
                saveButton.style.border = 'none';
                saveButton.style.borderRadius = '4px';
                saveButton.style.cursor = 'pointer';
                saveButton.onclick = function() {
                    try {
                        let updatedAction;
                        
                        // 根据当前激活的编辑器获取数据
                        if (jsonEditor.style.display === 'none') {
                            // 从可视化编辑器获取数据
                            updatedAction = {...action};
                            // 使用原始动作名称，因为输入框已被移除
                            updatedAction.name = action.name || action.actionName;
                            
                            // 更新设备状态
                            const deviceElements = devicesList.children;
                            for (let i = 0; i < deviceElements.length; i++) {
                                const stateTags = deviceElements[i].querySelectorAll('button:not([data-device-index])');
                                const states = Array.from(stateTags).map(tag => tag.textContent);
                                console.log(`设备 ${i} 状态:`, states);
                                
                                // 确保设备状态数组不为空
                                if (states.length === 0) {
                                    // 如果没有找到状态按钮，保留原始状态
                                    if (updatedAction.payload && updatedAction.payload.message && 
                                        updatedAction.payload.message.payload && updatedAction.payload.message.payload[i] &&
                                        updatedAction.payload.message.payload[i].states) {
                                        console.log(`保留设备 ${i} 的原始状态:`, updatedAction.payload.message.payload[i].states);
                                    }
                                } else {
                                    // 只有在找到状态按钮时才更新状态
                                    if (updatedAction.payload && updatedAction.payload.message && 
                                        updatedAction.payload.message.payload && updatedAction.payload.message.payload[i]) {
                                        updatedAction.payload.message.payload[i].states = states;
                                        console.log(`更新设备 ${i} 状态为:`, states);
                                    }
                                }
                            }
                        } else {
                            // 从JSON编辑器获取数据
                            updatedAction = JSON.parse(jsonEditor.value);
                        }
                        
                        // 更新localStorage中的动作
                        const actions = JSON.parse(localStorage.getItem('actions')) || [];
                        const actionIndex = actions.findIndex(a => a.name === actionName || a.actionName === actionName);
                        if (actionIndex !== -1) {
                            actions[actionIndex] = updatedAction;
                            localStorage.setItem('actions', JSON.stringify(actions));
                            
                            // 构建WebSocket消息通知网关
                            try {
                                // 提取动作中的设备数据
                                const devices = updatedAction.payload && updatedAction.payload.message && 
                                               updatedAction.payload.message.payload ? 
                                               updatedAction.payload.message.payload : [];
                                
                                // 构建保存动作的WebSocket消息
                                const saveActionMessage = {
                                    command: "saveAction",
                                    payload: {
                                        isBroadcast: true,
                                        message: {
                                            cmd: "groupState",
                                            payload: devices
                                        }
                                    },
                                    actionName: updatedAction.name || updatedAction.actionName
                                };
                                
                                console.log('发送保存动作消息:', saveActionMessage);
                                
                                // 发送WebSocket消息
                                if (window.deviceManager && window.deviceManager.sendWebSocketMessage) {
                                    window.deviceManager.sendWebSocketMessage(saveActionMessage);
                                    console.log('已发送保存动作消息');
                                } else {
                                    console.error('deviceManager或sendWebSocketMessage不可用');
                                }
                            } catch (wsError) {
                                console.error('发送WebSocket消息时出错:', wsError);
                                notificationManager.show(`动作已保存到本地，但同步到网关失败: ${wsError.message}`, 'warning');
                            }
                            
                            // 刷新动作列表
                            loadActions();
                            
                            // 关闭模态框
                            document.body.removeChild(modal);
                            
                            notificationManager.show(`动作 "${actionName}" 已更新`, 'success');
                        }
                    } catch (error) {
                        console.error('保存动作时出错:', error);
                        notificationManager.show(`保存失败: ${error.message}`, 'error');
                    }
                };
                
                // Create cancel button
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.style.padding = '8px 16px';
                cancelButton.style.backgroundColor = '#6c757d';
                cancelButton.style.color = 'white';
                cancelButton.style.border = 'none';
                cancelButton.style.borderRadius = '4px';
                cancelButton.style.cursor = 'pointer';
                cancelButton.style.marginRight = '10px';
                cancelButton.onclick = function() {
                    document.body.removeChild(modal);
                };
                
                // 添加按钮到容器
                buttonContainer.appendChild(cancelButton);
                buttonContainer.appendChild(saveButton);
                
                // 组装模态框
                modalContent.appendChild(modalHeader);
                modalContent.appendChild(tabContainer);
                modalContent.appendChild(contentArea);
                modalContent.appendChild(buttonContainer);
                modal.appendChild(modalContent);
                
                // 添加到页面
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('编辑动作时出错:', error);
                notificationManager.show(`编辑失败: ${error.message}`, 'error');
            }
        }

        // 执行Action的函数
        function executeAction(actionName) {
            console.log('执行动作:', actionName);
            
            try {
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                const action = actions.find(a => a.name === actionName || a.actionName === actionName);
                
                if (!action) {
                    console.error('未找到对应的action:', actionName);
                    notificationManager.show('未找到对应的动作数据', 'error');
                    return;
                }
                
                // 构建WebSocket消息
                const message = {
                    command: "sendMessage",
                    payload: {
                        isBroadcast: true,
                        message: {
                            cmd: "groupState",
                            payload: action.payload?.message?.payload || []
                        }
                    }
                };
                
                console.log('发送WebSocket消息:', message);
                
                // 显示执行中状态
                notificationManager.show(`正在执行动作: ${actionName}...`, 'info');
                
                // 通过WebSocket发送消息
                if (window.deviceManager && window.deviceManager.sendWebSocketMessage(message)) {
                    notificationManager.show(`动作 "${actionName}" 执行成功`, 'success');
                } else {
                    throw new Error('WebSocket未连接或发送失败');
                }
            } catch (error) {
                console.error('执行动作时出错:', error);
                notificationManager.show(`执行动作失败: ${error.message}`, 'error');
            }
        }

        // 删除Action的函数
        function deleteAction(actionName) {
            // 使用自定义确认弹窗
            const modal = document.getElementById('confirmationModal');
            const confirmationIcon = document.getElementById('confirmationIcon');
            const confirmationTitle = document.getElementById('confirmationTitle');
            const confirmationMessage = document.getElementById('confirmationMessage');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const deviceInfo = document.getElementById('deviceInfo');
            
            // 设置弹窗内容
            confirmationIcon.className = 'confirmation-icon delete';
            confirmationIcon.innerHTML = '🗑️';
            confirmationTitle.textContent = '删除动作';
            confirmationMessage.textContent = `确定要删除动作 "${actionName}" 吗？`;
            confirmBtn.textContent = '删除';
            confirmBtn.className = 'confirmation-btn confirm';
            deviceInfo.style.display = 'none';
            
            // 显示弹窗
            modal.classList.add('show');
            
            // 确认按钮点击事件
            confirmBtn.onclick = function() {
                // 从localStorage中删除
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                const updatedActions = actions.filter(action => (action.name || action.actionName) !== actionName);
                localStorage.setItem('actions', JSON.stringify(updatedActions));
                
                // 发送WebSocket消息到网关删除NVS中的动作
                const deleteMessage = {
                    command: "deleteAction",
                    actionName: actionName
                };
                
                if (window.deviceManager && window.deviceManager.sendWebSocketMessage) {
                    if (window.deviceManager.sendWebSocketMessage(deleteMessage)) {
                        console.log('发送删除动作消息:', deleteMessage);
                        notificationManager.show(`正在删除动作: ${actionName}`, 'info');
                    } else {
                        console.error('发送删除消息失败');
                        notificationManager.show('发送删除消息失败', 'error');
                    }
                } else {
                    console.error('deviceManager或sendWebSocketMessage不可用');
                    notificationManager.show('WebSocket未连接，无法删除网关中的动作', 'error');
                }
                
                // 刷新动作列表
                loadActions();
                notificationManager.show(`动作已删除: ${actionName}`, 'success');
                
                // 隐藏弹窗
                modal.classList.remove('show');
            };
            
            // 取消按钮点击事件
            cancelBtn.onclick = function() {
                modal.classList.remove('show');
            };
            
            // 阻止默认行为
            return false;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, navigation tabs initialized');
            
            // 初始化System Monitor按钮点击事件
            initSystemMonitor();
        });

        // System Monitor功能初始化
        function initSystemMonitor() {
            // 查找System Monitor按钮
            const functionCards = document.querySelectorAll('.function-card');
            let systemMonitorBtn = null;
            
            functionCards.forEach(card => {
                const title = card.querySelector('h3');
                if (title && title.textContent.trim() === 'System Monitor') {
                    systemMonitorBtn = card.querySelector('.function-btn');
                }
            });
            
            if (systemMonitorBtn) {
                systemMonitorBtn.addEventListener('click', showSystemMonitor);
            }
            
            // 绑定Firmware Update按钮事件
            let firmwareUpdateBtn = null;
            
            functionCards.forEach(card => {
                const title = card.querySelector('h3');
                if (title && title.textContent.trim() === 'Firmware Update') {
                    firmwareUpdateBtn = card.querySelector('.function-btn');
                }
            });
            
            if (firmwareUpdateBtn) {
                firmwareUpdateBtn.addEventListener('click', showOTAUpgrade);
            }
            
            // 绑定Network Configuration按钮事件
            let networkConfigBtn = null;
            
            functionCards.forEach(card => {
                const title = card.querySelector('h3');
                if (title && title.textContent.trim() === 'Network Configuration') {
                    networkConfigBtn = card.querySelector('.function-btn');
                }
            });
            
            if (networkConfigBtn) {
                networkConfigBtn.addEventListener('click', showNetworkConfig);
            }
        }

        // 显示系统监控信息
        async function showSystemMonitor() {
            console.log('System Monitor button clicked');
            try {
                console.log('Fetching system monitor data...');
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/system_monitor`);
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Response text:', text);
                
                if (!text || text.trim() === '' || text === '{}') {
                    throw new Error('Empty response from server');
                }
                
                const data = JSON.parse(text);
                console.log('Parsed data:', data);
                displaySystemMonitorModal(data);
            } catch (error) {
                console.error('Failed to fetch system monitor data:', error);
                alert('Failed to load system information: ' + error.message);
                if (window.notificationManager) {
                    window.notificationManager.show('Failed to load system information: ' + error.message, 'error');
                }
            }
        }

        // 显示系统监控模态框
        function displaySystemMonitorModal(data) {
            const modalHtml = `
                <div id="systemMonitorModal" class="modal" onclick="closeSystemMonitorModal()">
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh; border-radius: 20px; overflow: hidden;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>System Monitor</h2>
                        </div>
                        <div class="modal-body" style="max-height: calc(80vh - 120px); overflow-y: auto; padding-right: 10px;">
                            <div class="system-info-grid">
                                <div class="info-section">
                                    <h3>System Information</h3>
                                    <div class="info-item">
                                        <span class="label">Uptime:</span>
                                        <span class="value">${data.system?.uptime || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Chip Model:</span>
                                        <span class="value">${data.system?.chipModel || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">CPU Frequency:</span>
                                        <span class="value">${data.system?.cpuFreqMHz || 'N/A'} MHz</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Flash Size:</span>
                                        <span class="value">${formatBytes(data.system?.flashChipSize || 0)}</span>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>Memory Usage</h3>
                                    <div class="info-item">
                                        <span class="label">Total Heap:</span>
                                        <span class="value">${formatBytes(data.memory?.totalHeap || 0)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Free Heap:</span>
                                        <span class="value">${formatBytes(data.memory?.freeHeap || 0)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Used Heap:</span>
                                        <span class="value">${formatBytes(data.memory?.usedHeap || 0)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Usage:</span>
                                        <span class="value">${data.memory?.usagePercent || 0}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${data.memory?.usagePercent || 0}%"></div>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>Network Status</h3>
                                    <div class="info-item">
                                        <span class="label">Type:</span>
                                        <span class="value">${data.network?.type || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">IP Address:</span>
                                        <span class="value">${data.network?.ipAddress || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">MAC Address:</span>
                                        <span class="value">${data.network?.macAddress || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Link Status:</span>
                                        <span class="value ${data.network?.linkUp ? 'status-online' : 'status-offline'}">
                                            ${data.network?.linkUp ? 'Up' : 'Down'}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Link Speed:</span>
                                        <span class="value">${data.network?.linkSpeed || 'N/A'} Mbps</span>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>MQTT Status</h3>
                                    <div class="info-item">
                                        <span class="label">Connection:</span>
                                        <span class="value ${data.mqtt?.connected ? 'status-online' : 'status-offline'}">
                                            ${data.mqtt?.connected ? 'Connected' : 'Disconnected'}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Server:</span>
                                        <span class="value">${data.mqtt?.server || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Port:</span>
                                        <span class="value">${data.mqtt?.port || 'N/A'}</span>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>Mesh Network</h3>
                                    <div class="info-item">
                                        <span class="label">Connected Devices:</span>
                                        <span class="value">${data.mesh?.connectedDevices || 0}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Online Devices:</span>
                                        <span class="value">${data.mesh?.onlineDevices || 0}</span>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>Storage (NVS)</h3>
                                    <div class="info-item">
                                        <span class="label">Total Entries:</span>
                                        <span class="value">${data.nvs?.totalEntries || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Used Entries:</span>
                                        <span class="value">${data.nvs?.usedEntries || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Usage:</span>
                                        <span class="value">${data.nvs?.usagePercent || 0}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${data.nvs?.usagePercent || 0}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-actions" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                                <button onclick="refreshSystemMonitor()" class="btn btn-primary">Refresh</button>
                                <button onclick="rebootGateway()" class="btn btn-warning">Reboot Gateway</button>
                                <button onclick="clearNVS()" class="btn btn-danger">Clear NVS</button>
                                <button onclick="closeSystemMonitorModal()" class="btn btn-secondary">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            const existingModal = document.getElementById('systemMonitorModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加新的模态框
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = document.getElementById('systemMonitorModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // 关闭系统监控模态框
        function closeSystemMonitorModal() {
            const modal = document.getElementById('systemMonitorModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // 刷新系统监控信息
        function refreshSystemMonitor() {
            showSystemMonitor();
        }

        // 重启网关
        async function rebootGateway() {
            const confirmed = await confirmDialog.show(
                'Reboot Gateway',
                'Are you sure you want to reboot the gateway? This will temporarily disconnect all devices and may take up to 30 seconds to complete.',
                'Reboot Now',
                'Cancel',
                'warning'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/reboot`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    notificationManager.show('Gateway is rebooting...', 'info');
                    closeSystemMonitorModal();
                    // 等待一段时间后尝试重新连接
                    setTimeout(() => {
                        location.reload();
                    }, 10000);
                } else {
                    notificationManager.show('Failed to reboot gateway', 'error');
                }
            } catch (error) {
                console.error('Error rebooting gateway:', error);
                notificationManager.show('Error rebooting gateway', 'error');
            }
        }

        // 清除NVS存储
        async function clearNVS() {
            const confirmed = await confirmDialog.show(
                'Clear NVS Storage',
                'Are you sure you want to clear NVS storage? This will permanently delete all saved configurations including WiFi settings, device configurations, and actions. The gateway will reboot automatically after clearing.',
                'Clear & Reboot',
                'Cancel',
                'danger'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/clear_nvs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    notificationManager.show('NVS cleared. Gateway is rebooting...', 'info');
                    closeSystemMonitorModal();
                    // 等待一段时间后尝试重新连接
                    setTimeout(() => {
                        location.reload();
                    }, 15000);
                } else {
                    notificationManager.show('Failed to clear NVS', 'error');
                }
            } catch (error) {
                console.error('Error clearing NVS:', error);
                notificationManager.show('Error clearing NVS', 'error');
            }
        }

        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 自定义确认弹窗
        class ConfirmDialog {
            constructor() {
                this.isOpen = false;
            }

            show(title, message, confirmText = 'Confirm', cancelText = 'Cancel', type = 'warning') {
                return new Promise((resolve) => {
                    if (this.isOpen) {
                        resolve(false);
                        return;
                    }

                    this.isOpen = true;
                    const overlay = document.createElement('div');
                    overlay.className = 'confirm-overlay';
                    
                    const dialog = document.createElement('div');
                    dialog.className = `confirm-dialog ${type}`;
                    
                    const icon = this.getIcon(type);
                    
                    dialog.innerHTML = `
                        <div class="confirm-header">
                            <div class="confirm-icon">${icon}</div>
                            <h3 class="confirm-title">${title}</h3>
                        </div>
                        <div class="confirm-body">
                            <p class="confirm-message">${message}</p>
                        </div>
                        <div class="confirm-footer">
                            <button class="btn btn-secondary confirm-cancel">${cancelText}</button>
                            <button class="btn ${this.getButtonClass(type)} confirm-ok">${confirmText}</button>
                        </div>
                    `;

                    overlay.appendChild(dialog);
                    document.body.appendChild(overlay);

                    // 添加动画效果
                    setTimeout(() => {
                        overlay.classList.add('show');
                        dialog.classList.add('show');
                    }, 10);

                    // 绑定事件
                    const cancelBtn = dialog.querySelector('.confirm-cancel');
                    const okBtn = dialog.querySelector('.confirm-ok');

                    const cleanup = () => {
                        this.isOpen = false;
                        overlay.classList.remove('show');
                        dialog.classList.remove('show');
                        setTimeout(() => {
                            if (overlay.parentNode) {
                                overlay.parentNode.removeChild(overlay);
                            }
                        }, 300);
                    };

                    cancelBtn.onclick = () => {
                        cleanup();
                        resolve(false);
                    };

                    okBtn.onclick = () => {
                        cleanup();
                        resolve(true);
                    };

                    // ESC键关闭
                    const handleKeydown = (e) => {
                        if (e.key === 'Escape') {
                            cleanup();
                            resolve(false);
                            document.removeEventListener('keydown', handleKeydown);
                        }
                    };
                    document.addEventListener('keydown', handleKeydown);

                    // 点击遮罩关闭
                    overlay.onclick = (e) => {
                        if (e.target === overlay) {
                            cleanup();
                            resolve(false);
                        }
                    };
                });
            }

            getIcon(type) {
                const icons = {
                    warning: '⚠️',
                    danger: '🚨',
                    info: 'ℹ️',
                    success: '✅'
                };
                return icons[type] || icons.warning;
            }

            getButtonClass(type) {
                const classes = {
                    warning: 'btn-warning',
                    danger: 'btn-danger',
                    info: 'btn-primary',
                    success: 'btn-success'
                };
                return classes[type] || 'btn-warning';
            }
        }

        // 创建全局确认弹窗实例
        const confirmDialog = new ConfirmDialog();

        // 消息提示系统
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationContainer');
                this.notifications = [];
                this.notificationId = 0;
            }

            show(message, type = 'info', duration = 5000) {
                const notification = this.createNotification(message, type, duration);
                this.container.appendChild(notification);
                this.notifications.push(notification);

                // 触发显示动画
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);

                // 自动隐藏
                if (duration > 0) {
                    this.startProgressBar(notification, duration);
                    setTimeout(() => {
                        this.hide(notification);
                    }, duration);
                }

                return notification;
            }

            createNotification(message, type, duration) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.dataset.id = ++this.notificationId;

                const icon = this.getIcon(type);
                const title = this.getTitle(type);

                notification.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">
                            <span class="notification-icon">${icon}</span>
                            ${title}
                        </div>
                        <button class="notification-close" onclick="notificationManager.hide(this.closest('.notification'))">&times;</button>
                    </div>
                    <div class="notification-message">${message}</div>
                    ${duration > 0 ? '<div class="notification-progress" style="width: 100%"></div>' : ''}
                `;

                return notification;
            }

            getIcon(type) {
                const icons = {
                    success: '✓',
                    warning: '⚠',
                    error: '✕',
                    info: 'ℹ'
                };
                return icons[type] || icons.info;
            }

            getTitle(type) {
                const titles = {
                    success: 'Success',
                    warning: 'Warning',
                    error: 'Error',
                    info: 'Information'
                };
                return titles[type] || titles.info;
            }

            startProgressBar(notification, duration) {
                const progressBar = notification.querySelector('.notification-progress');
                if (progressBar) {
                    progressBar.style.transition = `width ${duration}ms linear`;
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                    }, 10);
                }
            }

            hide(notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                        this.notifications = this.notifications.filter(n => n !== notification);
                    }
                }, 300);
            }

            showDeviceOnline(deviceName, deviceMac) {
                console.log('=== showDeviceOnline called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', new Error().stack);
                console.log('===================================');
                
                this.show(`Device "${deviceName}" is now online`, 'success');
            }

            showDeviceOffline(deviceName, deviceMac) {
                console.log('=== showDeviceOffline called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', new Error().stack);
                console.log('====================================');
                
                this.show(`Device "${deviceName}" went offline`, 'warning');
            }

            showAutoDiscoveryEnabled(deviceName, deviceMac) {
                console.log('=== showAutoDiscoveryEnabled called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', new Error().stack);
                console.log('========================================');
                
                this.show(`Auto-discovery enabled for device "${deviceName}"`, 'info');
            }

            showAutoDiscoveryDisabled(deviceName, deviceMac) {
                console.log('=== showAutoDiscoveryDisabled called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', new Error().stack);
                console.log('=========================================');
                
                this.show(`Auto-discovery disabled for device "${deviceName}"`, 'info');
            }

            showDeviceDiscovered(deviceName, deviceMac) {
                // 获取调用栈信息
                const stack = new Error().stack;
                console.log('=== showDeviceDiscovered called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', stack);
                console.log('=====================================');
                
                this.show(`New device discovered: "${deviceName}"`, 'success');
            }

            clear() {
                this.notifications.forEach(notification => {
                    this.hide(notification);
                });
            }
        }

        // 全局消息提示管理器
        let notificationManager;

        // 表格标题排序功能
        function handleHeaderClick(sortBy) {
            if (!window.deviceManager || !window.deviceManager.devices) {
                return;
            }
            
            // 如果点击的是当前排序列，则切换排序方向
            if (window.deviceManager.currentSortBy === sortBy) {
                window.deviceManager.currentSortOrder = 
                    window.deviceManager.currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // 如果点击的是新列，则设置为降序（向上箭头表示降序）
                window.deviceManager.currentSortBy = sortBy;
                window.deviceManager.currentSortOrder = 'desc';
            }
            
            // 更新所有表格标题的视觉状态
            updateHeaderStates();
            
            // 执行排序并重新渲染
            window.deviceManager.sortDevices(
                window.deviceManager.currentSortBy, 
                window.deviceManager.currentSortOrder
            );
            window.deviceManager.renderDevices();
        }

        // 更新表格标题的视觉状态
        function updateHeaderStates() {
            const headers = document.querySelectorAll('.sortable');
            headers.forEach(header => {
                const sortBy = header.getAttribute('data-sort');
                if (sortBy === window.deviceManager.currentSortBy) {
                    header.setAttribute('data-direction', window.deviceManager.currentSortOrder);
                } else {
                    header.setAttribute('data-direction', 'none');
                }
            });
        }

        // 在DemoDeviceManager类中添加排序方法
        DemoDeviceManager.prototype.sortDevices = function(sortBy, sortOrder) {
            this.devices.sort((a, b) => {
                let valueA, valueB;
                
                switch (sortBy) {
                    case 'name':
                        valueA = a.name.toLowerCase();
                        valueB = b.name.toLowerCase();
                        break;
                    case 'type':
                        valueA = (a.type || 'Unknown').toLowerCase();
                        valueB = (b.type || 'Unknown').toLowerCase();
                        break;
                    case 'status':
                        valueA = a.isOnline ? 1 : 0;
                        valueB = b.isOnline ? 1 : 0;
                        break;
                    case 'discovery':
                        valueA = a.hasBeenDiscovered ? 1 : 0;
                        valueB = b.hasBeenDiscovered ? 1 : 0;
                        break;
                    default:
                        return 0;
                }
                
                let comparison = 0;
                if (valueA > valueB) {
                    comparison = 1;
                } else if (valueA < valueB) {
                    comparison = -1;
                }
                
                return sortOrder === 'desc' ? -comparison : comparison;
            });
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 添加页面加载调试信息
            console.log('DOM Content Loaded');
            console.log('Coloris available:', typeof Coloris !== 'undefined');
            
            // 初始化通知管理器
            notificationManager = new NotificationManager();

            // 延迟初始化颜色选择器，等待可能的备用CDN加载
            setTimeout(() => {
                initializeColorPicker();
            }, 500);
        });
        
        function initializeColorPicker() {
            console.log('Initializing color picker...');
            
            // 设置颜色预览块的点击事件
            const onColorPreview = document.getElementById('onColorPreview');
            const offColorPreview = document.getElementById('offColorPreview');
            const onColorInput = document.getElementById('onColor');
            const offColorInput = document.getElementById('offColor');
            const onColorText = document.getElementById('onColorText');
            const offColorText = document.getElementById('offColorText');
            
            if (onColorPreview && onColorInput && onColorText) {
                onColorPreview.addEventListener('click', function() {
                    console.log('On color preview clicked');
                    onColorInput.click();
                });
                
                onColorInput.addEventListener('change', function() {
                    const color = this.value;
                    console.log('On color changed to:', color);
                    onColorPreview.style.backgroundColor = color;
                    onColorText.value = color.toUpperCase();
                });
                
                // 设置默认颜色
                const defaultOnColor = '#FFFF00';
                onColorInput.value = defaultOnColor;
                onColorPreview.style.backgroundColor = defaultOnColor;
                onColorText.value = defaultOnColor;
            }
            
            if (offColorPreview && offColorInput && offColorText) {
                offColorPreview.addEventListener('click', function() {
                    console.log('Off color preview clicked');
                    offColorInput.click();
                });
                
                offColorInput.addEventListener('change', function() {
                    const color = this.value;
                    console.log('Off color changed to:', color);
                    offColorPreview.style.backgroundColor = color;
                    offColorText.value = color.toUpperCase();
                });
                
                // 设置默认颜色
                const defaultOffColor = '#FF0000';
                offColorInput.value = defaultOffColor;
                offColorPreview.style.backgroundColor = defaultOffColor;
                offColorText.value = defaultOffColor;
            }
            
            console.log('Color picker initialized successfully');
        }
        
        // 添加动作函数
        function addAction() {
            openAddActionModal();
        }

        // 打开Add Action弹窗
        function openAddActionModal() {
            console.log('=== openAddActionModal called ===');
            const modal = document.getElementById('addActionModal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // 添加设备类型下拉列表的事件监听器
            const deviceTypeSelect = document.getElementById('deviceType');
            const deviceSelect = document.getElementById('deviceSelect');
            
            console.log('deviceTypeSelect element:', deviceTypeSelect);
            console.log('deviceSelect element:', deviceSelect);
            
            if (!deviceTypeSelect || !deviceSelect) {
                console.error('Could not find dropdown elements in openAddActionModal!');
                return;
            }
            
            // 移除之前的事件监听器（如果存在）
            deviceTypeSelect.removeEventListener('change', handleDeviceTypeChange);
            deviceSelect.removeEventListener('change', handleDeviceChange);
            
            // 添加新的事件监听器
            deviceTypeSelect.addEventListener('change', handleDeviceTypeChange);
            deviceSelect.addEventListener('change', handleDeviceChange);
            
            console.log('Added event listeners to dropdown lists');
            
            // 确保设备数据可用后再加载设备列表
            if (window.deviceManager && window.deviceManager.devices && window.deviceManager.devices.length > 0) {
                // 如果设备管理器有数据，确保window.devicesData也有数据
                window.devicesData = window.deviceManager.devices;
                // console.log('Using existing device data from deviceManager');
                loadDevicesForModal();
            } else {
                // 如果没有数据，尝试强制从网关加载
                console.log('No device data available, forcing load from gateway...');
                if (window.deviceManager) {
                    window.deviceManager.loadDevicesFromGateway(true).then(() => {
                        // 加载完成后再填充下拉列表
                        setTimeout(() => {
                            window.devicesData = window.deviceManager.devices;
                            console.log('Device data loaded from gateway, calling loadDevicesForModal');
                            loadDevicesForModal();
                        }, 500);
                    }).catch((error) => {
                        console.error('Failed to load devices from gateway:', error);
                        // 如果WebSocket方式失败，尝试HTTP方式
                        loadDevicesForModal();
                    });
                } else {
                    // console.log('No deviceManager available, trying HTTP method');
                    // 如果设备管理器不存在，直接尝试HTTP方式
                    loadDevicesForModal();
                }
            }
        }

        // 关闭Add Action弹窗
        function closeAddActionModal() {
            const modal = document.getElementById('addActionModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                // 清空表单
                document.getElementById('addActionForm').reset();
            }, 400);
        }

        // 加载设备列表到下拉框
        function loadDevicesForModal() {
            console.log('=== loadDevicesForModal called ===');
            
            const deviceSelect = document.getElementById('deviceSelect');
            const deviceTypeSelect = document.getElementById('deviceType');
            
            if (!deviceSelect || !deviceTypeSelect) {
                console.error('Could not find dropdown elements!');
                return;
            }
            
            console.log('Found dropdown elements, clearing options...');
            
            // 清空现有选项
            deviceSelect.innerHTML = '<option value="">Select a device...</option>';
            deviceTypeSelect.innerHTML = '<option value="">Select device type...</option>';
            
            // 直接从API获取最新的设备数据
            console.log('Fetching fresh device data from API...');
            fetch(getGatewayUrl() + '/api/devices')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(devices => {
                    console.log('Fetched devices from server:', devices);
                    
                    if (!devices || devices.length === 0) {
                        console.log('No devices returned from API');
                        return;
                    }
                    
                    const deviceTypes = new Set();
                    let onlineDeviceCount = 0;
                    
                    devices.forEach((device, index) => {
                        console.log(`Processing device ${index}:`, {
                            name: device.name,
                            nodeId: device.nodeId,
                            type: device.type,
                            online: device.online
                        });
                        
                        // 只添加在线设备到设备列表
                        if (device.online === true) {
                            onlineDeviceCount++;
                            const option = document.createElement('option');
                            option.value = device.nodeId;
                            option.textContent = `${device.name || 'Device'} (${device.nodeId})`;
                            deviceSelect.appendChild(option);
                            console.log('Added online device to dropdown:', device.name);
                        }
                        
                        // 收集所有设备类型（包括离线设备的类型）
                        if (device.type && device.type !== 'Unknown' && device.type.trim() !== '') {
                            deviceTypes.add(device.type);
                            console.log('Added device type:', device.type);
                        }
                    });
                    
                    console.log('Total online devices added:', onlineDeviceCount);
                    console.log('Found device types:', Array.from(deviceTypes));
                    
                    // 添加设备类型选项
                    if (deviceTypes.size > 0) {
                        Array.from(deviceTypes).sort().forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            deviceTypeSelect.appendChild(option);
                            console.log('Added device type option:', type);
                        });
                    } else {
                        console.log('No device types found');
                    }
                })
                .catch(error => {
                    console.error('Error loading devices from API:', error);
                    
                    // 如果API调用失败，尝试使用缓存的设备数据
                    console.log('Falling back to cached device data...');
                    let devicesData = null;
                    if (window.deviceManager && window.deviceManager.devices && window.deviceManager.devices.length > 0) {
                        devicesData = window.deviceManager.devices;
                        // console.log('Using deviceManager.devices, count:', devicesData.length);
                    } else if (window.devicesData && window.devicesData.length > 0) {
                        devicesData = window.devicesData;
                        console.log('Using window.devicesData, count:', devicesData.length);
                    }
                    
                    if (devicesData && devicesData.length > 0) {
                        const deviceTypes = new Set();
                        let onlineDeviceCount = 0;
                        
                        devicesData.forEach((device, index) => {
                            // 只添加在线设备到设备列表
                            if (device.isOnline || device.online) {
                                onlineDeviceCount++;
                                const option = document.createElement('option');
                                option.value = device.nodeId;
                                option.textContent = `${device.name || 'Device'} (${device.nodeId})`;
                                deviceSelect.appendChild(option);
                            }
                            
                            // 收集所有设备类型
                            if (device.type && device.type !== 'Unknown' && device.type.trim() !== '') {
                                deviceTypes.add(device.type);
                            }
                        });
                        
                        // 添加设备类型选项
                        Array.from(deviceTypes).sort().forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            deviceTypeSelect.appendChild(option);
                        });
                    }
                });
        }

        // 处理设备类型下拉列表变化事件
        function handleDeviceTypeChange(event) {
            console.log('=== handleDeviceTypeChange triggered ===');
            const selectedType = event.target.value;
            console.log('Device type changed to:', selectedType);
            console.log('Event target:', event.target);
            
            if (selectedType) {
                // 根据选择的设备类型过滤设备列表
                console.log('Filtering devices by type:', selectedType);
                filterDevicesByType(selectedType);
            } else {
                // 如果没有选择类型，显示所有在线设备
                console.log('No type selected, loading all devices');
                loadDevicesForModal();
            }
        }

        // 处理设备下拉列表变化事件
        function handleDeviceChange(event) {
            console.log('=== handleDeviceChange triggered ===');
            const selectedDevice = event.target.value;
            console.log('Device changed to:', selectedDevice);
            console.log('Event target:', event.target);
            
            if (selectedDevice) {
                // 可以在这里添加设备选择后的逻辑
                const deviceData = getDeviceById(selectedDevice);
                if (deviceData) {
                    console.log('Selected device data:', deviceData);
                } else {
                    console.log('Could not find device data for ID:', selectedDevice);
                }
            }
        }

        // 根据设备类型过滤设备列表
        function filterDevicesByType(deviceType) {
            console.log('Filtering devices by type:', deviceType);
            
            const deviceSelect = document.getElementById('deviceSelect');
            deviceSelect.innerHTML = '<option value="">Select a device...</option>';
            
            // 获取设备数据
            let devicesData = null;
            if (window.deviceManager && window.deviceManager.devices && window.deviceManager.devices.length > 0) {
                devicesData = window.deviceManager.devices;
            } else if (window.devicesData && window.devicesData.length > 0) {
                devicesData = window.devicesData;
            }
            
            if (devicesData) {
                const filteredDevices = devicesData.filter(device => 
                    device.type === deviceType && (device.isOnline || device.online)
                );
                
                console.log(`Found ${filteredDevices.length} devices of type ${deviceType}`);
                
                filteredDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.nodeId;
                    option.textContent = `${device.name || 'Device'} (${device.nodeId})`;
                    deviceSelect.appendChild(option);
                });
            }
        }

        // 根据设备ID获取设备数据
        function getDeviceById(deviceId) {
            let devicesData = null;
            if (window.deviceManager && window.deviceManager.devices && window.deviceManager.devices.length > 0) {
                devicesData = window.deviceManager.devices;
            } else if (window.devicesData && window.devicesData.length > 0) {
                devicesData = window.devicesData;
            }
            
            if (devicesData) {
                return devicesData.find(device => device.nodeId == deviceId);
            }
            return null;
        }

        // 设置命令到输入框
        function setCommand(command) {
            const commandInput = document.getElementById('commandInput');
            const currentValue = commandInput.value;

            if (currentValue === '') {
                // If empty, just set the command
                commandInput.value = command;
            } else {
                // If not empty...
                if (command === ',') {
                    // If the new command is a comma...
                    if (!currentValue.endsWith(',')) {
                        // and it doesn't already end with a comma, add it.
                        commandInput.value += ',';
                    }
                } else {
                    // If the new command is not a comma...
                    if (currentValue.endsWith(',')) {
                        // and the input already ends with a comma, just add the command.
                        commandInput.value += command;
                    } else {
                        // otherwise, add a comma separator then the command.
                        commandInput.value += ',' + command;
                    }
                }
            }
        }

        // 删除上一次输入的命令
        function clearCommand() {
            const commandInput = document.getElementById('commandInput');
            const currentValue = commandInput.value;
            const commands = currentValue.split(',').filter(c => c.trim() !== ''); // split by comma and remove empty parts

            if (commands.length > 0) {
                commands.pop(); // remove the last command
                commandInput.value = commands.join(','); // join back with comma
            }
        }

        // 将命令暂存到暂存区
        function stageCommand() {
            const deviceTypeSelect = document.getElementById('deviceType');
            const deviceSelect = document.getElementById('deviceSelect');
            const actionTypeSelect = document.getElementById('actionType');
            const commandInput = document.getElementById('commandInput');
            const stagedCommandsList = document.getElementById('staged-commands-list');

            const deviceType = deviceTypeSelect.value;
            const deviceId = deviceSelect.value;
            const actionType = actionTypeSelect.value;
            const commandText = commandInput.value;

            if (!deviceType || !deviceId || !actionType || !commandText) {
                notificationManager.show('Please ensure "Device Type", "Device", "Action Type", and "Command" are all filled out.', 'error');
                return;
            }

            const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
            const deviceName = selectedOption.text.split(' (')[0];
            const command = commandInput.value;

            // Find the device to get the MAC address
            const deviceData = getDeviceById(deviceId);
            if (!deviceData) {
                console.error('Could not find device data for ID:', deviceId);
                notificationManager.show('Could not find device data. Please select a valid device.', 'error');
                return;
            }
            const macAddress = deviceData.macAddress;

            if (deviceId && command) {
                const stagedCommand = document.createElement('div');
                stagedCommand.classList.add('staged-command');
                stagedCommand.dataset.deviceId = deviceId; // Store deviceId
                stagedCommand.dataset.mac = macAddress; // Store mac address
                stagedCommand.dataset.name = deviceName; // Store clean name
                stagedCommand.innerHTML = `
                    <span><strong>${deviceName}</strong>: ${command}</span>
                    <div class="staged-command-buttons">
                        <button class="staged-command-btn staged-command-edit" onclick="editStagedCommand(this)">Edit</button>
                        <button class="staged-command-btn staged-command-delete" onclick="deleteStagedCommand(this)">Delete</button>
                    </div>
                `;
                stagedCommandsList.appendChild(stagedCommand);

                // 清空命令输入框以便输入下一个命令
                commandInput.value = '';
            }
        }

        // 立即执行命令
        function executeCommand() {
            const stagedCommandsList = document.getElementById('staged-commands-list');
            const stagedCommands = stagedCommandsList.querySelectorAll('.staged-command');

            if (stagedCommands.length === 0) {
                alert('No commands to execute.');
                return;
            }

            const payload = Array.from(stagedCommands).map(stagedCommand => {
                const deviceName = stagedCommand.dataset.name;
                const commandText = stagedCommand.querySelector('span').innerText.split(': ')[1];
                const macAddress = stagedCommand.dataset.mac;

                return {
                    name: deviceName,
                    mac: macAddress,
                    states: commandText.split(',').map(s => s.trim())
                };
            });

            const message = {
                command: "sendMessage",
                payload: {
                    isBroadcast: true,
                    message: {
                        cmd: "groupState",
                        payload: payload
                    }
                }
            };

            console.log('WebSocket message to send:', JSON.stringify(message));
            window.deviceManager.sendWebSocketMessage(message);
        }

        // 编辑暂存的命令
        let currentEditingCommand = null;

        function editStagedCommand(button) {
            currentEditingCommand = button.closest('.staged-command');
            const commandText = currentEditingCommand.querySelector('span').innerText.split(': ')[1];
            
            const commandInput = document.getElementById('editCommandInput');
            commandInput.value = commandText;
            
            // 清除任何验证状态和消息
            commandInput.setCustomValidity('');
            commandInput.removeAttribute('required');
            
            // 添加键盘事件监听器
            commandInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    saveStagedCommand(e);
                    return false;
                }
            });
            
            const modal = document.getElementById('editStagedCommandModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeEditStagedCommandModal() {
            const modal = document.getElementById('editStagedCommandModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 400);
            currentEditingCommand = null;
        }

        function saveStagedCommand(event) {
            // 阻止任何默认的表单提交行为
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (currentEditingCommand) {
                const commandInput = document.getElementById('editCommandInput');
                // 移除任何可能的验证状态
                commandInput.setCustomValidity('');
                
                const newCommandText = commandInput.value.trim();
                if (newCommandText === '') {
                    // 如果命令为空，不保存并关闭模态框
                    closeEditStagedCommandModal();
                    return false;
                }
                const deviceName = currentEditingCommand.dataset.name;
                currentEditingCommand.querySelector('span').innerHTML = `<strong>${deviceName}</strong>: ${newCommandText}`;
            }
            closeEditStagedCommandModal();
            return false;
        }

        function setCommandInEdit(command) {
            const commandInput = document.getElementById('editCommandInput');
            const currentValue = commandInput.value.trim();

            if (currentValue === '') {
                commandInput.value = command;
            } else {
                if (command === ',') {
                    if (!currentValue.endsWith(',')) {
                        commandInput.value += ',';
                    }
                } else {
                    if (currentValue.endsWith(',')) {
                        commandInput.value += command;
                    } else {
                        commandInput.value += ',' + command;
                    }
                }
            }
        }

        function clearCommandInEdit() {
            const commandInput = document.getElementById('editCommandInput');
            const currentValue = commandInput.value;
            const commands = currentValue.split(',').filter(c => c.trim() !== '');

            if (commands.length > 0) {
                commands.pop();
                commandInput.value = commands.join(',');
            }
        }

        // 删除暂存的命令
        function deleteStagedCommand(button) {
            button.parentElement.parentElement.remove();
        }

        // 保存动作
        function saveAction() {
            const stagedCommandsList = document.getElementById('staged-commands-list');
            const stagedCommands = stagedCommandsList.querySelectorAll('.staged-command');

            if (stagedCommands.length === 0) {
                notificationManager.show('No staged commands to save. Please add commands first.', 'error');
                return;
            }

            // 获取actionName输入框的值
            const actionNameInput = document.getElementById('actionName');
            const actionName = actionNameInput ? actionNameInput.value.trim() : '';

            // 构建payload数组，从暂存命令中获取数据
            const payload = Array.from(stagedCommands).map(stagedCommand => {
                const deviceName = stagedCommand.dataset.name;
                const commandText = stagedCommand.querySelector('span').innerText.split(': ')[1];
                const macAddress = stagedCommand.dataset.mac;

                return {
                    name: deviceName,
                    mac: macAddress,
                    states: commandText.split(',').map(s => s.trim())
                };
            });

            // 构建指定格式的JSON
            const jsonOutput = {
                command: "saveAction",
                payload: {
                    isBroadcast: true,
                    message: {
                        cmd: "groupState",
                        payload: payload
                    }
                }
            };

            // 如果提供了actionName，添加到JSON中
            if (actionName.length > 0) {
                jsonOutput.actionName = actionName;
            }

            // 打印到控制台
            console.log('Sending saveAction JSON:', JSON.stringify(jsonOutput));
            
            // 发送到网关
            if (window.deviceManager && window.deviceManager.sendWebSocketMessage(jsonOutput)) {
                notificationManager.show('Action saved and sent to gateway successfully!', 'success');
                
                // 添加延迟后自动刷新动作列表
                setTimeout(() => {
                    loadActions();
                    console.log('Auto-refreshing actions list after save');
                }, 500); // 500ms延迟确保网关有时间处理请求
            } else {
                notificationManager.show('Action saved but failed to send to gateway. Check WebSocket connection.', 'warning');
            }
            
            closeAddActionModal();
        }

        // 点击模态框外部关闭弹窗
        window.onclick = function(event) {
            const modal = document.getElementById('addActionModal');
            if (event.target === modal) {
                closeAddActionModal();
            }
        }
        
        // 重启网关函数
        function restartGateway() {
            if (confirm('Are you sure you want to restart the gateway? This will temporarily disconnect all devices.')) {
                notificationManager.show('Restarting gateway...', 'info');
                
                const gatewayUrl = getGatewayUrl();
                fetch(`${gatewayUrl}/restart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        notificationManager.show('Gateway restart initiated. The page will reload in 10 seconds.', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 10000);
                    } else {
                        throw new Error('Failed to restart gateway');
                    }
                })
                .catch(error => {
                    console.error('Error restarting gateway:', error);
                    notificationManager.show('Failed to restart gateway. Please try again.', 'error');
                });
            }
        }
    </script>

    <script>
        // 设备列表自动滚动功能
        let scrollInterval = null;
        const scrollSpeed = 1; // 滚动速度
        
        function startScroll(element) {
            if (element.scrollHeight > element.clientHeight) {
                // 只有当内容超出可视区域时才启动滚动
                let scrollPosition = 0;
                let scrollDirection = 1; // 1向下滚动，-1向上滚动
                
                scrollInterval = setInterval(() => {
                    scrollPosition += scrollDirection * scrollSpeed;
                    element.scrollTop = scrollPosition;
                    
                    // 当滚动到底部时，改变方向
                    if (scrollPosition >= (element.scrollHeight - element.clientHeight)) {
                        scrollDirection = -1;
                    }
                    // 当滚动到顶部时，改变方向
                    else if (scrollPosition <= 0) {
                        scrollDirection = 1;
                    }
                }, 50);
            }
        }
        
        function stopScroll(element) {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }
    </script>

    <div id="ledConfigModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>LED Configuration</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="onColor">On Color:</label>
                    <div class="color-input-container">
                        <div id="onColorPreview" class="color-preview" style="cursor: pointer;"></div>
                        <input type="color" id="onColor" name="onColor">
                        <input type="text" id="onColorText" name="onColorText" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                </div>
                <div class="config-item">
                    <label for="offColor">Off Color:</label>
                    <div class="color-input-container">
                        <div id="offColorPreview" class="color-preview" style="cursor: pointer;"></div>
                        <input type="color" id="offColor" name="offColor">
                        <input type="text" id="offColorText" name="offColorText" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                </div>
                <div class="config-item">
                    <label for="brightness_on">On Brightness: <span id="brightness_on_value">(0)</span></label>
                    <input type="range" id="brightness_on" name="brightness_on" min="0" max="255">
                </div>
                <div class="config-item">
                    <label for="brightness_off">Off Brightness: <span id="brightness_off_value">(0)</span></label>
                    <input type="range" id="brightness_off" name="brightness_off" min="0" max="255">
                </div>
                <div class="config-item" style="grid-column: 1 / span 2;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label for="isDaytime">Is Daytime:</label>
                            <input type="text" id="isDaytime" readonly style="width: 100%;">
                        </div>
                        <div>
                            <label for="linkedSensor">Linked Sensor:</label>
                            <select id="linkedSensor" style="width: 100%;"></select>
                        </div>
                        <div>
                            <label for="daylightThreshold">Daylight Threshold:</label>
                            <input type="number" id="daylightThreshold" style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <button id="cancelLedConfig" class="cancel-button">Cancel</button>
                <button id="saveLedConfig" class="save-button">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Action Modal -->
    <div id="addActionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Action</h2>
                <span class="close-modal" onclick="closeAddActionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addActionForm">
                    <div class="form-group">
                        <label for="actionName">Action Name:</label>
                        <input type="text" id="actionName" name="actionName" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deviceType">Device Type:</label>
                            <select id="deviceType" name="deviceType" required>
                                <option value="">Select device type...</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="deviceSelect">Device:</label>
                            <select id="deviceSelect" name="deviceSelect" required>
                                <option value="">Select a device...</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="actionType">Action Type:</label>
                        <select id="actionType" name="actionType" required>
                            <option value="">Select action type...</option>
                            <option value="action">Action</option>
                            <option value="servoControl">Servo Control</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="commandInput">Command:</label>
                        <input type="text" id="commandInput" name="commandInput" placeholder="Enter command..." required>
                    </div>

                    <div id="staged-commands-container" class="form-group">
                        <p><strong>Staged Commands:</strong></p>
                        <div id="staged-commands-list"></div>
                    </div>
                    
                    
                    <div class="form-group">
                        <div class="command-examples">
                            <p><strong>Command Examples:</strong></p>
                            <div class="example-section">
                                <span class="example-tag" onclick="setCommand('on')">on</span>
                                <span class="example-tag" onclick="setCommand('off')">off</span>
                                <span class="example-tag" onclick="setCommand('ignore')">ignore</span>
                                <span class="example-tag" onclick="setCommand('toggle')">toggle</span>
                                <span class="example-tag" onclick="setCommand('action')">action</span>
                                <span class="example-tag" onclick="setCommand('angle')">angle</span>
                                <span class="example-tag" onclick="setCommand('set_angle')">set_angle</span>
                                <span class="example-tag" onclick="setCommand('back_forth')">back_forth</span>
                                <span class="example-tag" onclick="setCommand('sequence')">sequence</span>
                                <span class="example-tag" onclick="setCommand('repeat')">repeat</span>
                                <span class="example-tag" onclick="setCommand('delay')">delay</span>
                                <span class="example-tag" onclick="setCommand(',')">,</span>
                                <span class="example-tag" onclick="clearCommand()">Delete</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-button" onclick="stageCommand()">Stage Command</button>
                <button type="button" class="modal-button" onclick="executeCommand()">Execute Immediately</button>
                <button type="button" class="modal-button" onclick="saveAction()">Save Action</button>
                <button type="button" class="modal-button cancel-button" onclick="closeAddActionModal()">Cancel</button>
            </div>
            </div>
        </div>
    </div>

    <!-- Edit Staged Command Modal -->
    <div id="editStagedCommandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Staged Command</h2>
                <span class="close-button" onclick="closeEditStagedCommandModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editCommandInput">Command:</label>
                    <input type="text" id="editCommandInput" class="form-control" autocomplete="off" spellcheck="false">
                </div>
                <div class="form-group">
                    <div class="command-examples">
                        <p><strong>Command Examples:</strong></p>
                        <div class="example-section">
                            <span class="example-tag" onclick="setCommandInEdit('on')">on</span>
                            <span class="example-tag" onclick="setCommandInEdit('off')">off</span>
                            <span class="example-tag" onclick="setCommandInEdit('ignore')">ignore</span>
                            <span class="example-tag" onclick="setCommandInEdit('toggle')">toggle</span>
                            <span class="example-tag" onclick="setCommandInEdit('action')">action</span>
                            <span class="example-tag" onclick="setCommandInEdit('angle')">angle</span>
                            <span class="example-tag" onclick="setCommandInEdit('set_angle')">set_angle</span>
                            <span class="example-tag" onclick="setCommandInEdit('scan')">scan</span>
                            <span class="example-tag" onclick="setCommandInEdit('round-trip')">round-trip</span>
                            <span class="example-tag" onclick="setCommandInEdit('continuous')">continuous</span>
                            <span class="example-tag" onclick="setCommandInEdit('repeat')">repeat</span>
                            <span class="example-tag" onclick="setCommandInEdit(',')">,</span>
                            <span class="example-tag" onclick="clearCommandInEdit()">Delete</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditStagedCommandModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStagedCommand()">Save</button>
            </div>
        </div>
    </div>

    <!-- OTA Upgrade Modal -->
    <div id="otaUpgradeModal" class="modal" onclick="closeOTAUpgradeModal()">
        <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>OTA Firmware Upgrade</h2>
            </div>
            <div class="modal-body">
                <div id="otaUploadSection">
                    <div class="info-section">
                        <h3>Upload Firmware</h3>
                        <p>Select a firmware file (.bin) to upload to the device.</p>
                        
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="upload-icon">📁</div>
                            <div class="upload-text">
                                <p>Drag and drop firmware file here or click to browse</p>
                                <p class="file-info">Supported format: .bin files</p>
                            </div>
                            <input type="file" id="firmwareFile" accept=".bin" style="display: none;">
                        </div>
                        
                        <div id="selectedFileInfo" class="selected-file-info" style="display: none;">
                            <div class="file-details">
                                <span class="file-name"></span>
                                <span class="file-size"></span>
                            </div>
                            <button class="remove-file-btn" onclick="removeSelectedFile()">×</button>
                        </div>
                        
                        <div class="upload-actions">
                            <button id="uploadBtn" class="btn btn-primary" onclick="startOTAUpload()" disabled>
                                Start Upload
                            </button>
                            <button class="btn btn-secondary" onclick="closeOTAUpgradeModal()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="otaProgressSection" style="display: none;">
                    <div class="info-section">
                        <h3>Upload Progress</h3>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div id="otaProgressBar" class="progress-fill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="otaProgressPercent">0%</span>
                                <span id="otaProgressSize">0 / 0 bytes</span>
                            </div>
                        </div>
                        
                        <div class="upload-status">
                            <div class="status-item">
                                <span class="label">Status:</span>
                                <span id="otaStatus" class="value">Preparing...</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Elapsed Time:</span>
                                <span id="otaElapsedTime" class="value">0s</span>
                            </div>
                            <div class="status-item">
                                <span class="label">File:</span>
                                <span id="otaFileName" class="value">-</span>
                            </div>
                        </div>
                        
                        <div id="otaErrorMessage" class="error-message" style="display: none;"></div>
                        
                        <div class="upload-actions">
                            <button id="otaCancelBtn" class="btn btn-danger" onclick="cancelOTAUpload()">
                                Cancel Upload
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="otaCompleteSection" style="display: none;">
                    <div class="info-section">
                        <div class="success-icon">✅</div>
                        <h3>Upload Complete</h3>
                        <p>Firmware has been successfully uploaded. The device will reboot automatically.</p>
                        
                        <div class="upload-actions">
                            <button class="btn btn-primary" onclick="closeOTAUpgradeModal()">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Configuration Modal -->
    <div id="networkConfigModal" class="modal" onclick="closeNetworkConfigModal()">
        <div class="modal-content" style="max-width: 700px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Network Configuration</h2>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h3>Gateway Configuration</h3>
                    <div class="form-group">
                        <label for="gatewayAddress">Gateway Address:</label>
                        <input type="text" id="gatewayAddress" class="form-control" placeholder="192.168.1.66" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                        <small class="form-text text-muted">Enter the IP address for this gateway</small>
                    </div>
                    <div class="config-actions" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="saveGatewayConfig()">Save Gateway Configuration</button>
                    </div>
                </div>
                
                <div class="config-section" style="display: none;">
                    <h3>Mesh Network Settings</h3>
                    <div class="form-group">
                        <label for="meshName">Mesh Name:</label>
                        <input type="text" id="meshName" class="form-control" placeholder="Enter mesh network name">
                    </div>
                    <div class="form-group">
                        <label for="meshPassword">Mesh Password:</label>
                        <input type="password" id="meshPassword" class="form-control" placeholder="Enter mesh password">
                    </div>
                    <div class="form-group">
                        <label for="meshPort">Mesh Port:</label>
                        <input type="number" id="meshPort" class="form-control" placeholder="5555" min="1024" max="65535">
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>MQTT Configuration</h3>
                    <div class="form-group">
                        <label for="mqttEnabled">Enable MQTT:</label>
                        <input type="checkbox" id="mqttEnabled" class="form-checkbox">
                    </div>
                    <div id="mqttSettings" style="display: none;">
                        <div class="form-group">
                            <label for="mqttServer">MQTT Server:</label>
                            <input type="text" id="mqttServer" class="form-control" placeholder="192.168.1.250">
                        </div>
                        <div class="form-group">
                            <label for="mqttPort">MQTT Port:</label>
                            <input type="number" id="mqttPort" class="form-control" placeholder="1883" min="1" max="65535">
                        </div>
                        <div class="form-group">
                            <label for="mqttUsername">Username:</label>
                            <input type="text" id="mqttUsername" class="form-control" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="mqttPassword">Password:</label>
                            <input type="password" id="mqttPassword" class="form-control" placeholder="Optional">
                        </div>
                        <div class="form-group" style="display: none;">
                            <label for="mqttTopic">Base Topic:</label>
                            <input type="text" id="mqttTopic" class="form-control" placeholder="mesh/gateway">
                        </div>
                    </div>
                    <div class="config-actions" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="saveMqttConfig()">Save MQTT Configuration</button>
                    </div>
                </div>
                
                <div class="config-actions">
                    <button class="btn btn-secondary" onclick="closeNetworkConfigModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Action Details Modal -->
    <div id="deviceActionDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>设备动作详情</h2>
                <span class="close-button" onclick="closeDeviceActionDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="deviceActionDetailsContent" style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-button cancel-button" onclick="closeDeviceActionDetailsModal()">关闭</button>
            </div>
        </div>
    </div>

    <style>
        /* JSON语法高亮样式 */
        .json-key {
            color: #0066cc;
            font-weight: bold;
        }
        .json-string {
            color: #008000;
        }
        .json-number {
            color: #ff6600;
        }
        .json-boolean {
            color: #b22222;
            font-weight: bold;
        }
        .json-null {
            color: #808080;
            font-style: italic;
        }
        
        /* OTA升级样式 */
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }
        
        .file-upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .file-upload-area.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .upload-text p {
            margin: 5px 0;
        }
        
        .file-info {
            color: #666;
            font-size: 14px;
        }
        
        .selected-file-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .file-details {
            display: flex;
            flex-direction: column;
        }
        
        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .file-size {
            color: #666;
            font-size: 14px;
        }
        
        .remove-file-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-file-btn:hover {
            background: #c82333;
        }
        
        .upload-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        .upload-status {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .status-item .label {
            font-weight: bold;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-icon {
            font-size: 64px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
        }

        /* 为所有按钮添加基础过渡效果 */
        .btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* 为重启和清除NVS按钮添加特殊的悬停效果 */
        .btn-warning:hover::before,
        .btn-danger:hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 0.6s ease-in-out;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* 增强按钮的活跃状态效果 */
        .btn-warning:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4);
        }

        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
        }

        /* 自定义确认弹窗样式 */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .confirm-overlay.show {
            opacity: 1;
        }

        .confirm-dialog {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.8) translateY(-20px);
            transition: all 0.3s ease;
        }

        .confirm-dialog.show {
            transform: scale(1) translateY(0);
        }

        .confirm-header {
            padding: 24px 24px 16px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .confirm-icon {
            font-size: 48px;
            margin-bottom: 12px;
            line-height: 1;
        }

        .confirm-title {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #495057;
        }

        .confirm-body {
            padding: 20px 24px;
        }

        .confirm-message {
            margin: 0;
            font-size: 16px;
            line-height: 1.5;
            color: #6c757d;
            text-align: center;
        }

        .confirm-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-footer .btn {
            min-width: 100px;
            padding: 10px 20px;
            font-weight: 500;
        }

        /* 不同类型的确认弹窗样式 */
        .confirm-dialog.warning .confirm-header {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .confirm-dialog.danger .confirm-header {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .confirm-dialog.info .confirm-header {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .confirm-dialog.success .confirm-header {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
    </style>

    <script>
        // 显示设备动作详情
        function showDeviceActionDetails(actionId, deviceIndex) {
            console.log('showDeviceActionDetails 被调用:', actionId, deviceIndex);
            
            try {
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                console.log('从localStorage获取的actions:', actions);
                
                // 使用actionId查找action，可能是name或actionName
                const action = actions.find(a => a.id === actionId || a.name === actionId || a.actionName === actionId);
                console.log('找到的action:', action);
                
                if (action && action.payload && action.payload.message && action.payload.message.payload) {
                    console.log('action.payload.message.payload:', action.payload.message.payload);
                    const deviceData = action.payload.message.payload[deviceIndex];
                    console.log('deviceIndex:', deviceIndex, '对应的deviceData:', deviceData);
                    
                    if (deviceData) {
                        // 格式化JSON数据
                        const formattedJson = JSON.stringify(deviceData, null, 2);
                        
                        // 美化JSON显示
                        const coloredJson = syntaxHighlightJson(formattedJson);
                        document.getElementById('deviceActionDetailsContent').innerHTML = coloredJson;
                        
                        // 显示模态框
                        const modal = document.getElementById('deviceActionDetailsModal');
                        modal.style.display = 'block';
                        setTimeout(() => modal.classList.add('show'), 10);
                    } else {
                        console.error('deviceData不存在');
                    }
                } else {
                    console.error('action数据结构不完整');
                }
            } catch (error) {
                console.error('showDeviceActionDetails出错:', error);
            }
        }
        
        // 执行设备动作的函数
        function executeDeviceAction(actionId, deviceIndex) {
            console.log('executeDeviceAction 被调用:', actionId, deviceIndex);
            
            try {
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                console.log('从localStorage获取的actions:', actions);
                
                // 使用actionId查找action，可能是name或actionName
                const action = actions.find(a => a.id === actionId || a.name === actionId || a.actionName === actionId);
                console.log('找到的action对象:', action);
                
                if (!action) {
                    console.error('未找到对应的action:', actionId);
                    notificationManager.show('未找到对应的动作数据', 'error');
                    return;
                }
                
                // 获取actionName用于执行
                const actionName = action.name || action.actionName;
                console.log('执行的actionName:', actionName);
                
                if (!actionName) {
                    console.error('无法确定要执行的action名称');
                    notificationManager.show('无法确定要执行的动作名称', 'error');
                    return;
                }
                
                // 获取设备数据
                if (!action.payload || !action.payload.message || !action.payload.message.payload || !Array.isArray(action.payload.message.payload)) {
                    console.error('action数据结构不完整');
                    notificationManager.show('动作数据结构不完整', 'error');
                    return;
                }
                
                const deviceData = action.payload.message.payload[deviceIndex];
                console.log('设备数据:', deviceData);
                
                if (!deviceData) {
                    console.error(`未找到索引为${deviceIndex}的设备数据`);
                    notificationManager.show('未找到对应的设备数据', 'error');
                    return;
                }
                
                // 构建WebSocket消息
                const message = {
                    command: "sendMessage",
                    payload: {
                        isBroadcast: true,
                        message: {
                            cmd: "groupState",
                            payload: [
                                {
                                    name: deviceData.name,
                                    mac: deviceData.mac,
                                    states: deviceData.states || ["toggle", "toggle", "toggle"]
                                }
                            ]
                        }
                    }
                };
                
                console.log('发送WebSocket消息:', message);
                
                // 显示执行中状态
                notificationManager.show(`正在执行动作: ${actionName}...`, 'info');
                
                // 通过WebSocket发送消息
                if (window.deviceManager && window.deviceManager.sendWebSocketMessage(message)) {
                    console.log('WebSocket消息发送成功');
                    notificationManager.show(`动作 "${actionName}" 执行成功`, 'success');
                } else {
                    console.error('WebSocket消息发送失败');
                    notificationManager.show('WebSocket连接未建立或消息发送失败', 'error');
                }
            } catch (error) {
                console.error('执行设备动作时出错:', error);
                notificationManager.show(`执行设备动作时出错: ${error.message}`, 'error');
            }
        }
        
        // JSON语法高亮函数
        function syntaxHighlightJson(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        // 关闭设备动作详情模态框
        function closeDeviceActionDetailsModal() {
            const modal = document.getElementById('deviceActionDetailsModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 400);
        }
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('deviceActionDetailsModal');
            if (event.target === modal) {
                closeDeviceActionDetailsModal();
            }
        });
        
        // =================================================================================
        // OTA升级功能
        // =================================================================================
        let selectedFile = null;
        let otaUploadInterval = null;
        let otaStartTime = null;
        
        // 显示OTA升级模态框
        function showOTAUpgrade() {
            console.log('OTA Upgrade button clicked');
            const modal = document.getElementById('otaUpgradeModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('show'), 10);
            
            // 重置界面状态
            resetOTAInterface();
            setupFileUploadEvents();
        }
        
        // 关闭OTA升级模态框
        function closeOTAUpgradeModal() {
            const modal = document.getElementById('otaUpgradeModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 400);
            
            // 清理状态
            if (otaUploadInterval) {
                clearInterval(otaUploadInterval);
                otaUploadInterval = null;
            }
            selectedFile = null;
        }
        
        // 重置OTA界面
        function resetOTAInterface() {
            document.getElementById('otaUploadSection').style.display = 'block';
            document.getElementById('otaProgressSection').style.display = 'none';
            document.getElementById('otaCompleteSection').style.display = 'none';
            
            selectedFile = null;
            document.getElementById('selectedFileInfo').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
            
            // 重置进度条
            document.getElementById('otaProgressBar').style.width = '0%';
            document.getElementById('otaProgressPercent').textContent = '0%';
            document.getElementById('otaProgressSize').textContent = '0 / 0 bytes';
            document.getElementById('otaStatus').textContent = 'Preparing...';
            document.getElementById('otaElapsedTime').textContent = '0s';
            document.getElementById('otaFileName').textContent = '-';
            document.getElementById('otaErrorMessage').style.display = 'none';
        }
        
        // 设置文件上传事件
        function setupFileUploadEvents() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('firmwareFile');
            
            // 点击上传区域
            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // 文件选择
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });
            
            // 拖拽事件
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });
            
            fileUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
            });
            
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
        }
        
        // 处理文件选择
        function handleFileSelection(file) {
            // 检查文件类型
            if (!file.name.toLowerCase().endsWith('.bin')) {
                alert('Please select a .bin firmware file');
                return;
            }
            
            selectedFile = file;
            
            // 显示文件信息
            document.querySelector('#selectedFileInfo .file-name').textContent = file.name;
            document.querySelector('#selectedFileInfo .file-size').textContent = formatBytes(file.size);
            document.getElementById('selectedFileInfo').style.display = 'flex';
            document.getElementById('uploadBtn').disabled = false;
            
            console.log('File selected:', file.name, formatBytes(file.size));
        }
        
        // 移除选中的文件
        function removeSelectedFile() {
            selectedFile = null;
            document.getElementById('selectedFileInfo').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('firmwareFile').value = '';
        }
        
        // 开始OTA上传
        async function startOTAUpload() {
            if (!selectedFile) {
                alert('Please select a firmware file first');
                return;
            }
            
            console.log('Starting OTA upload:', selectedFile.name);
            
            // 切换到进度界面
            document.getElementById('otaUploadSection').style.display = 'none';
            document.getElementById('otaProgressSection').style.display = 'block';
            
            // 设置初始状态
            document.getElementById('otaFileName').textContent = selectedFile.name;
            document.getElementById('otaStatus').textContent = 'Uploading...';
            otaStartTime = Date.now();
            
            // 开始上传进度监控
            startProgressMonitoring();
            
            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                
                const gatewayUrl = getGatewayUrl();
                
                // 打印请求详细信息到控制台
                console.log('=== OTA Upload Request Details ===');
                console.log('Request URL:', `${gatewayUrl}/update_upload`);
                console.log('Request Method:', 'POST');
                console.log('File Name:', selectedFile.name);
                console.log('File Size:', selectedFile.size, 'bytes');
                console.log('File Type:', selectedFile.type);
                console.log('Request Headers:', {
                    'Content-Type': 'multipart/form-data'
                });
                console.log('FormData Contents:', {
                    file: {
                        name: selectedFile.name,
                        size: selectedFile.size,
                        type: selectedFile.type,
                        lastModified: selectedFile.lastModified
                    }
                });
                console.log('Request Timestamp:', new Date().toISOString());
                console.log('=====================================');
                
                const response = await fetch(`${gatewayUrl}/update_upload`, {
                    method: 'POST',
                    body: formData
                });
                
                let result = null;
                
                // 检查响应是否有内容
                if (response.status === 204 || response.headers.get('content-length') === '0') {
                    // 204 No Content 或空响应，创建默认成功结果
                    result = { success: true, message: 'Upload completed successfully' };
                } else {
                    // 有响应内容，尝试解析JSON
                    try {
                        result = await response.json();
                    } catch (jsonError) {
                        console.warn('Failed to parse JSON response, treating as success:', jsonError);
                        result = { success: response.ok, message: response.ok ? 'Upload completed' : 'Upload failed' };
                    }
                }
                
                // 打印响应详细信息到控制台
                console.log('=== OTA Upload Response Details ===');
                console.log('Response Status:', response.status);
                console.log('Response Headers:', Object.fromEntries(response.headers.entries()));
                console.log('Response Data:', result);
                console.log('Response Timestamp:', new Date().toISOString());
                console.log('====================================');
                
                if (result.success) {
                    // 上传成功
                    document.getElementById('otaStatus').textContent = 'Completed';
                    document.getElementById('otaProgressBar').style.width = '100%';
                    document.getElementById('otaProgressPercent').textContent = '100%';
                    
                    setTimeout(() => {
                        document.getElementById('otaProgressSection').style.display = 'none';
                        document.getElementById('otaCompleteSection').style.display = 'block';
                    }, 1000);
                    
                    if (window.notificationManager) {
                        window.notificationManager.show('Firmware uploaded successfully! Device will reboot.', 'success');
                    }
                } else {
                    // 上传失败
                    showOTAError(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('OTA upload error:', error);
                showOTAError('Network error: ' + error.message);
            } finally {
                if (otaUploadInterval) {
                    clearInterval(otaUploadInterval);
                    otaUploadInterval = null;
                }
            }
        }
        
        // 开始进度监控
        function startProgressMonitoring() {
            otaUploadInterval = setInterval(async () => {
                try {
                    const gatewayUrl = getGatewayUrl();
                    
                    // 打印状态查询请求详细信息到控制台
                    console.log('=== OTA Status Request Details ===');
                    console.log('Request URL:', `${gatewayUrl}/api/ota_status`);
                    console.log('Request Method:', 'GET');
                    console.log('Request Timestamp:', new Date().toISOString());
                    console.log('===================================');
                    
                    const response = await fetch(`${gatewayUrl}/api/ota_status`);
                    const status = await response.json();
                    
                    // 打印响应详细信息到控制台
                    console.log('=== OTA Status Response Details ===');
                    console.log('Response Status:', response.status);
                    console.log('Response Headers:', Object.fromEntries(response.headers.entries()));
                    console.log('Response Data:', status);
                    console.log('Response Timestamp:', new Date().toISOString());
                    console.log('====================================');
                    
                    // 更新进度
                    if (status.progress !== undefined) {
                        document.getElementById('otaProgressBar').style.width = status.progress + '%';
                        document.getElementById('otaProgressPercent').textContent = Math.round(status.progress) + '%';
                    }
                    
                    if (status.totalSize && status.uploadedSize !== undefined) {
                        document.getElementById('otaProgressSize').textContent = 
                            `${formatBytes(status.uploadedSize)} / ${formatBytes(status.totalSize)}`;
                    }
                    
                    // 更新状态
                    if (status.status) {
                        document.getElementById('otaStatus').textContent = status.status;
                    }
                    
                    // 更新时间
                    if (otaStartTime) {
                        const elapsed = Math.floor((Date.now() - otaStartTime) / 1000);
                        document.getElementById('otaElapsedTime').textContent = elapsed + 's';
                    }
                    
                    // 检查错误
                    if (status.error) {
                        showOTAError(status.error);
                        clearInterval(otaUploadInterval);
                        otaUploadInterval = null;
                    }
                    
                    // 检查完成状态
                    if (status.status === 'completed' && !status.inProgress) {
                        clearInterval(otaUploadInterval);
                        otaUploadInterval = null;
                    }
                } catch (error) {
                    console.error('Error checking OTA status:', error);
                }
            }, 1000);
        }
        
        // 显示OTA错误
        function showOTAError(errorMessage) {
            document.getElementById('otaStatus').textContent = 'Error';
            document.getElementById('otaErrorMessage').textContent = errorMessage;
            document.getElementById('otaErrorMessage').style.display = 'block';
            
            if (window.notificationManager) {
                window.notificationManager.show('OTA Upload Error: ' + errorMessage, 'error');
            }
        }
        
        // 取消OTA上传
        function cancelOTAUpload() {
            if (otaUploadInterval) {
                clearInterval(otaUploadInterval);
                otaUploadInterval = null;
            }
            
            // 重置到初始状态
            resetOTAInterface();
            
            if (window.notificationManager) {
                window.notificationManager.show('OTA upload cancelled', 'info');
            }
        }
        
        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Network Configuration Functions
        async function showNetworkConfig() {
            console.log('Network Configuration button clicked');
            
            // 直接加载网络配置，不再进行网关发现
            loadNetworkConfig();
            const modal = document.getElementById('networkConfigModal');
            modal.style.display = 'block';
            // 添加show类来触发CSS动画和正确显示
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        function closeNetworkConfigModal() {
            const modal = document.getElementById('networkConfigModal');
            modal.classList.remove('show');
            // 等待动画完成后隐藏模态框
            setTimeout(() => {
                modal.style.display = 'none';
            }, 400);
        }

        async function loadNetworkConfig() {
            try {
                // 从localStorage获取保存的网关地址
                const savedGatewayAddress = getSavedGatewayAddress();
                
                // 设置网关地址字段（默认为空或显示保存的地址）
                document.getElementById('gatewayAddress').value = savedGatewayAddress;
                
                // 如果有保存的网关地址，尝试从网关获取MQTT配置
                if (savedGatewayAddress) {
                    const gatewayUrl = getGatewayUrl();
                    const response = await fetch(`${gatewayUrl}/api/network_config`);
                    
                    if (response.ok) {
                        const config = await response.json();
                        console.log('Network config loaded:', config);
                        
                        // 填充MQTT设置 - 根据MQTT连接状态判断是否启用
                        const mqttEnabled = config.mqtt_connected || (config.mqtt_server && config.mqtt_server !== '');
                        document.getElementById('mqttEnabled').checked = mqttEnabled;
                        toggleMqttSettings(mqttEnabled);
                        
                        if (mqttEnabled) {
                            document.getElementById('mqttServer').value = config.mqtt_server || '192.168.1.250';
                            document.getElementById('mqttPort').value = config.mqtt_port || '1883';
                            document.getElementById('mqttUsername').value = config.mqtt_user || '';
                            document.getElementById('mqttPassword').value = config.mqtt_pass || '';
                        }
                    } else {
                        console.log('Could not load MQTT configuration from gateway');
                        setDefaultMqttValues();
                    }
                } else {
                    console.log('No gateway address saved, using default MQTT values');
                    setDefaultMqttValues();
                }
            } catch (error) {
                console.error('Failed to load network configuration:', error);
                // 即使加载失败，也要设置网关地址字段
                const savedGatewayAddress = getSavedGatewayAddress();
                document.getElementById('gatewayAddress').value = savedGatewayAddress;
                setDefaultMqttValues();
            }
        }
        
        function setDefaultValues() {
            // 设置默认值
            document.getElementById('gatewayAddress').value = getSavedGatewayAddress();
            setDefaultMqttValues();
        }
        
        function setDefaultMqttValues() {
            // 设置MQTT默认值
            document.getElementById('mqttServer').value = '192.168.1.250';
            document.getElementById('mqttPort').value = 1883;
        }

        function toggleMqttSettings(enabled) {
            const mqttSettings = document.getElementById('mqttSettings');
            mqttSettings.style.display = enabled ? 'block' : 'none';
        }

        // 保存网关配置（仅本地保存）
        function saveGatewayConfig() {
            console.log('saveGatewayConfig called');
            
            const newGatewayAddress = document.getElementById('gatewayAddress').value;
            
            if (!newGatewayAddress) {
                if (window.notificationManager) {
                    window.notificationManager.show('Please enter a gateway address', 'error');
                }
                return;
            }
            
            // 验证IP地址格式
            const ipPattern = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
            if (!ipPattern.test(newGatewayAddress)) {
                if (window.notificationManager) {
                    window.notificationManager.show('Please enter a valid IP address', 'error');
                }
                return;
            }
            
            // 直接使用localStorage保存网关地址
            localStorage.setItem('gateway_host', newGatewayAddress);
            console.log('Gateway address saved to localStorage:', newGatewayAddress);
            
            // 保存到localStorage
            localStorage.setItem('gateway_host', newGatewayAddress);
            
            if (window.notificationManager) {
                window.notificationManager.show('Gateway configuration saved locally', 'success');
            }
        }

        // 获取保存的网关地址
        function getSavedGatewayAddress() {
            return localStorage.getItem('gateway_host') || '';
        }

        // 获取WebSocket URL
        function getWebSocketUrl() {
            const savedAddress = getSavedGatewayAddress();
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            if (savedAddress) {
                return `${protocol}//${savedAddress}/ws`;
            }
            // 如果没有保存的地址，使用默认地址
            return `${protocol}//192.168.1.66/ws`;
        }

        // 获取网关URL
        function getGatewayUrl() {
            const savedHost = getSavedGatewayAddress();
            if (savedHost) {
                return `http://${savedHost}:80`;
            }
            // 如果没有保存的地址，使用默认地址
            return 'http://192.168.1.66:80';
        }

        // 保存MQTT配置（发送给网关）
        async function saveMqttConfig() {
            // 准备MQTT配置数据
            const mqttConfig = {
                mqttEnabled: document.getElementById('mqttEnabled').checked,
                mqttServer: document.getElementById('mqttServer').value,
                mqttPort: parseInt(document.getElementById('mqttPort').value) || 1883,
                mqttUsername: document.getElementById('mqttUsername').value,
                mqttPassword: document.getElementById('mqttPassword').value
            };

            try {
                // 使用本地保存的网关地址发送MQTT配置
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/network_config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(mqttConfig)
                });

                if (response.ok) {
                    if (window.notificationManager) {
                        window.notificationManager.show('MQTT configuration saved successfully', 'success');
                    }
                } else {
                    throw new Error('Failed to save MQTT configuration');
                }
            } catch (error) {
                console.error('Failed to save MQTT configuration:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('Failed to save MQTT configuration: ' + error.message, 'error');
                }
            }
        }

        // 保留原有的saveNetworkConfig函数以防其他地方调用
        async function saveNetworkConfig() {
            const newGatewayAddress = document.getElementById('gatewayAddress').value;
            
            // 1. 首先处理网关地址 - 只保存在本地，不发送给网关
            if (newGatewayAddress) {
                // 保存到localStorage
                localStorage.setItem('gateway_host', newGatewayAddress);
                console.log('Gateway address updated locally to:', newGatewayAddress);
            }
            
            // 2. 准备MQTT配置数据 - 只发送MQTT相关信息给网关
            const mqttConfig = {
                mqttEnabled: document.getElementById('mqttEnabled').checked,
                mqttServer: document.getElementById('mqttServer').value,
                mqttPort: parseInt(document.getElementById('mqttPort').value) || 1883,
                mqttUsername: document.getElementById('mqttUsername').value,
                mqttPassword: document.getElementById('mqttPassword').value
            };

            try {
                // 3. 发送MQTT配置给网关
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/network_config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(mqttConfig)
                });

                if (response.ok) {
                    if (window.notificationManager) {
                        window.notificationManager.show('Network configuration saved successfully', 'success');
                    }
                    closeNetworkConfigModal();
                } else {
                    throw new Error('Failed to save MQTT configuration');
                }
            } catch (error) {
                console.error('Failed to save network configuration:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('Failed to save network configuration: ' + error.message, 'error');
                }
            }
        }

        // MQTT checkbox change event
        document.addEventListener('DOMContentLoaded', function() {
            const mqttCheckbox = document.getElementById('mqttEnabled');
            if (mqttCheckbox) {
                mqttCheckbox.addEventListener('change', function() {
                    toggleMqttSettings(this.checked);
                });
            }
        });
    </script>
</body>
</html>