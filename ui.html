<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painless Mesh Gateway - Device Management</title>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    <!-- Coloris Color Picker - ‰ΩøÁî®ÂÜÖËÅîÂÆûÁé∞ -->
    <style>
        /* ÁÆÄÂåñÁöÑÈ¢úËâ≤ÈÄâÊã©Âô®Ê†∑Âºè */
        input[type="color"] {
            width: 40px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 3px;
        }
    </style>
    
    <script>
        // ÁÆÄÂåñÁöÑColorisÂÆûÁé∞
        window.Coloris = {
            init: function() {
                console.log('Coloris initialized (inline version)');
                return this;
            },
            
            open: function(input) {
                console.log('Opening color picker for:', input);
                if (input && input.click) {
                    input.click();
                }
                return this;
            },
            
            close: function() {
                console.log('Closing color picker');
                return this;
            }
        };
        
        // ÈÖçÁΩÆÂáΩÊï∞
        window.Coloris = function(options) {
            console.log('Configuring Coloris with options:', options);
            if (options && options.el) {
                const elements = document.querySelectorAll(options.el);
                console.log('Found', elements.length, 'elements for Coloris');
                elements.forEach((el, index) => {
                    console.log(`Element ${index}:`, el);
                    if (el.type !== 'color') {
                        el.type = 'color';
                    }
                    
                    if (options.onChange) {
                        el.addEventListener('input', function() {
                            console.log('Color changed:', this.value, 'for element:', this);
                            options.onChange(this.value, this);
                        });
                        
                        el.addEventListener('change', function() {
                            console.log('Color change event:', this.value, 'for element:', this);
                            options.onChange(this.value, this);
                        });
                    }
                });
            }
            return window.Coloris;
        };
        
        // ÈáçÊñ∞Ê∑ªÂä†ÊñπÊ≥ïÂà∞ÂáΩÊï∞ÂØπË±°
        window.Coloris.init = function() {
            console.log('Coloris initialized (inline version)');
            return this;
        };
        
        window.Coloris.open = function(input) {
            console.log('Opening color picker for:', input);
            if (input && input.click) {
                input.click();
            }
            return this;
        };
        
        window.Coloris.close = function() {
            console.log('Closing color picker');
            return this;
        };
        
        console.log('Coloris inline implementation loaded');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            .loading-message, .no-devices-message {
                text-align: center;
                padding: 40px 20px;
                color: #64748b;
                font-size: 16px;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #e2e8f0;
                border-top: 4px solid #3b82f6;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 16px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }

            .error-message {
                background: #fee2e2;
                border: 1px solid #fecaca;
                color: #dc2626;
                padding: 12px 16px;
                border-radius: 8px;
                margin: 16px 0;
                text-align: center;
            }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: transparent;
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .container {
            width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* ÁßªÂä®Á´ØÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1240px) {
            .container {
                width: 95%;
                margin: 0 auto;
            }
            
            body {
                padding: 10px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .navigation-tabs {
                margin: 0 20px 20px 20px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 14px;
                min-height: 44px; /* Â¢ûÂä†Ëß¶Êë∏ÁõÆÊ†áÂ§ßÂ∞è */
            }

            .main-content {
                padding: 20px;
            }

            .table-header {
                grid-template-columns: minmax(110px, 1.4fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(100px, 1fr) minmax(60px, 0.8fr) minmax(100px, 1fr);
                font-size: 12px;
            }

            .header-cell {
                padding: 15px 5px;
                font-size: 11px;
            }

            .table-row {
                grid-template-columns: minmax(110px, 1.4fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(100px, 1fr) minmax(60px, 0.8fr) minmax(100px, 1fr);
            }

            .table-cell {
                padding: 12px 5px;
                font-size: 13px;
            }

            .table-cell:first-child {
                padding-left: 10px;
            }

            .function-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .function-card {
                padding: 20px;
            }

            .functions-panel {
                padding: 20px;
            }

            /* ‰ºòÂåñÊåâÈíÆËß¶Êë∏‰ΩìÈ™å */
            .action-button {
                min-height: 44px;
                padding: 12px 16px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .container {
                width: 100%;
                border-radius: 0;
                margin: 0;
            }

            body {
                padding: 0;
            }

            .header {
                padding: 12px 15px;
                border-radius: 0;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .navigation-tabs {
                margin: 0 15px 15px 15px;
                border-radius: 6px;
            }

            .nav-tab {
                padding: 12px 15px;
                font-size: 13px;
                min-height: 48px; /* Êõ¥Â§ßÁöÑËß¶Êë∏ÁõÆÊ†á */
            }
            
            /* ‰ºòÂåñÊåâÈíÆËß¶Êë∏‰ΩìÈ™å */
            .action-btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 65px;
                min-height: 36px;
                margin: 1px;
            }
            
            .actions {
                gap: 3px;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
            }

            /* ‰ºòÂåñË°®Ê†ºÂçïÂÖÉÊ†ºÊòæÁ§∫ */
            .table-cell {
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                min-height: 40px;
                align-items: flex-start;
                flex-wrap: wrap;
                word-break: break-word;
            }

            /* ‰ºòÂåñËÆæÂ§áÂêçÁß∞ÊòæÁ§∫ */
            .device-name {
                max-width: none;
                white-space: normal;
                word-break: break-word;
            }

            .main-content {
                padding: 15px;
            }

            /* Ë°®Ê†ºÂú®Â∞èÂ±èÂπï‰∏äÁöÑ‰ºòÂåñ */
            .devices-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
            }

            .table-header {
                grid-template-columns: minmax(120px, 1.2fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(100px, 1fr) minmax(60px, 0.6fr) minmax(80px, 0.8fr) minmax(200px, 2fr);
                font-size: 11px;
                min-width: 710px;
            }

            .header-cell {
                padding: 15px 8px;
                font-size: 10px;
                white-space: nowrap;
            }

            .table-row {
                grid-template-columns: minmax(120px, 1.2fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(100px, 1fr) minmax(60px, 0.6fr) minmax(80px, 0.8fr) minmax(200px, 2fr);
                min-width: 710px;
            }

            .table-cell {
                padding: 12px 8px;
                font-size: 12px;
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                min-height: 40px;
                align-items: flex-start;
                flex-wrap: wrap;
            }

            .table-cell:first-child {
                padding-left: 12px;
            }

            /* ‰ºòÂåñËÆæÂ§áÂêçÁß∞ÊòæÁ§∫ */
            .device-name {
                font-weight: 600;
                max-width: none;
                overflow: visible;
                text-overflow: unset;
                white-space: normal;
                word-break: break-word;
            }

            /* ‰ºòÂåñÊåâÈíÆ */
            .action-btn {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 60px;
                min-height: 32px;
            }
            
            .actions {
                gap: 4px;
                flex-wrap: wrap;
                justify-content: center;
            }

            /* ÂäüËÉΩÈù¢Êùø‰ºòÂåñ */
            .function-card {
                padding: 20px 15px;
                margin-bottom: 15px;
            }

            .function-card h3 {
                font-size: 1.1rem;
                margin-bottom: 12px;
            }

            .function-card p {
                font-size: 14px;
                line-height: 1.5;
            }
        }

        /* Ë∂ÖÂ∞èÂ±èÂπï‰ºòÂåñ */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .nav-tab {
                padding: 10px 12px;
                font-size: 12px;
            }

            .table-header {
                grid-template-columns: minmax(90px, 1fr) minmax(70px, 0.8fr) minmax(60px, 0.7fr) minmax(80px, 0.9fr) minmax(50px, 0.6fr) minmax(70px, 0.8fr) minmax(150px, 1.5fr);
                min-width: 570px;
            }

            .table-row {
                grid-template-columns: minmax(90px, 1fr) minmax(70px, 0.8fr) minmax(60px, 0.7fr) minmax(80px, 0.9fr) minmax(50px, 0.6fr) minmax(70px, 0.8fr) minmax(150px, 1.5fr);
                min-width: 570px;
            }

            .action-btn {
                padding: 6px 8px;
                font-size: 11px;
                min-width: 50px;
                min-height: 30px;
                margin: 1px;
            }
            
            .actions {
                gap: 2px;
                flex-wrap: wrap;
                justify-content: center;
            }

            /* ‰ºòÂåñË°®Ê†ºÂçïÂÖÉÊ†ºÊòæÁ§∫ */
            .table-cell {
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
                min-height: 35px;
                align-items: flex-start;
                flex-wrap: wrap;
                word-break: break-word;
                font-size: 11px;
            }

            /* ‰ºòÂåñËÆæÂ§áÂêçÁß∞ÊòæÁ§∫ */
            .device-name {
                max-width: none;
                white-space: normal;
                word-break: break-word;
                font-size: 11px;
            }

             /* ÁßªÂä®Á´ØË°®Ê†ºÂ§¥ÈÉ®ÊñáÊú¨‰ºòÂåñ */
             .header-cell[data-sort="name"]::after {
                 content: " (Name)";
                 display: none;
             }
             
             .header-cell[data-sort="type"]::after {
                 content: " (Type)";
                 display: none;
             }
         }

        .actions {
                gap: 3px;
            }

            .action-btn {
                padding: 4px 6px;
                font-size: 10px;
                min-width: 35px;
            }

            .function-card {
                padding: 15px;
                margin-bottom: 10px;
            }

            .function-card h3 {
                font-size: 16px;
            }

            .function-card p {
                font-size: 13px;
            }

            .function-icon {
                font-size: 36px;
                margin-bottom: 10px;
            }

            .functions-panel {
                padding: 15px;
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4facfe 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            position: relative;
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
        }

        .logo {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            filter: invert(1);
        }

        .navigation-tabs {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 700;
            flex: 1;
        }

        .header .navigation-tabs {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: transparent;
            border-radius: 0;
            margin: 0;
            overflow: hidden;
            justify-content: center;
            width: 100%;
        }

        .header .nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border-radius: 6px;
            margin: 0 4px;
            flex: 1;
        }

        .header .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        .header .nav-tab.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff9ff3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transform: translateY(-1px);
        }

        .navigation-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4facfe 100%);
            padding: 0 40px 20px 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
        }

        .navigation-tabs {
            display: flex;
            background: transparent;
            border-radius: 8px;
            margin: 0;
            overflow: hidden;
            justify-content: center;
        }

        .nav-tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #ccc;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border-radius: 6px;
            margin: 0 4px;
            flex: 1;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff9ff3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transform: translateY(-1px);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .connection-status .status-indicator {
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .main-content {
            padding: 30px;
        }

        .navigation-tabs {
            display: flex;
            border-radius: 8px;
            margin: 0 0px 30px 0px;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: #888;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }

        .nav-tab.active {
            background: #213353;
            color: white;
        }

        /* ÂèØÊéíÂ∫èË°®Ê†ºÊ†áÈ¢òÊ†∑Âºè */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .sortable:hover {
            background-color: rgba(255, 107, 107, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .sort-arrow {
            margin-left: 5px;
            font-size: 10px;
            color: #adb5bd;
            transition: all 0.3s ease;
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 6px solid currentColor;
            vertical-align: middle;
            transform-origin: center bottom;
        }

        .sortable[data-direction="asc"] .sort-arrow {
            color: #4facfe;
            transform: rotateX(0deg);
        }

        .sortable[data-direction="desc"] .sort-arrow {
            color: #4facfe;
            transform: rotateX(180deg);
        }

        .color-preview {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 15px;
            vertical-align: middle;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .color-preview:hover {
            transform: scale(1.05);
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .color-preview::after {
            content: 'üé®';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .color-preview:hover::after {
            opacity: 0.8;
        }
        
        .color-input-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .color-input-container input[type="color"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }

        .color-input-container input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #495057;
            min-width: 100px;
        }
        
        .button-container {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .cancel-button {
            background-color: #f1f1f1;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .save-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .cancel-button:hover {
            background-color: #e0e0e0;
        }
        
        .save-button:hover {
            background-color: #45a049;
        }

        .sortable[data-direction="none"] .sort-arrow {
            color: #adb5bd;
            transform: rotateX(0deg);
        }

        .functions-panel {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .functions-panel h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }

        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .function-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .function-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #4F4F4F;
        }

        .function-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .function-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .function-card p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .function-btn {
            background: #4F4F4F;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .function-btn:hover {
            background: #363636;
            transform: translateY(-1px);
        }

        /* Á°ÆËÆ§ÂºπÁ™óÊ†∑Âºè */
        .confirmation-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .confirmation-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .confirmation-dialog {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 35px;
            max-width: 480px;
            width: 90%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: scale(0.8) translateY(30px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
            overflow: hidden;
        }

        .confirmation-dialog::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #6f42c1);
            border-radius: 20px 20px 0 0;
        }

        .confirmation-modal.show .confirmation-dialog {
            transform: scale(1) translateY(0);
        }

        .confirmation-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .confirmation-icon {
            font-size: 36px;
            margin-right: 16px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .confirmation-icon.delete {
            color: #dc3545;
        }

        .confirmation-icon.rediscovery {
            color: #ffc107;
        }

        .confirmation-title {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .confirmation-message {
            color: #495057;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 28px;
            font-weight: 400;
        }

        .device-info {
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px;
            padding: 18px;
            margin: 18px 0;
            border-left: 4px solid #007bff;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .device-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }

        .device-info-item:last-child {
            margin-bottom: 0;
        }

        .device-info-label {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .device-info-value {
            color: #2c3e50;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .confirmation-buttons {
            display: flex;
            gap: 14px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        .confirmation-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 100px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .confirmation-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .confirmation-btn:hover::before {
            left: 100%;
        }

        .confirmation-btn.cancel {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .confirmation-btn.cancel:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
        }

        .confirmation-btn.confirm {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .confirmation-btn.confirm:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
        }

        .confirmation-btn.confirm.rediscovery {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }

        .confirmation-btn.confirm.rediscovery:hover {
            background: linear-gradient(135deg, #e0a800, #d39e00);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #657786;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e1e8ed;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .filter-btn:hover {
            border-color: #4facfe;
            color: #4facfe;
        }

        .filter-btn.active {
            background: #4facfe;
            border-color: #4facfe;
            color: white;
        }

        .devices-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            overflow: hidden;
        }

        .table-header {
            display: grid;
            grid-template-columns: minmax(140px, 1.5fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(120px, 1.2fr) minmax(60px, 0.6fr) minmax(70px, 0.8fr) minmax(160px, 1.8fr);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #4facfe 100%);
            color: white;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: gradientShift 6s ease-in-out infinite;
        }

        .header-cell {
            padding: 15px 8px;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white !important;
            word-wrap: break-word;
            overflow: hidden;
        }

        .header-cell:first-child {
            justify-content: flex-start;
            padding-left: 12px;
        }

        .table-row {
            display: grid;
            grid-template-columns: minmax(140px, 1.5fr) minmax(80px, 0.8fr) minmax(70px, 0.7fr) minmax(120px, 1.2fr) minmax(60px, 0.6fr) minmax(70px, 0.8fr) minmax(160px, 1.8fr);
            border-bottom: 1px solid #e1e8ed;
            transition: all 0.3s ease;
        }

        .table-row:hover {
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .table-cell {
            padding: 12px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #2c3e50;
            text-align: center;
            word-wrap: break-word;
            overflow: visible;
            min-height: 40px;
        }

        .table-cell:first-child {
            justify-content: flex-start;
            padding-left: 12px;
        }

        .table-cell .actions {
            width: 100%;
            justify-content: center;
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .header-cell {
            padding: 20px;
            font-size: 13px;
        }

        .device-name {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .device-icon {
            font-size: 18px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-indicator.connected {
            background-color: #2ed573;
        }

        .status-indicator.disconnected {
            background-color: #ff4757;
        }

        .status-text {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            text-transform: uppercase;
        }

        .status-text.online {
            color: #2ed573;
            background-color: rgba(46, 213, 115, 0.1);
        }

        .status-text.offline {
            color: #ff4757;
            background-color: rgba(255, 71, 87, 0.1);
        }

        .auto-discovery {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
        }

        .auto-discovery.enabled {
            color: #2ed573;
        }

        .auto-discovery.disabled {
            color: #ff4757;
        }

        .actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
            min-width: 50px;
            margin: 1px;
        }

        .action-btn.primary {
            background: #007bff;
            color: white;
        }

        #systemContainer, #actionsContainer {
            display: none;
            padding: 20px;
        }

        .system-card, .action-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .system-card h3, .action-card h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .restart-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .restart-btn:hover {
            background: #c82333;
        }

        .restart-btn:active {
            background: #bd2130;
        }

        .add-action-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 0;
        }

        .add-action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5em 1em;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            height: auto;
            line-height: 1.2;
            margin: 0 auto;
        }

        .add-action-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .add-action-btn:active {
            background: #004085;
            transform: translateY(0);
        }

        .add-icon {
            font-size: 20px;
            font-weight: bold;
        }

        /* Actions list styles */
        .actions-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
        }

        .action-card {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            width: 250px;
            height: 190px;
            display: flex;
            flex-direction: column;
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .action-card-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .action-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-card-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .action-card-btn.edit {
            background: #28a745;
            color: white;
        }

        .action-card-btn.edit:hover {
            background: #218838;
        }

        .action-card-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-card-btn.execute:hover {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 233, 123, 0.4);
        }

        .action-card-btn.edit:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .action-card-btn.delete:hover {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        /* Action card actions container */
        .action-card-actions {
            padding: 10px 15px;
            background-color: #f5f5f5;
            display: flex;
            justify-content: space-between;
            margin-top: 0;
            border-bottom-left-radius: inherit;
            border-bottom-right-radius: inherit;
        }

        .action-card-btn.execute {
            flex: 1;
            margin-right: 5px;
            background-color: #2F4F4F;
            color: white;
            transition: all 0.3s ease;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .action-card-btn.edit {
            flex: 1;
            margin: 0 5px;
            background-color: #28a745;
            color: white;
            transition: all 0.3s ease;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .action-card-btn.delete {
            flex: 1;
            margin-left: 5px;
            background-color: #dc3545;
            color: white;
            transition: all 0.3s ease;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        /* Action card header styles */
        .action-card-header {
            background: linear-gradient(135deg, #FF6A6A 0%, #FF4757 50%, #FF3742 100%) !important;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 10px 15px;
            margin: 0;
            width: 100%;
            box-sizing: border-box;
            border-top-left-radius: inherit;
            border-top-right-radius: inherit;
            position: relative;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
            animation: gradientShift 6s ease-in-out infinite;
        }

        .action-name-left {
            font-weight: bold;
            font-size: 16px;
            color: white !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Device action icons styles */
        .device-action-icon {
            cursor: pointer;
            margin-left: 8px;
            font-size: 18px;
            color: #667eea;
            transition: all 0.3s ease;
            padding: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .device-action-icon:hover {
            transform: scale(1.3);
        }

        .device-action-icon[title="Êü•Áúã"] {
            color: #4facfe;
        }

        .device-action-icon[title="Êü•Áúã"]:hover {
            color: #2196f3;
        }

        .device-action-icon[title="ÊâßË°å"] {
            color: #43e97b;
        }

        .device-action-icon[title="ÊâßË°å"]:hover {
            color: #00c851;
        }

        /* Font Awesome icon specific styles */
        .device-action-icon i {
            font-size: 16px;
            line-height: 1;
        }

        /* Modal styles for Add Action */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
        }

        .close-modal {
            color: #6c757d;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: #dc3545;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background-color: #ffffff;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }

        /* Network Configuration Modal Styles */
        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .config-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .form-checkbox {
            width: auto !important;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .config-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .staged-command {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            margin-bottom: 5px;
            font-size: 12px; /* ÂáèÂ∞èÂ≠ó‰ΩìÂ§ßÂ∞è */
        }

        .staged-command span {
            font-size: 12px; /* ËÆæÂ§áÂêçÂíåÂëΩ‰ª§Â≠ó‰ΩìÂ§ßÂ∞è */
            color: #333;
        }

        .staged-command-buttons {
            display: flex;
            gap: 5px;
        }

        .staged-command-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 45px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .staged-command-edit {
            background-color: #17a2b8;
            color: white;
        }

        .staged-command-edit:hover {
            background-color: #138496;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
        }

        .staged-command-delete {
            background-color: #dc3545;
            color: white;
        }

        .staged-command-delete:hover {
            background-color: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
        }

        .modal-button {
            margin-left: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            background-color: #FF8247;
            color: white;
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .modal-button:hover {
            background-color: #FF6B1A;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 130, 71, 0.3);
        }

        .cancel-button {
            background-color: #f44336;
            color: white;
        }

        .cancel-button:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }

        .modal-footer button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }

        .action-btn.secondary:hover {
            background: #545b62;
        }

        .action-btn.danger {
            background: #dc3545;
            color: white;
        }

        .action-btn.danger:hover {
            background: #c82333;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #657786;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .devices-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                flex-direction: column;
                gap: 15px;
        }
    }

    /* Ê∂àÊÅØÊèêÁ§∫ÂºπÁ™óÊ†∑Âºè */
    #notificationContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        max-width: 420px;
        pointer-events: none;
    }

    .notification {
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 12px;
        opacity: 0;
        transform: translateX(100%) scale(0.95);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: auto;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(10px);
        position: relative;
    }

    .notification::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #007bff, #0056b3);
        border-radius: 16px 16px 0 0;
    }

    .notification.show {
        opacity: 1;
        transform: translateX(0) scale(1);
    }

    .notification.success::before {
        background: linear-gradient(90deg, #28a745, #20c997);
    }

    .notification.warning::before {
        background: linear-gradient(90deg, #ffc107, #fd7e14);
    }

    .notification.error::before {
        background: linear-gradient(90deg, #dc3545, #e83e8c);
    }

    .notification.info::before {
        background: linear-gradient(90deg, #17a2b8, #6f42c1);
    }

    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        background: rgba(255, 255, 255, 0.5);
    }

    .notification-title {
        display: flex;
        align-items: center;
        font-weight: 600;
        font-size: 15px;
        color: #2c3e50;
        letter-spacing: -0.02em;
    }

    .notification-icon {
        margin-right: 10px;
        font-size: 18px;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
    }

    .notification.success .notification-icon {
        color: #28a745;
    }

    .notification.warning .notification-icon {
        color: #ffc107;
    }

    .notification.error .notification-icon {
        color: #dc3545;
    }

    .notification.info .notification-icon {
        color: #17a2b8;
    }

    .notification-close {
        background: rgba(255, 255, 255, 0.8);
        border: none;
        font-size: 16px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .notification-close:hover {
        background: rgba(248, 249, 250, 0.95);
        color: #495057;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .notification-message {
        padding: 12px 20px 16px;
        color: #495057;
        font-size: 14px;
        line-height: 1.5;
        font-weight: 400;
    }

    .notification-progress {
        height: 4px;
        background: rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
        border-radius: 0 0 16px 16px;
    }

    .notification-progress::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background: inherit;
        animation: progressSlide 3s linear forwards;
        border-radius: 0 0 16px 16px;
    }

    @keyframes progressSlide {
        from {
            transform: translateX(0);
        }
        to {
            transform: translateX(-100%);
        }
    }

    .notification.success .notification-progress {
        background: linear-gradient(90deg, rgba(40, 167, 69, 0.3), rgba(32, 201, 151, 0.3));
    }

    .notification.warning .notification-progress {
        background: linear-gradient(90deg, rgba(255, 193, 7, 0.3), rgba(253, 126, 20, 0.3));
    }

    .notification.error .notification-progress {
        background: linear-gradient(90deg, rgba(220, 53, 69, 0.3), rgba(232, 62, 140, 0.3));
    }

    .notification.info .notification-progress {
        background: linear-gradient(90deg, rgba(23, 162, 184, 0.3), rgba(111, 66, 193, 0.3));
    }

    /* Ê∂àÊÅØÊèêÁ§∫ÂºπÁ™óÊ†∑Âºè - Â∑≤Âà†Èô§ */
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 8% auto; 
            padding: 35px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            width: 85%; 
            max-width: 600px;
            border-radius: 20px !important;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 8px 32px rgba(0, 0, 0, 0.12);
            transform: scale(0.8) translateY(30px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #6f42c1);
            border-radius: 20px 20px 0 0;
        }

        .modal.show .modal-content {
            transform: scale(1) translateY(0);
        }

        .close-button {
            color: #6c757d;
            float: right;
            font-size: 24px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.8);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: -10px -10px 0 0;
        }

        .close-button:hover,
        .close-button:focus {
            color: #495057;
            background: rgba(248, 249, 250, 0.95);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-decoration: none;
            cursor: pointer;
        }

        /* Command Examples Styles */
        .command-examples {
            margin-top: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .command-examples p {
            margin: 0 0 10px 0;
            font-weight: 600;
            color: #495057;
        }

        .example-section {
            margin-bottom: 15px;
        }

        .example-section:last-child {
            margin-bottom: 0;
        }

        .example-section p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }

        .example-tag {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .example-tag:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .example-tag:active {
            transform: translateY(0);
        }

        /* System Monitor Styles */
        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .info-section h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .info-item .label {
            font-weight: 500;
            color: #6c757d;
            flex: 1;
        }

        .info-item .value {
            font-weight: 600;
            color: #495057;
            text-align: right;
            flex: 1;
        }

        .status-online {
            color: #28a745 !important;
        }

        .status-offline {
            color: #dc3545 !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }
    </style>
</head>
<body>
    <!-- Ê∂àÊÅØÊèêÁ§∫ÂÆπÂô® -->
    <div id="notificationContainer"></div>
    
    <div class="container">
        <div class="header">
              <div class="title-container">
                  <img src="logo.svg" alt="logo" class="logo"><h1>Painless Mesh Gateway</h1>
              </div>
              <div class="navigation-tabs">
                <button class="nav-tab active" onclick="switchTab('devices')">Devices</button>
                  <button class="nav-tab" onclick="switchTab('actions')">Actions</button>
                <button class="nav-tab" onclick="switchTab('functions')">Functions</button>
            </div>
        </div>

        <div class="main-content">

            <div class="stats-bar" style="display: none;">
                <div class="stat-item">
                    <div class="stat-number" id="totalDevices">6</div>
                    <div class="stat-label">Total Devices</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="onlineDevices">4</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="offlineDevices">2</div>
                    <div class="stat-label">Offline</div>
                </div>
            </div>

            <div id="devicesContainer">
                <div class="devices-table">
                    <div class="table-header">
                        <div class="table-cell header-cell sortable" data-sort="name">
                            Device Name
                            <span class="sort-arrow" data-direction="none"></span>
                        </div>
                        <div class="table-cell header-cell sortable" data-sort="type">
                            Type
                            <span class="sort-arrow" data-direction="none"></span>
                        </div>
                        <div class="table-cell header-cell">Node ID</div>
                        <div class="table-cell header-cell">MAC Address</div>
                        <div class="table-cell header-cell sortable" data-sort="status">
                            Status
                            <span class="sort-arrow" data-direction="none"></span>
                        </div>
                        <div class="table-cell header-cell sortable" data-sort="discovery">
                            Discovery
                            <span class="sort-arrow" data-direction="none"></span>
                        </div>
                        <div class="table-cell header-cell">Actions</div>
                    </div>
                    
                <!-- Device rows will be dynamically populated here -->
                <div id="loading-message" class="loading-message" style="display: none;">
                    <div class="loading-spinner"></div>
                    <span>Loading devices from gateway...</span>
                </div>
                <div id="no-devices-message" class="no-devices-message" style="display: none;">
                    <span>No devices found. Make sure the gateway is running and devices are connected.</span>
                </div>
                </div>
            </div>

            <div id="actionsContainer" style="display: none;">
                <div class="actions-panel">
                    <div class="add-action-container">
                        <button class="add-action-btn" onclick="addAction()">
                            <span class="add-icon">+</span>
                            Add Action
                        </button>
                    </div>
                    <div id="actionsList" class="actions-list">
                        <!-- Action cards will be dynamically loaded here -->
                        <div class="loading-message" id="actions-loading">
                            <div class="loading-spinner"></div>
                            <span>Loading actions...</span>
                        </div>
                        <div class="no-actions-message" id="no-actions-message" style="display: none;">
                            <span>No actions found. Create a new action using the Add Action button.</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="functionsContainer" style="display: none;">
                <div class="functions-panel">
                    <h2>System Functions</h2>
                    <div class="function-grid">
                        <div class="function-card">
                            <div class="function-icon">üîß</div>
                            <h3>Network Configuration</h3>
                            <p>Configure mesh network settings and parameters</p>
                            <button class="function-btn">Configure</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">üìä</div>
                            <h3>System Monitor</h3>
                            <p>Monitor system performance and network statistics</p>
                            <button class="function-btn">Monitor</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">üîÑ</div>
                            <h3>Firmware Update</h3>
                            <p>Update firmware for connected devices</p>
                            <button class="function-btn">Update</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">üìù</div>
                            <h3>System Logs</h3>
                            <p>View and manage system logs and events</p>
                            <button class="function-btn">View Logs</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">‚öôÔ∏è</div>
                            <h3>Device Settings</h3>
                            <p>Configure global device settings and policies</p>
                            <button class="function-btn">Settings</button>
                        </div>
                        <div class="function-card">
                            <div class="function-icon">üîí</div>
                            <h3>Security</h3>
                            <p>Manage security settings and access control</p>
                            <button class="function-btn">Security</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Á°ÆËÆ§ÂºπÁ™ó -->
    <div id="confirmationModal" class="confirmation-modal">
        <div class="confirmation-dialog">
            <div class="confirmation-header">
                <div id="confirmationIcon" class="confirmation-icon">‚ö†Ô∏è</div>
                <h3 id="confirmationTitle" class="confirmation-title">Confirm Action</h3>
            </div>
            <div id="confirmationMessage" class="confirmation-message">
                Are you sure you want to perform this action?
            </div>
            <div id="deviceInfo" class="device-info" style="display: none;">
                <div class="device-info-item">
                    <span class="device-info-label">Device Name:</span>
                    <span id="deviceName" class="device-info-value">-</span>
                </div>
                <div class="device-info-item">
                    <span class="device-info-label">Device Type:</span>
                    <span id="confirmationDeviceType" class="device-info-value">-</span>
                </div>
                <div class="device-info-item">
                    <span class="device-info-label">MAC Address:</span>
                    <span id="deviceMac" class="device-info-value">-</span>
                </div>
                <div class="device-info-item">
                    <span class="device-info-label">Status:</span>
                    <span id="deviceStatus" class="device-info-value">-</span>
                </div>
            </div>
            <div class="confirmation-buttons">
                <button id="cancelBtn" class="confirmation-btn cancel">Cancel</button>
                <button id="confirmBtn" class="confirmation-btn confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ===== Ë∞ÉËØïÂ∑•ÂÖ∑ÂáΩÊï∞ =====
        window.DebugLogger = {
            enabled: true, // ÂèØ‰ª•ÈÄöËøáÊéßÂà∂Âè∞ËÆæÁΩÆ window.DebugLogger.enabled = false Êù•ÂÖ≥Èó≠Ë∞ÉËØï
            
            logApiRequest: function(url, method, data = null) {
                if (!this.enabled) return;
                console.group(`üîµ API Request: ${method} ${url}`);
                console.log('Timestamp:', new Date().toISOString());
                console.log('URL:', url);
                console.log('Method:', method);
                if (data) {
                    console.log('Request Data:', data);
                }
                console.groupEnd();
            },
            
            logApiResponse: function(url, method, response, data = null) {
                if (!this.enabled) return;
                const status = response.status;
                const statusIcon = status >= 200 && status < 300 ? '‚úÖ' : '‚ùå';
                
                console.group(`${statusIcon} API Response: ${method} ${url} (${status})`);
                console.log('Timestamp:', new Date().toISOString());
                console.log('Status:', status, response.statusText);
                console.log('Headers:', Object.fromEntries(response.headers.entries()));
                if (data) {
                    console.log('Response Data:', data);
                    console.log('Data Type:', typeof data);
                    console.log('Data Length:', Array.isArray(data) ? data.length : 
                                              typeof data === 'string' ? data.length : 
                                              typeof data === 'object' ? Object.keys(data).length : 'N/A');
                }
                console.groupEnd();
            },
            
            logApiError: function(url, method, error) {
                if (!this.enabled) return;
                console.group(`üî¥ API Error: ${method} ${url}`);
                console.log('Timestamp:', new Date().toISOString());
                console.error('Error:', error);
                console.log('Error Type:', error.constructor.name);
                console.log('Error Message:', error.message);
                if (error.stack) {
                    console.log('Stack Trace:', error.stack);
                }
                console.groupEnd();
            }
        };
        
        // Â¢ûÂº∫fetchÂáΩÊï∞ÔºåËá™Âä®Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
        const originalFetch = window.fetch;
        window.fetch = async function(url, options = {}) {
            const method = options.method || 'GET';
            
            // ËÆ∞ÂΩïËØ∑Ê±Ç
            window.DebugLogger.logApiRequest(url, method, options.body);
            
            try {
                const response = await originalFetch(url, options);
                
                // ÂÖãÈöÜÂìçÂ∫î‰ª•‰æøÂ§öÊ¨°ËØªÂèñ
                const responseClone = response.clone();
                
                // Â∞ùËØïËß£ÊûêÂìçÂ∫îÊï∞ÊçÆ
                let responseData = null;
                try {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        responseData = await responseClone.json();
                    } else {
                        responseData = await responseClone.text();
                    }
                } catch (parseError) {
                    console.warn('Failed to parse response data:', parseError);
                }
                
                // ËÆ∞ÂΩïÂìçÂ∫î
                window.DebugLogger.logApiResponse(url, method, response, responseData);
                
                return response;
            } catch (error) {
                // ËÆ∞ÂΩïÈîôËØØ
                window.DebugLogger.logApiError(url, method, error);
                throw error;
            }
        };
        
        class DemoDeviceManager {
            constructor() {
            // console.log('DeviceManager: constructor called');
            this.devices = [];
            this.filteredDevices = [];
            this.currentFilter = 'all';
            this.searchTerm = '';
            this.refreshInterval = null;
            this.refreshRate = 5000; // 5ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
            this.gatewayUrl = getGatewayUrl(); // Gateway IP from project rules
            this.previousDevices = []; // Áî®‰∫éË∑üË∏™ËÆæÂ§áÁä∂ÊÄÅÂèòÂåñ
            this.ws = null; // WebSocketËøûÊé•
            this.isInitialLoad = true; // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÂàùÂßãÂä†ËΩΩ
            this.isSilentLoad = false; // Ê†áËÆ∞ÊòØÂê¶‰∏∫ÈùôÈªòÂä†ËΩΩ
            this.hasLoadedOnce = false; // Ê†áËÆ∞ÊòØÂê¶Â∑≤ÁªèÂä†ËΩΩËøá‰∏ÄÊ¨°
            
            // Ê∑ªÂä†ÊéíÂ∫èÁä∂ÊÄÅ‰øùÊåÅ
            this.currentSortBy = 'name'; // ÈªòËÆ§ÊåâÂêçÁß∞ÊéíÂ∫è
            this.currentSortOrder = 'desc'; // ÈªòËÆ§ÈôçÂ∫èÔºàÂêë‰∏äÁÆ≠Â§¥Ë°®Á§∫ÈôçÂ∫èÔºâ
            
            this.init();
        }

        init() {
            this.initializeEventListeners();
            this.initializeWebSocket();
            // ‰∏çÂú®ËøôÈáåÁ´ãÂç≥Âä†ËΩΩËÆæÂ§áÔºåÁ≠âWebSocketËøûÊé•Âª∫Á´ãÂêéÂÜçÂä†ËΩΩ
            this.startAutoRefresh();
        }

        initializeWebSocket() {
            try {
                const wsUrl = getWebSocketUrl();
                console.log('Connecting to WebSocket:', wsUrl);
                
                this.ws = new WebSocket(wsUrl);
                this.setupWebSocketHandlers();
            } catch (error) {
                console.error('WebSocket connection failed:', error);
                this.showErrorMessage(`Failed to connect to gateway at ${this.gatewayUrl}. Please check if the gateway is running and accessible.`);
            }
        }

        setupWebSocketHandlers() {
            this.ws.onopen = () => {
                console.log('WebSocket connected');
                // WebSocketËøûÊé•Âª∫Á´ãÂêéÁ´ãÂç≥ËØ∑Ê±ÇËÆæÂ§áÂàóË°®ÔºàÈùôÈªòÊ®°ÂºèÔºåÈÅøÂÖçÂàùÂßãÈÄöÁü•Ôºâ
                this.loadDevicesFromGateway(true);
            };

            this.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                } catch (error) {
                    console.error('Failed to parse WebSocket message:', error);
                }
            };

            this.ws.onclose = () => {
                console.log('WebSocket disconnected');
                // Â∞ùËØïÈáçËøû
                setTimeout(() => {
                    this.initializeWebSocket();
                }, 5000);
            };

            this.ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        handleWebSocketMessage(data) {
            // console.log('DeviceManager: handleWebSocketMessage received:', data);
            switch (data.type) {
                case 'devices_list':
                    // Â§ÑÁêÜËÆæÂ§áÂàóË°®Êõ¥Êñ∞
                    if (data.devices) {
                        const wasSilent = this.isSilentLoad; // ‰øùÂ≠òÈùôÈªòÁä∂ÊÄÅ
                        this.updateDevicesFromWebSocket(data.devices, wasSilent);
                        this.hideLoadingMessage();
                        this.isSilentLoad = false; // ÈáçÁΩÆÈùôÈªòÊ†áËÆ∞
                    }
                    break;
                case 'device_list':
                    // Â§ÑÁêÜËÆæÂ§áÂàóË°®Êõ¥Êñ∞ÔºàÂÖºÂÆπÊóßÊ†ºÂºèÔºâ
                    if (data.devices) {
                        const wasSilent = this.isSilentLoad; // ‰øùÂ≠òÈùôÈªòÁä∂ÊÄÅ
                        this.updateDevicesFromWebSocket(data.devices, wasSilent);
                        this.hideLoadingMessage();
                        this.isSilentLoad = false; // ÈáçÁΩÆÈùôÈªòÊ†áËÆ∞
                    }
                    break;
                case 'device_status':
                    // Â§ÑÁêÜÂçï‰∏™ËÆæÂ§áÁä∂ÊÄÅÊõ¥Êñ∞
                    this.handleDeviceStatusUpdate(data);
                    break;
                case 'rediscovery_response':
                    // Â§ÑÁêÜrediscoveryÂìçÂ∫î
                    this.handleRediscoveryResponse(data);
                    break;
                case 'delete_device_response':
                    // Â§ÑÁêÜÂà†Èô§ËÆæÂ§áÂìçÂ∫î
                    this.handleDeleteDeviceResponse(data);
                    break;
                case 'device_deleted':
                    // Â§ÑÁêÜËÆæÂ§áÂà†Èô§ÂπøÊí≠Ê∂àÊÅØ
                    this.handleDeviceDeleted(data);
                    break;
                default:
                    console.log('Unknown WebSocket message type:', data.type);
            }
        }

        updateDevicesFromWebSocket(devices, silent = false) {
            // console.log(`DeviceManager: updateDevicesFromWebSocket called. Silent: ${silent}, isInitialLoad: ${this.isInitialLoad}, hasLoadedOnce: ${this.hasLoadedOnce}`);
            // È¶ñÊ¨°Âä†ËΩΩÊó∂ÔºåÂè™‰øùÂ≠òËÆæÂ§áÁä∂ÊÄÅÔºå‰∏çÊ£ÄÊµãÂèòÂåñÔºå‰∏çÊòæÁ§∫ÈÄöÁü•
            if (!this.hasLoadedOnce) {
                this.hasLoadedOnce = true;
                this.previousDevices = JSON.parse(JSON.stringify(devices));
                this.isInitialLoad = false;
                // È¶ñÊ¨°Âä†ËΩΩÊó∂‰∏çË∞ÉÁî®detectDeviceChangesÔºåÁõ¥Êé•Ë∑≥ËøáÈÄöÁü•ÈÄªËæë
            } else if (!silent) {
                // ÈùûÈ¶ñÊ¨°Âä†ËΩΩ‰∏îÈùûÈùôÈªòÊ®°ÂºèÊó∂ÊâçÊ£ÄÊµãËÆæÂ§áÂèòÂåñ
                this.detectDeviceChanges(devices, false);
            } else {
                // ÈùôÈªòÊ®°Âºè‰∏ãÂè™Êõ¥Êñ∞previousDevicesÔºå‰∏çÊ£ÄÊµãÂèòÂåñ
                this.detectDeviceChanges(devices, true);
            }
            
            this.devices = devices.map(device => ({
                name: device.name || 'Unknown Device',
                macAddress: device.macAddress || device.mac || 'Unknown MAC',
                type: device.type || 'Unknown',
                isOnline: device.isOnline || device.online || false,
                nodeId: device.nodeId || 0,
                hasBeenDiscovered: device.hasBeenDiscovered || false,
                lastSeenTimestamp: device.lastSeenTimestamp || 0,
                // ‰øùÁïôÂéüÂßãËÆæÂ§áÊï∞ÊçÆ‰ª•‰æõÂÖ∂‰ªñÂäüËÉΩ‰ΩøÁî®
                ...device
            }));
            
            // Â∫îÁî®ÂΩìÂâçÁöÑÊéíÂ∫èËÆæÁΩÆ
            this.sortDevices(this.currentSortBy, this.currentSortOrder);
            
            this.renderDevices();
            this.updateStats();
            
            // console.log('Devices updated from WebSocket:', this.devices.length);
        }

        handleDeviceStatusUpdate(data) {
            // console.log('Handling device status update:', data);
            
            // Âú®ÂàùÂßãÂä†ËΩΩÈò∂ÊÆµÔºå‰∏çÂ§ÑÁêÜËÆæÂ§áÁä∂ÊÄÅÊõ¥Êñ∞ÈÄöÁü•
            if (!this.hasLoadedOnce || this.isInitialLoad) {
                console.log('Skipping notifications during initial load');
                return;
            }
            
            // Êõ¥Êñ∞ÁâπÂÆöËÆæÂ§áÁöÑÁä∂ÊÄÅ
            const deviceIndex = this.devices.findIndex(d => d.macAddress === data.mac);
            if (deviceIndex !== -1) {
                const oldDevice = JSON.parse(JSON.stringify(this.devices[deviceIndex])); // ‰øùÂ≠òÊóßÁä∂ÊÄÅ
                
                // Êõ¥Êñ∞ËÆæÂ§áÁöÑÂú®Á∫øÁä∂ÊÄÅ
                if (data.hasOwnProperty('online')) {
                    this.devices[deviceIndex].isOnline = data.online;
                }
                
                // Êõ¥Êñ∞ËÆæÂ§áÁöÑdiscoveryÁä∂ÊÄÅ
                if (data.hasOwnProperty('hasBeenDiscovered')) {
                    this.devices[deviceIndex].hasBeenDiscovered = data.hasBeenDiscovered;
                }
                
                // Ê†πÊçÆstatusÂ≠óÊÆµËøõË°åÁâπÂÆöÂ§ÑÁêÜÂíåÈÄöÁü•
                if (data.status === 'online') {
                    this.devices[deviceIndex].isOnline = true;
                    notificationManager.showDeviceOnline(this.devices[deviceIndex].name, data.mac);
                } else if (data.status === 'offline') {
                    this.devices[deviceIndex].isOnline = false;
                    notificationManager.showDeviceOffline(this.devices[deviceIndex].name, data.mac);
                } else if (data.status === 'discovered') {
                    this.devices[deviceIndex].hasBeenDiscovered = true;
                    notificationManager.showAutoDiscoveryEnabled(this.devices[deviceIndex].name, data.mac);
                } else if (data.status === 'rediscovery_initiated') {
                    this.devices[deviceIndex].hasBeenDiscovered = false;
                    notificationManager.showAutoDiscoveryDisabled(this.devices[deviceIndex].name, data.mac);
                } else if (data.status === 'led_status_update') {
                    // Â§ÑÁêÜLEDÁä∂ÊÄÅÊõ¥Êñ∞
                    if (data.ledConfig) {
                        // console.log('Updating LED config for device:', this.devices[deviceIndex].name, data.ledConfig);
                        // Êõ¥Êñ∞ËÆæÂ§áÁöÑLEDÈÖçÁΩÆ‰ø°ÊÅØ
                        this.devices[deviceIndex].ledConfig = data.ledConfig;
                        
                        // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®ÊòæÁ§∫ËØ•ËÆæÂ§áÁöÑLEDÈÖçÁΩÆÊ®°ÊÄÅÊ°ÜÔºåÁ´ãÂç≥Êõ¥Êñ∞ÊòæÁ§∫
                        if (currentDeviceMac === data.mac && document.getElementById('ledConfigModal').style.display === 'block') {
                            const onColorValue = rgbToHex(data.ledConfig.onColor);
                            const offColorValue = rgbToHex(data.ledConfig.offColor);
                            
                            document.getElementById('onColor').value = onColorValue;
                            document.getElementById('offColor').value = offColorValue;
                            document.getElementById('onColorPreview').style.backgroundColor = onColorValue;
                            document.getElementById('offColorPreview').style.backgroundColor = offColorValue;
                            
                            document.getElementById('brightness_on').value = data.ledConfig.brightnessOn ?? 255;
                            document.getElementById('brightness_off').value = data.ledConfig.brightnessOff ?? 0;
                            document.getElementById('isDaytime').value = data.ledConfig.isDaytime ? 'Yes' : 'No';
                            document.getElementById('daylightThreshold').value = data.ledConfig.daylightThreshold ?? data.ledConfig.daylightThresholdLx ?? 0;
                            
                            // Êõ¥Êñ∞‰∫ÆÂ∫¶ÂÄºÊòæÁ§∫
                            updateBrightnessValue('brightness_on', 'brightness_on_value');
                            updateBrightnessValue('brightness_off', 'brightness_off_value');
                            
                            // Êõ¥Êñ∞ÂÖ≥ËÅî‰º†ÊÑüÂô®ÈÄâÊã©
                            const linkedSensorSelect = document.getElementById('linkedSensor');
                            if (data.ledConfig.linkedSensor) {
                                linkedSensorSelect.value = data.ledConfig.linkedSensor;
                            }
                        }
                        
                        // ÊòæÁ§∫LEDÁä∂ÊÄÅÊõ¥Êñ∞ÈÄöÁü•
                        notificationManager.show(`LED configuration updated for ${this.devices[deviceIndex].name}`, 'info');
                    }
                }
                
                // Â∫îÁî®ÂΩìÂâçÁöÑÊéíÂ∫èËÆæÁΩÆ
                this.sortDevices(this.currentSortBy, this.currentSortOrder);
                
                this.renderDevices();
            } else {
                // Â¶ÇÊûúÊòØÊñ∞ËÆæÂ§áÔºåÂèØËÉΩÈúÄË¶ÅÈáçÊñ∞Âä†ËΩΩËÆæÂ§áÂàóË°®
                // console.log('Device not found in current list, may be a new device');
                // Âè™ÊúâÂú®ÈùûÂàùÂßãÂä†ËΩΩ‰∏îÂ∑≤Âä†ËΩΩËøá‰∏ÄÊ¨°ÂêéÊâçÊòæÁ§∫Êñ∞ËÆæÂ§áÂèëÁé∞ÈÄöÁü•
                if (this.hasLoadedOnce && !this.isInitialLoad) {
                    notificationManager.showDeviceDiscovered('New Device', data.mac);
                }
            }
        }

        handleRediscoveryResponse(data) {
            if (data.status === 'success') {
                // ÈáçÊñ∞ÂèëÁé∞ÊàêÂäüÈÄöÁü•Â∑≤Âà†Èô§
            } else {
                // ÈáçÊñ∞ÂèëÁé∞Â§±Ë¥•ÈÄöÁü•Â∑≤Âà†Èô§
            }
        }

        handleDeleteDeviceResponse(data) {
            if (data.status === 'success') {
                // ËÆæÂ§áÂà†Èô§ÊàêÂäüÈÄöÁü•Â∑≤Âà†Èô§
                // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
                this.loadDevicesFromGateway(true);
            } else {
                // ËÆæÂ§áÂà†Èô§Â§±Ë¥•ÈÄöÁü•Â∑≤Âà†Èô§
            }
        }

        handleDeviceDeleted(data) {
            // Â§ÑÁêÜËÆæÂ§áÂà†Èô§ÂπøÊí≠Ê∂àÊÅØÔºå‰ªéÊú¨Âú∞ÂàóË°®‰∏≠ÁßªÈô§ËÆæÂ§á
            const deviceIndex = this.devices.findIndex(d => d.macAddress === data.macAddress);
            if (deviceIndex !== -1) {
                this.devices.splice(deviceIndex, 1);
                this.renderDevices();
                this.updateStats();
                // console.log(`Device ${data.deviceName} removed from local list`);
            }
        }

        sendWebSocketMessage(message) {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify(message));
                return true;
            } else {
                console.error('WebSocket is not connected');
                return false;
            }
        }

        startAutoRefresh() {
            // Ê∏ÖÈô§Áé∞ÊúâÁöÑÂÆöÊó∂Âô®
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
            }
            
            // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®
            this.refreshInterval = setInterval(() => {
                // Âè™ÊúâÂú®WebSocketËøûÊé•ÂèØÁî®Êó∂ÊâçÂä†ËΩΩËÆæÂ§á
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.loadDevicesFromGateway(true); // ÈùôÈªòÂà∑Êñ∞
                }
            }, this.refreshRate);
        }

        stopAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
                this.refreshInterval = null;
            }
        }

            initializeEventListeners() {
                // ÁßªÈô§ÊêúÁ¥¢ÂíåËøáÊª§ÂäüËÉΩÁõ∏ÂÖ≥ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            }

            async loadDevicesFromGateway(silent = false) {
                // console.log(`DeviceManager: loadDevicesFromGateway called. Silent: ${silent}, isInitialLoad: ${this.isInitialLoad}, hasLoadedOnce: ${this.hasLoadedOnce}`);
                try {
                    if (!silent) {
                        this.showLoadingMessage();
                    }
                    
                    // ËÆæÁΩÆÈùôÈªòÂä†ËΩΩÊ†áËÆ∞
                    this.isSilentLoad = silent;
                    
                    // ‰ΩøÁî®WebSocketËØ∑Ê±ÇËÆæÂ§áÂàóË°®
                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const message = {
                            type: 'get_devices'
                        };
                        
                        // ÂèëÈÄÅWebSocketÊ∂àÊÅØËØ∑Ê±ÇËÆæÂ§áÂàóË°®
                        this.ws.send(JSON.stringify(message));
                        
                        if (!silent) {
                            // console.log('Device list request sent via WebSocket');
                        }
                    } else {
                        throw new Error('WebSocket connection not available');
                    }
                    
                } catch (error) {
                    console.error('Error loading devices:', error);
                    this.hideLoadingMessage(); // Á°Æ‰øùÈöêËóèÂä†ËΩΩÊ∂àÊÅØ
                    if (!silent) {
                        this.showErrorMessage(`Failed to connect to gateway at ${this.gatewayUrl}. Please check if the gateway is running and accessible.`);
                        // ËøûÊé•ÈîôËØØÈÄöÁü•Â∑≤Âà†Èô§
                    }
                }
            }

            detectDeviceChanges(newDevices, wasSilent = false) {
                // Â¶ÇÊûúËøòÊ≤°ÊúâÂä†ËΩΩËøáÔºåÊàñËÄÖÊòØÈùôÈªòÂä†ËΩΩÔºå‰∏çÊòæÁ§∫ÈÄöÁü•
                if (!this.hasLoadedOnce || this.previousDevices.length === 0 || wasSilent) {
                    this.previousDevices = JSON.parse(JSON.stringify(newDevices));
                    return;
                }

                // ÂàõÂª∫ËÆæÂ§áÊò†Â∞Ñ‰ª•‰æøÂø´ÈÄüÊü•Êâæ
                const previousMap = new Map();
                const newMap = new Map();
                
                this.previousDevices.forEach(device => {
                    // ‰ΩøÁî®macAddressÂ±ûÊÄßÔºå‰∏éÊ∏≤Êüì‰øùÊåÅ‰∏ÄËá¥
                    previousMap.set(device.macAddress, device);
                });
                
                newDevices.forEach(device => {
                    // ‰ΩøÁî®macAddressÂ±ûÊÄßÔºå‰∏éÊ∏≤Êüì‰øùÊåÅ‰∏ÄËá¥
                    newMap.set(device.macAddress, device);
                });

                // Ê£ÄÊµãÊñ∞ËÆæÂ§á - Âè™ÊúâÂú®ÈùûÈùôÈªòÊ®°Âºè‰∏îÂ∑≤Âä†ËΩΩËøá‰∏ÄÊ¨°ÂêéÊâçÊòæÁ§∫ÈÄöÁü•
                if (!wasSilent && this.hasLoadedOnce) {
                    newDevices.forEach(device => {
                        if (!previousMap.has(device.macAddress)) {
                            notificationManager.showDeviceDiscovered(device.name, device.macAddress);
                        }
                    });

                    // Ê£ÄÊµãËÆæÂ§áÁä∂ÊÄÅÂèòÂåñ
                    this.previousDevices.forEach(prevDevice => {
                        const currentDevice = newMap.get(prevDevice.macAddress);
                        if (currentDevice) {
                            // Ê£ÄÊµãÂú®Á∫øÁä∂ÊÄÅÂèòÂåñ
                            if (prevDevice.isOnline !== currentDevice.isOnline) {
                                if (currentDevice.isOnline) {
                                    notificationManager.showDeviceOnline(currentDevice.name, currentDevice.macAddress);
                                } else {
                                    notificationManager.showDeviceOffline(currentDevice.name, currentDevice.macAddress);
                                }
                            }

                            // Ê£ÄÊµãËá™Âä®ÂèëÁé∞Áä∂ÊÄÅÂèòÂåñ
                            if (prevDevice.hasBeenDiscovered !== currentDevice.hasBeenDiscovered) {
                                if (currentDevice.hasBeenDiscovered) {
                                    // Ëá™Âä®ÂèëÁé∞ÂêØÁî®ÈÄöÁü•Â∑≤Âà†Èô§
                                } else {
                                    // Ëá™Âä®ÂèëÁé∞Á¶ÅÁî®ÈÄöÁü•Â∑≤Âà†Èô§
                                }
                            }
                        }
                    });
                }

                // Êõ¥Êñ∞‰πãÂâçÁöÑËÆæÂ§áÁä∂ÊÄÅ
                this.previousDevices = JSON.parse(JSON.stringify(newDevices));
            }

            hideLoadingMessage() {
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
            }

            showLoadingMessage() {
                // ‰∏çÊòæÁ§∫Âä†ËΩΩÊ∂àÊÅØ
                return;
            }

            showErrorMessage(message) {
                const container = document.querySelector('.devices-table');
                if (container) {
                    container.innerHTML = `
                        <div class="error-message" style="display: block; margin: 20px; padding: 20px; background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; border-radius: 8px; text-align: center; font-size: 16px;">
                            <div><strong>Error:</strong> ${message}</div>
                        </div>
                    `;
                } else {
                    console.error('Error:', message);
                    // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂÆπÂô®ÔºåÂ∞ùËØïÂú®‰∏ªÂÆπÂô®‰∏≠ÊòæÁ§∫
                    const mainContainer = document.querySelector('#devicesContainer');
                    if (mainContainer) {
                        mainContainer.innerHTML = `
                            <div class="error-message" style="display: block; margin: 20px; padding: 20px; background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; border-radius: 8px; text-align: center; font-size: 16px;">
                                <div><strong>Error:</strong> ${message}</div>
                            </div>
                        `;
                    }
                }
            }

            getDeviceIcon(type) {
                const icons = {
                    'MultiSwitch': 'üí°',
                    'EnvSensor': 'üå°Ô∏è',
                    'ServoController': '‚öôÔ∏è',
                    'PIR_Sensor': 'üëÅÔ∏è',
                    'Contact_Sensor': 'üö™'
                };
                return icons[type] || 'üì±';
            }

            getDeviceActions(type, mac) {
                const actions = [];
                
                // Ê†πÊçÆËÆæÂ§áÁ±ªÂûãÊ∑ªÂä†ÁâπÂÆöÁöÑÊìç‰ΩúÊåâÈíÆ
                switch (type) {
                    case 'MultiSwitch':
                    case 'SmartSocket':
                        actions.push(`<button class="action-btn primary configure-btn" data-mac="${mac}">Configure</button>`);
                        break;
                    case 'EnvSensor':
                    case 'PIR_Sensor':
                        // Contact_Sensor ÁöÑ Read Data ÊåâÈíÆÂ∑≤Âà†Èô§
                        if (type !== 'Contact_Sensor') {
                            actions.push(`<button class="action-btn primary" onclick="handleDeviceAction('read', '${mac}')">Read Data</button>`);
                        }
                        break;
                    // ServoController ÁöÑ Move ÊåâÈíÆÂ∑≤Âà†Èô§
                    case 'ServoController':
                        // ‰∏çÊ∑ªÂä† Move ÊåâÈíÆ
                        break;
                }
                
                // ÊâÄÊúâËÆæÂ§áÈÉΩÊúâÁöÑÈÄöÁî®ÊåâÈíÆ
                actions.push(`<button class="action-btn secondary" onclick="handleDeviceAction('rediscovery', '${mac}')">Rediscovery</button>`);
                actions.push(`<button class="action-btn danger" onclick="handleDeviceAction('delete', '${mac}')">Delete</button>`);
                
                return actions.join('');
            }

            renderDevices() {
                const container = document.querySelector('.devices-table');
                if (!container) {
                    console.error('Devices table container not found');
                    return;
                }
                
                // ÈöêËóèÂä†ËΩΩÊ∂àÊÅØ
                this.hideLoadingMessage();
                
                // Clear existing device rows (but keep header and messages)
                const existingRows = container.querySelectorAll('.table-row:not(.table-header)');
                existingRows.forEach(row => row.remove());

                if (this.devices.length === 0) {
                    const noDevicesMsg = document.getElementById('no-devices-message');
                    if (noDevicesMsg) {
                        noDevicesMsg.style.display = 'block';
                    }
                    return;
                } else {
                    const noDevicesMsg = document.getElementById('no-devices-message');
                    if (noDevicesMsg) {
                        noDevicesMsg.style.display = 'none';
                    }
                }

                this.devices.forEach(device => {
                    const statusClass = device.isOnline ? 'online' : 'offline';
                    const discoveryIcon = device.hasBeenDiscovered ? '‚úì' : '‚úó';
                    const discoveryClass = device.hasBeenDiscovered ? 'enabled' : 'disabled';

                    const deviceRow = document.createElement('div');
                    deviceRow.className = `table-row ${statusClass}`;
                    deviceRow.setAttribute('data-type', device.type);
                    deviceRow.setAttribute('data-status', statusClass);
                    deviceRow.setAttribute('data-name', device.name.toLowerCase());
                    deviceRow.setAttribute('data-mac', device.macAddress.toLowerCase());
                    deviceRow.setAttribute('data-nodeid', device.nodeId);
                    deviceRow.setAttribute('data-discovered', device.hasBeenDiscovered);

                    deviceRow.innerHTML = `
                        <div class="table-cell">
                            <div class="device-name">
                                ${device.name}
                            </div>
                        </div>
                        <div class="table-cell">${device.type || 'Unknown'}</div>
                        <div class="table-cell">${device.nodeId}</div>
                        <div class="table-cell">${device.macAddress}</div>
                        <div class="table-cell">
                            <span class="status-indicator ${device.isOnline ? 'connected' : 'disconnected'}"></span>
                        </div>
                        <div class="table-cell">
                            <span class="auto-discovery ${discoveryClass}">${discoveryIcon}</span>
                        </div>
                        <div class="table-cell">
                            <div class="actions">
                                ${this.getDeviceActions(device.type, device.macAddress)}
                            </div>
                        </div>
                    `;

                    container.appendChild(deviceRow);
                });

                this.updateStats();
                
                // Êõ¥Êñ∞ÂÖ®Â±ÄËÆæÂ§áÊï∞ÊçÆÔºå‰æõÂÖ∂‰ªñÂäüËÉΩ‰ΩøÁî®
                window.devicesData = this.devices;
                
                // Êõ¥Êñ∞Ë°®Ê†ºÊ†áÈ¢òÁöÑÊéíÂ∫èÁä∂ÊÄÅÊòæÁ§∫
                updateHeaderStates();
            }

            updateStats() {
                const totalDevices = this.devices.length;
                const onlineDevices = this.devices.filter(d => d.isOnline).length;
                const offlineDevices = totalDevices - onlineDevices;

                document.getElementById('totalDevices').textContent = totalDevices;
                document.getElementById('onlineDevices').textContent = onlineDevices;
                document.getElementById('offlineDevices').textContent = offlineDevices;
            }
        }

        // Device action handler
        function handleDeviceAction(action, deviceMac) {
            console.log(`Action: ${action} for device: ${deviceMac}`);
            
            switch (action) {
                case 'toggle':
                    // Toggle device functionality
                    break;
                case 'configure':
                    // Open configuration for device
                    break;
                case 'rediscovery':
                    showConfirmationModal('rediscovery', deviceMac);
                    break;
                case 'delete':
                    showConfirmationModal('delete', deviceMac);
                    break;
                case 'read':
                    // Read sensor data from device
                    break;
                case 'move':
                    // Move servo on device
                    break;
                case 'ping':
                    // Attempt to reconnect device
                    break;
                default:
                    console.log(`Unknown action: ${action}`);
            }
        }

        // ÊòæÁ§∫Á°ÆËÆ§ÂºπÁ™ó
        function showConfirmationModal(action, deviceMac) {
            const device = window.deviceManager.devices.find(d => d.macAddress === deviceMac);
            if (!device) {
                // ËÆæÂ§áÊú™ÊâæÂà∞ÈÄöÁü•Â∑≤Âà†Èô§
                return;
            }

            const modal = document.getElementById('confirmationModal');
            const icon = document.getElementById('confirmationIcon');
            const title = document.getElementById('confirmationTitle');
            const message = document.getElementById('confirmationMessage');
            const deviceInfo = document.getElementById('deviceInfo');
            const confirmBtn = document.getElementById('confirmBtn');

            // Â°´ÂÖÖËÆæÂ§á‰ø°ÊÅØ
            document.getElementById('deviceName').textContent = device.name;
            document.getElementById('deviceType').textContent = device.type;
            document.getElementById('deviceMac').textContent = device.macAddress;
            document.getElementById('deviceStatus').textContent = device.isOnline ? 'Online' : 'Offline';

            if (action === 'delete') {
                icon.textContent = 'üóëÔ∏è';
                icon.className = 'confirmation-icon delete';
                title.textContent = 'Delete Device';
                message.textContent = 'Are you sure you want to delete this device? This action cannot be undone and will remove the device from the system permanently.';
                confirmBtn.textContent = 'Delete';
                confirmBtn.className = 'confirmation-btn confirm';
                confirmBtn.onclick = () => {
                    hideConfirmationModal();
                    handleDeleteDevice(deviceMac);
                };
            } else if (action === 'rediscovery') {
                icon.textContent = 'üîÑ';
                icon.className = 'confirmation-icon rediscovery';
                title.textContent = 'Rediscover Device';
                message.textContent = 'Are you sure you want to initiate rediscovery for this device? This will refresh the device configuration and may temporarily interrupt its operation.';
                confirmBtn.textContent = 'Rediscover';
                confirmBtn.className = 'confirmation-btn confirm rediscovery';
                confirmBtn.onclick = () => {
                    hideConfirmationModal();
                    handleRediscovery(deviceMac);
                };
            }

            deviceInfo.style.display = 'block';
            modal.classList.add('show');

            // ËÆæÁΩÆÂèñÊ∂àÊåâÈíÆ
            document.getElementById('cancelBtn').onclick = hideConfirmationModal;

            // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠ÂºπÁ™ó
            modal.onclick = (e) => {
                if (e.target === modal) {
                    hideConfirmationModal();
                }
            };
        }

        // ÈöêËóèÁ°ÆËÆ§ÂºπÁ™ó
        function hideConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('show');
        }

        // Handle delete device action
        function handleDeleteDevice(deviceMac) {
            // Ê†πÊçÆMACÂú∞ÂùÄÊâæÂà∞ËÆæÂ§áÂêçÁß∞
            const device = window.deviceManager.devices.find(d => d.macAddress === deviceMac);
            if (!device) {
                // ËÆæÂ§áÊú™ÊâæÂà∞ÈÄöÁü•Â∑≤Âà†Èô§
                return;
            }

            // ÂèëÈÄÅWebSocketÊ∂àÊÅØÂà†Èô§ËÆæÂ§á
            const message = {
                type: 'delete_device',
                deviceName: device.name,
                macAddress: device.macAddress
            };

            if (window.deviceManager.sendWebSocketMessage(message)) {
                // Âà†Èô§ËÆæÂ§áËøõÂ∫¶ÈÄöÁü•Â∑≤Âà†Èô§
            } else {
                // WebSocketËøûÊé•‰∏çÂèØÁî®ÈÄöÁü•Â∑≤Âà†Èô§
            }
        }

        // Handle rediscovery action
        function handleRediscovery(deviceMac) {
            // Ê†πÊçÆMACÂú∞ÂùÄÊâæÂà∞ËÆæÂ§áÂêçÁß∞
            const device = window.deviceManager.devices.find(d => d.macAddress === deviceMac);
            if (!device) {
                // ËÆæÂ§áÊú™ÊâæÂà∞ÈÄöÁü•Â∑≤Âà†Èô§
                return;
            }

            // ÂèëÈÄÅWebSocketÊ∂àÊÅØ
            const message = {
                type: 'rediscovery',
                deviceName: device.name
            };

            if (window.deviceManager.sendWebSocketMessage(message)) {
                // ÈáçÊñ∞ÂèëÁé∞ËøõÂ∫¶ÈÄöÁü•Â∑≤Âà†Èô§
            } else {
                // WebSocketËøûÊé•‰∏çÂèØÁî®ÈÄöÁü•Â∑≤Âà†Èô§
            }
        }

        // Initialize the device manager when the page loads
        let currentDeviceMac = null;
        let currentDeviceNodeId = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            function rgbToHex(rgb) {
                if (!rgb || typeof rgb.r === 'undefined') return '#000000';
                return "#" + ((1 << 24) + (rgb.r << 16) + (rgb.g << 8) + rgb.b).toString(16).slice(1).toUpperCase();
            }

            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            // ÈÄöÁü•ÁÆ°ÁêÜÂô®Â∑≤Âà†Èô§
            
            // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®
            window.addEventListener('beforeunload', () => {
                if (window.deviceManager) {
                    window.deviceManager.stopAutoRefresh();
                }
            });

            // È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñÊó∂ÊéßÂà∂Âà∑Êñ∞
            document.addEventListener('visibilitychange', () => {
                if (window.deviceManager) {
                    if (document.hidden) {
                        window.deviceManager.stopAutoRefresh();
                    } else {
                        window.deviceManager.startAutoRefresh();
                        // È°µÈù¢ÈáçÊñ∞ÂèØËßÅÊó∂Á´ãÂç≥Âà∑Êñ∞‰∏ÄÊ¨°ÔºàÂè™ÊúâÂú®WebSocketËøûÊé•ÂèØÁî®Êó∂Ôºâ
                        if (window.deviceManager.ws && window.deviceManager.ws.readyState === WebSocket.OPEN) {
                            window.deviceManager.loadDevicesFromGateway(true);
                        }
                    }
                }
            });

            // ÂàùÂßãÂåñËÆæÂ§áÁÆ°ÁêÜÂô®
            window.deviceManager = new DemoDeviceManager();

            const ledConfigModal = document.getElementById('ledConfigModal');
            const saveButton = document.getElementById('saveLedConfig');
            const cancelButton = document.getElementById('cancelLedConfig');
            const closeButton = document.querySelector('.close-button');

            // ÁªëÂÆöÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
            if (closeButton) {
                closeButton.onclick = function() {
                    closeModal();
                }
            }

            // Êõ¥Êñ∞È¢úËâ≤È¢ÑËßàÂáΩÊï∞
            function updateColorPreview(inputId, previewId) {
                console.log(`updateColorPreview called: inputId=${inputId}, previewId=${previewId}`);
                const colorInput = document.getElementById(inputId);
                const previewElement = document.getElementById(previewId);
                
                if (!colorInput) {
                    console.error(`Color input element not found: ${inputId}`);
                    return;
                }
                
                if (!previewElement) {
                    console.error(`Preview element not found: ${previewId}`);
                    return;
                }
                
                const colorValue = colorInput.value;
                console.log(`Setting color ${colorValue} for preview ${previewId}`);
                previewElement.style.backgroundColor = colorValue;
            }
            
            // Êõ¥Êñ∞‰∫ÆÂ∫¶ÂÄºÊòæÁ§∫
            function updateBrightnessValue(inputId, valueId) {
                const value = document.getElementById(inputId).value;
                document.getElementById(valueId).textContent = `(${value})`;
            }
            
            document.getElementById('brightness_on').addEventListener('input', function() {
                updateBrightnessValue('brightness_on', 'brightness_on_value');
            });
            
            document.getElementById('brightness_off').addEventListener('input', function() {
                updateBrightnessValue('brightness_off', 'brightness_off_value');
            });

            document.querySelector('.devices-table').addEventListener('click', (event) => {
                if (event.target.classList.contains('configure-btn')) {
                    currentDeviceMac = event.target.dataset.mac;
                    const device = window.deviceManager.devices.find(d => d.macAddress === currentDeviceMac);
                    if (device) {
                        currentDeviceNodeId = device.nodeId;
                        const onColorValue = rgbToHex(device.ledConfig?.onColor);
                        const offColorValue = rgbToHex(device.ledConfig?.offColor);
                        
                        document.getElementById('onColor').value = onColorValue;
                        document.getElementById('offColor').value = offColorValue;
                        document.getElementById('onColorPreview').style.backgroundColor = onColorValue;
                        document.getElementById('offColorPreview').style.backgroundColor = offColorValue;
                        
                        document.getElementById('brightness_on').value = device.ledConfig?.brightnessOn ?? device.config?.brightness_on ?? 255;
                        document.getElementById('brightness_off').value = device.ledConfig?.brightnessOff ?? device.config?.brightness_off ?? 0;
                        document.getElementById('isDaytime').value = device.ledConfig?.isDaytime ? 'Yes' : 'No';
                        document.getElementById('daylightThreshold').value = device.ledConfig?.daylightThreshold ?? device.ledConfig?.daylightThresholdLx ?? device.config?.daylightThreshold ?? 0;
                        
                        // Êõ¥Êñ∞‰∫ÆÂ∫¶ÂÄºÊòæÁ§∫
                        updateBrightnessValue('brightness_on', 'brightness_on_value');
                        updateBrightnessValue('brightness_off', 'brightness_off_value');

                        const linkedSensorSelect = document.getElementById('linkedSensor');
                        linkedSensorSelect.innerHTML = ''; // Clear previous options
                        const envSensors = window.deviceManager.devices.filter(d => d.type === 'Env_Sensor');
                        envSensors.forEach(sensor => {
                            const option = document.createElement('option');
                            option.value = sensor.name;
                            option.textContent = sensor.name;
                            if (sensor.name === (device.ledConfig?.linkedSensorName ?? device.config?.linkedSensor ?? device.linkedEnvSensorName)) {
                                option.selected = true;
                            }
                            linkedSensorSelect.appendChild(option);
                        });
                    }
                    // ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÂπ∂Ê∑ªÂä†Âä®ÁîªÊïàÊûú
                    ledConfigModal.style.display = 'block';
                    setTimeout(() => {
                        ledConfigModal.classList.add('show');
                    }, 10);
                }
            });

            window.onclick = function(event) {
                if (event.target == ledConfigModal) {
                    closeModal();
                }
            }
            
            cancelButton.onclick = function() {
                closeModal();
            }

            // Ê∑ªÂä†ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÁöÑÂáΩÊï∞
            function closeModal() {
                ledConfigModal.classList.remove('show');
                setTimeout(() => {
                    ledConfigModal.style.display = 'none';
                }, 400); // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
            }

            saveButton.onclick = function() {
                const message = {
                    type: 'mesh_command',
                    mac: currentDeviceMac,
                    payload: {
                        cmd: 'configLed',
                        to: currentDeviceNodeId,
                        payload: {
                            led_on_color: hexToRgb(document.getElementById('onColor').value),
                            led_off_color: hexToRgb(document.getElementById('offColor').value),
                            brightness_on: parseInt(document.getElementById('brightness_on').value, 10),
                            brightness_off: parseInt(document.getElementById('brightness_off').value, 10),
                            linked_env_sensor_name: document.getElementById('linkedSensor').value,
                            daylight_threshold_lx: parseInt(document.getElementById('daylightThreshold').value, 10)
                        }
                    }
                };

                window.deviceManager.sendWebSocketMessage(message);
                closeModal();
            };

            // ÁªëÂÆöË°®Â§¥ÁÇπÂáª‰∫ã‰ª∂
            const sortableHeaders = document.querySelectorAll('.sortable');
            sortableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const sortBy = header.getAttribute('data-sort');
                    handleHeaderClick(sortBy);
                });
            });
            
            // ÂàùÂßãÂåñË°®Ê†ºÊ†áÈ¢òÁöÑÊéíÂ∫èÁä∂ÊÄÅ
            setTimeout(() => {
                if (window.deviceManager) {
                    updateHeaderStates();
                }
            }, 100);
        });

        // Ê†áÁ≠æÂàáÊç¢ÂäüËÉΩ
        function switchTab(tabName) {
            // Êõ¥Êñ∞Ê†áÁ≠æÊ†∑Âºè
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Âä®ÊÄÅË∞ÉÊï¥ÂØºËà™Ê†áÁ≠æÂÆΩÂ∫¶
            updateNavTabWidths();

            // ÂàáÊç¢È°µÈù¢ÂÜÖÂÆπ
            const devicesContainer = document.getElementById('devicesContainer');
            const actionsContainer = document.getElementById('actionsContainer');
            const functionsContainer = document.getElementById('functionsContainer');

            // ÈöêËóèÊâÄÊúâÂÆπÂô®
            devicesContainer.style.display = 'none';
            actionsContainer.style.display = 'none';
            functionsContainer.style.display = 'none';

            // ÊòæÁ§∫ÂØπÂ∫îÁöÑÂÆπÂô®
            if (tabName === 'devices') {
                devicesContainer.style.display = 'block';
            } else if (tabName === 'actions') {
                actionsContainer.style.display = 'block';
                loadActions(); // Âä†ËΩΩactionsÊï∞ÊçÆ
            } else if (tabName === 'functions') {
                functionsContainer.style.display = 'block';
            }
        }

        // Âä®ÊÄÅË∞ÉÊï¥ÂØºËà™Ê†áÁ≠æÂÆΩÂ∫¶ÁöÑÂáΩÊï∞
        function updateNavTabWidths() {
            // ‰ΩøÁî®CSS flexÂ∏ÉÂ±ÄËá™Âä®Â§ÑÁêÜÂÆΩÂ∫¶ÂàÜÈÖçÔºåÊó†ÈúÄJavaScriptÂπ≤È¢Ñ
            console.log('Navigation tabs width updated automatically via CSS flex');
        }

        // Âä†ËΩΩActionsÊï∞ÊçÆÁöÑÂáΩÊï∞
        async function loadActions() {
            try {
                // ‰ΩøÁî®CONFIG‰∏≠ÁöÑÁΩëÂÖ≥URL
                const gatewayUrl = getGatewayUrl();
                console.log('ËØ∑Ê±ÇURL:', `${gatewayUrl}/api/actions`);
                
                const response = await fetch(`${gatewayUrl}/api/actions`);
                console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                console.log('ÂìçÂ∫îÂ§¥:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Ëé∑ÂèñÂìçÂ∫îÊñáÊú¨Âπ∂ÊâìÂç∞
                const responseText = await response.text();
                console.log('APIÂìçÂ∫îÂÜÖÂÆπ:', responseText);
                console.log('ÂìçÂ∫îÈïøÂ∫¶:', responseText.length);
                console.log('ÂìçÂ∫îÁ±ªÂûã:', typeof responseText);
                
                // Ê£ÄÊü•ÂìçÂ∫îÊòØÂê¶‰∏∫Á©∫
                if (!responseText || responseText.trim() === '') {
                    console.error('Êî∂Âà∞Á©∫ÂìçÂ∫î');
                    notificationManager.show('Êî∂Âà∞Á©∫ÂìçÂ∫î', 'error');
                    return;
                }
                
                // Â¶ÇÊûúÂìçÂ∫îÊòØÁ©∫Êï∞ÁªÑÁöÑÊñáÊú¨Ë°®Á§∫ÔºåÁõ¥Êé•ÊòæÁ§∫Á©∫ÂàóË°®
                if (responseText.trim() === '[]') {
                    displayActions([]);
                    return;
                }
                
                // Â§ÑÁêÜÊñáÊú¨Ê†ºÂºèÁöÑÂìçÂ∫î (Ê†ºÂºè: actionName:actionData\nactionName2:actionData2)
                if (responseText.includes(':') && !responseText.startsWith('[') && !responseText.startsWith('{')) {
                    try {
                        // Â∞ÜÊñáÊú¨ÂìçÂ∫îËΩ¨Êç¢‰∏∫JSONÊï∞ÁªÑ
                        const lines = responseText.split('\n');
                        const actions = [];
                        
                        for (const line of lines) {
                            if (line.trim() === '') continue;
                            
                            const [actionName, actionData] = line.split(':', 2);
                            if (actionName && actionData) {
                                try {
                                    // Ëß£ÊûêÊØè‰∏™actionÁöÑJSONÊï∞ÊçÆ
                                    const actionObj = JSON.parse(actionData);
                                    // Ê∑ªÂä†actionÂêçÁß∞
                                    actionObj.name = actionName;
                                    actions.push(actionObj);
                                } catch (parseErr) {
                                    console.error(`Ëß£ÊûêactionÊï∞ÊçÆÂ§±Ë¥•: ${actionName}`, parseErr);
                                }
                            }
                        }
                        
                        console.log('ËΩ¨Êç¢ÂêéÁöÑactionsÊï∞ÁªÑ:', actions);
                        displayActions(actions);
                        return;
                    } catch (conversionErr) {
                        console.error('ËΩ¨Êç¢ÊñáÊú¨ÂìçÂ∫îÂ§±Ë¥•:', conversionErr);
                    }
                }
                
                // Â∞ùËØïËß£ÊûêJSON (Â¶ÇÊûúÊòØJSONÊ†ºÂºè)
                try {
                    if (responseText.trim().startsWith('[') || responseText.trim().startsWith('{')) {
                        console.log('Â∞ùËØïËß£ÊûêJSONÂìçÂ∫î...');
                        const actions = JSON.parse(responseText);
                        console.log('JSONËß£ÊûêÊàêÂäüÔºåactionsÊï∞ÊçÆ:', actions);
                        console.log('actionsÊï∞ÁªÑÈïøÂ∫¶:', actions.length);
                        displayActions(actions);
                        return;
                    } else {
                        console.log('ÂìçÂ∫î‰∏çÊòØJSONÊ†ºÂºèÔºåË∑≥ËøáJSONËß£Êûê');
                    }
                } catch (parseError) {
                    console.error('JSONËß£ÊûêÈîôËØØ:', parseError);
                    console.error('Ëß£ÊûêÂ§±Ë¥•ÁöÑÂÜÖÂÆπ:', responseText);
                }
                
                // Â¶ÇÊûúÊâÄÊúâËß£ÊûêÊñπÊ≥ïÈÉΩÂ§±Ë¥•ÔºåÊòæÁ§∫ÂéüÂßãÂìçÂ∫î
                document.getElementById('actionsContainer').innerHTML = 
                    `<div class="alert alert-info">Êî∂Âà∞ÂìçÂ∫î: ${responseText}</div>`;
                notificationManager.show('ÊàêÂäüÊé•Êî∂Âà∞ÂìçÂ∫îÔºå‰ΩÜÊ†ºÂºèÊó†Ê≥ïËß£Êûê', 'warning');
            } catch (error) {
                console.error('Error loading actions:', error);
                notificationManager.show('Failed to load actions', 'error');
            }
        }

        // ÊòæÁ§∫ActionsÂç°ÁâáÁöÑÂáΩÊï∞
        function displayActions(actions) {
            const actionsList = document.getElementById('actionsList');
            const loadingElement = document.getElementById('actions-loading');
            const noActionsMessage = document.getElementById('no-actions-message');
            
            // Â∞ÜactionsÊï∞ÊçÆÂ≠òÂÇ®Âà∞localStorage‰∏≠Ôºå‰ª•‰æøÂêéÁª≠‰ΩøÁî®
            localStorage.setItem('actions', JSON.stringify(actions));
            console.log('Â∑≤Â∞ÜactionsÊï∞ÊçÆÂ≠òÂÇ®Âà∞localStorage:', actions);
            
            // Ê∏ÖÈô§Âä†ËΩΩÁä∂ÊÄÅ
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
            
            // Ê∏ÖÈô§Áé∞ÊúâÂÜÖÂÆπ
            actionsList.querySelectorAll('.action-card').forEach(card => card.remove());
            
            if (actions.length === 0) {
                if (noActionsMessage) {
                    noActionsMessage.style.display = 'block';
                }
                return;
            }
            
            if (noActionsMessage) {
                noActionsMessage.style.display = 'none';
            }

            actions.forEach(action => {
                const actionCard = document.createElement('div');
                actionCard.className = 'action-card';
                
                // ÊèêÂèñÂä®‰Ωú‰ø°ÊÅØ
                const actionName = action.actionName || action.name || 'Unnamed Action';
                const timestamp = action.timestamp ? new Date(action.timestamp).toLocaleString() : 'Unknown';
                
                // ÊèêÂèñËÆæÂ§áÂíåÂëΩ‰ª§‰ø°ÊÅØ
                let devicesList = '';
                if (action.payload && action.payload.message && action.payload.message.payload && Array.isArray(action.payload.message.payload)) {
                    devicesList = action.payload.message.payload.map((msg, index) => {
                        const deviceName = msg.name || 'Unknown Device';
                        // ‰ΩøÁî®actionName‰Ωú‰∏∫ÂîØ‰∏ÄÊ†áËØÜÁ¨¶ÔºåÂõ†‰∏∫action.idÂèØËÉΩ‰∏çÂ≠òÂú®
                        const actionIdentifier = action.name || action.actionName || index;
                        // Âè™ÊòæÁ§∫ËÆæÂ§áÂêçÁß∞Ôºå‰∏çÊòæÁ§∫MACÂú∞ÂùÄÂíåÂÖ∂‰ªñ‰ø°ÊÅØ
                        return `<div class="action-device-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <span class="action-device-name" style="font-size: 12px;">${deviceName}</span>
                            <div class="device-actions">
                                <span class="device-action-icon" title="Êü•Áúã" onclick="showDeviceActionDetails('${actionIdentifier}', ${index})"><i class="fas fa-eye"></i></span>
                                <span class="device-action-icon" title="ÊâßË°å" onclick="executeDeviceAction('${actionIdentifier}', ${index})"><i class="fas fa-play-circle"></i></span>
                            </div>
                        </div>`;
                    }).join('');
                } else if (action.payload && action.payload.message && action.payload.message.cmd) {
                    // ÊòæÁ§∫ÂëΩ‰ª§‰ø°ÊÅØ
                    devicesList = `<div class="action-device-item">
                        <span class="action-device-name">Command: ${action.payload.message.cmd}</span>
                    </div>`;
                }
                
                // ËÆ°ÁÆóËÆæÂ§áÊï∞Èáè
                const deviceCount = action.payload && action.payload.message && 
                                   action.payload.message.payload ? 
                                   action.payload.message.payload.length : 0;
                
                // Á°ÆÂÆöÂä®‰ΩúÁ±ªÂûãÂπ∂ËÆæÁΩÆÂØπÂ∫îÁöÑËâ≤Ê†á
                function getActionTypeColor(action) {
                    console.log('ÂàÜÊûêÂä®‰ΩúÁ±ªÂûã:', action);
                    
                    // Ê£ÄÊü•ÊòØÂê¶‰∏∫ËàµÊú∫Âä®‰Ωú
                    if (action.payload && action.payload.message && action.payload.message.payload) {
                        const devices = action.payload.message.payload;
                        const hasServo = devices.some(device => 
                            device.type === 'ServoController' || 
                            (device.name && device.name.toLowerCase().includes('servo'))
                        );
                        if (hasServo) {
                            console.log('ËØÜÂà´‰∏∫ËàµÊú∫Âä®‰Ωú');
                            return '#FF6B6B'; // Á∫¢Ëâ≤ - ËàµÊú∫Âä®‰Ωú
                        }
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶‰∏∫ÂºÄÂÖ≥Âä®‰Ωú - ÈÄöËøástatesÂ≠óÊÆµËØÜÂà´
                    if (action.payload && action.payload.message && action.payload.message.payload) {
                        const devices = action.payload.message.payload;
                        const hasSwitch = devices.some(device => {
                            // Ê£ÄÊü•ÊòØÂê¶ÊúâstatesÂ≠óÊÆµÔºàÂºÄÂÖ≥Âä®‰ΩúÁöÑÁâπÂæÅÔºâ
                            const hasStates = device.states && Array.isArray(device.states);
                            // Ê£ÄÊü•ËÆæÂ§áÂêçÁß∞ÊòØÂê¶ÂåÖÂê´ÂºÄÂÖ≥Áõ∏ÂÖ≥ÂÖ≥ÈîÆËØç
                            const nameIndicatesSwitch = device.name && 
                                (device.name.toLowerCase().includes('switch') || 
                                 device.name.toLowerCase().includes('socket') ||
                                 device.name.toLowerCase().includes('light') ||
                                 device.name.toLowerCase().includes('lamp'));
                            // Ê£ÄÊü•ËÆæÂ§áÁ±ªÂûã
                            const typeIndicatesSwitch = device.type === 'MultiSwitch' || device.type === 'SmartSocket';
                            
                            return hasStates || nameIndicatesSwitch || typeIndicatesSwitch;
                        });
                        if (hasSwitch) {
                            console.log('ËØÜÂà´‰∏∫ÂºÄÂÖ≥Âä®‰Ωú');
                            return '#4ECDC4'; // ÈùíËâ≤ - ÂºÄÂÖ≥Âä®‰Ωú
                        }
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶‰∏∫‰º†ÊÑüÂô®Âä®‰Ωú
                    if (action.payload && action.payload.message && action.payload.message.payload) {
                        const devices = action.payload.message.payload;
                        const hasSensor = devices.some(device => 
                            device.type === 'EnvSensor' || 
                            device.type === 'PIR_Sensor' || 
                            device.type === 'Contact_Sensor' ||
                            (device.name && device.name.toLowerCase().includes('sensor'))
                        );
                        if (hasSensor) {
                            console.log('ËØÜÂà´‰∏∫‰º†ÊÑüÂô®Âä®‰Ωú');
                            return '#45B7D1'; // ËìùËâ≤ - ‰º†ÊÑüÂô®Âä®‰Ωú
                        }
                    }
                    
                    console.log('Êú™ËØÜÂà´Âä®‰ΩúÁ±ªÂûãÔºå‰ΩøÁî®ÈªòËÆ§È¢úËâ≤');
                    // ÈªòËÆ§È¢úËâ≤ - Ê∑∑ÂêàÊàñÊú™Áü•Á±ªÂûã
                    return '#95A5A6'; // ÁÅ∞Ëâ≤
                }
                
                const actionTypeColor = getActionTypeColor(action);
                
                actionCard.innerHTML = `
                    <div class="action-card-header">
                        <div class="action-name-left">${actionName}</div>
                        <div class="action-type-triangle" style="position: absolute; top: 0; right: 0; width: 0; height: 0; border-left: 20px solid transparent; border-top: 20px solid ${actionTypeColor}; border-top-right-radius: inherit;"></div>
                    </div>
                    <div class="action-card-content" style="padding: 10px 15px; flex: 1; overflow: hidden; height: 100px; max-height: 100px;">
                        <div class="action-devices-list" id="devicesList-${action.id}" style="overflow: hidden;" onmouseover="startScroll(this)" onmouseout="stopScroll(this)">
                            ${devicesList || '<div class="no-devices">No devices in this action</div>'}
                        </div>
                    </div>
                    <div class="action-card-actions">
                        <button class="action-card-btn execute" onclick="executeAction('${actionName}')">Execute</button>
                        <button class="action-card-btn edit" onclick="editAction('${actionName}')">Edit</button>
                        <button class="action-card-btn delete" onclick="deleteAction('${actionName}')">Delete</button>
                    </div>
                `;
                actionsList.appendChild(actionCard);
            });
        }

        // Ê£ÄÊü•ÊòØÂê¶‰∏∫ËàµÊú∫Âä®‰ΩúÁöÑËæÖÂä©ÂáΩÊï∞
        function checkIfServoAction(action) {
            console.log('Ê£ÄÊü•ËàµÊú∫Âä®‰Ωú:', action);
            
            // Ê£ÄÊü•ËÆæÂ§áÁ±ªÂûãÊòØÂê¶‰∏∫ServoController
            if (action.payload && action.payload.message && action.payload.message.payload) {
                const devices = action.payload.message.payload;
                for (let device of devices) {
                    console.log('Ê£ÄÊü•ËÆæÂ§áÁ±ªÂûã:', device.type);
                    if (device.type === 'ServoController') {
                        console.log('ËØÜÂà´‰∏∫ËàµÊú∫Âä®‰Ωú - ËÆæÂ§áÁ±ªÂûãÂåπÈÖç');
                        return true;
                    }
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ËàµÊú∫ÁâπÊúâÁöÑÂ≠óÊÆµ
            if (action.actionType || action.action_type) {
                const actionType = action.actionType || action.action_type;
                console.log('Ê£ÄÊü•Âä®‰ΩúÁ±ªÂûã:', actionType);
                if (['sequence', 'back_forth', 'sweep_return', 'repeat'].includes(actionType)) {
                    console.log('ËØÜÂà´‰∏∫ËàµÊú∫Âä®‰Ωú - Âä®‰ΩúÁ±ªÂûãÂåπÈÖç');
                    return true;
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ËàµÊú∫ÁâπÊúâÁöÑÂ≠óÊÆµÂ¶ÇactionName
            if (action.actionName && (action.angles || action.delays || action.repeatCount)) {
                console.log('ËØÜÂà´‰∏∫ËàµÊú∫Âä®‰Ωú - ËàµÊú∫Â≠óÊÆµÂåπÈÖç');
                return true;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´PanTiltServoÁ≠âËàµÊú∫ËÆæÂ§áÂêçÁß∞
            if (action.payload && action.payload.message && action.payload.message.payload) {
                const devices = action.payload.message.payload;
                for (let device of devices) {
                    if (device.name && device.name.includes('Servo')) {
                        console.log('ËØÜÂà´‰∏∫ËàµÊú∫Âä®‰Ωú - ËÆæÂ§áÂêçÁß∞ÂåÖÂê´Servo');
                        return true;
                    }
                }
            }
            
            console.log('Êú™ËØÜÂà´‰∏∫ËàµÊú∫Âä®‰Ωú');
            return false;
        }

        // ÁºñËæëActionÁöÑÂáΩÊï∞ÔºàÊöÇÊó∂Âè™ÊòæÁ§∫ÊèêÁ§∫Ôºâ
        function editAction(actionName) {
            console.log('Edit action:', actionName);
            
            try {
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                const action = actions.find(a => a.name === actionName || a.actionName === actionName);
                
                if (!action) {
                    console.error('Action not found:', actionName);
                    notificationManager.show('Action data not found', 'error');
                    return;
                }
                
                // Create edit modal
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.style.opacity = '1';
                
                // Create modal content
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                modalContent.style.width = '80%';
                modalContent.style.maxWidth = '800px';
                modalContent.style.transform = 'scale(1) translateY(0)';
                
                // Create title and header
                const modalHeader = document.createElement('div');
                modalHeader.className = 'modal-header';
                modalHeader.style.display = 'flex';
                modalHeader.style.justifyContent = 'space-between';
                modalHeader.style.alignItems = 'center';
                modalHeader.style.marginBottom = '20px';
                
                const title = document.createElement('h2');
                title.textContent = `Edit Action: ${actionName}`;
                
                const closeButton = document.createElement('span');
                closeButton.innerHTML = '&times;';
                closeButton.className = 'close-modal';
                closeButton.style.cursor = 'pointer';
                closeButton.style.fontSize = '24px';
                closeButton.onclick = function() {
                    document.body.removeChild(modal);
                };
                
                modalHeader.appendChild(title);
                modalHeader.appendChild(closeButton);
                
                // Ê£ÄÊü•ÊòØÂê¶‰∏∫ËàµÊú∫Âä®‰ΩúÂç°Áâá
                const isServoAction = checkIfServoAction(action);
                
                // Create tabs (Âè™ÊúâÈùûËàµÊú∫Âä®‰ΩúÊâçÊòæÁ§∫Visual Editor)
                const tabContainer = document.createElement('div');
                tabContainer.style.display = 'flex';
                tabContainer.style.marginBottom = '20px';
                tabContainer.style.borderBottom = '1px solid #ccc';
                
                let visualTab, jsonTab;
                
                if (!isServoAction) {
                    // ÈùûËàµÊú∫Âä®‰ΩúÔºöÊòæÁ§∫‰∏§‰∏™Ê†áÁ≠æÈ°µ
                    visualTab = document.createElement('div');
                    visualTab.textContent = 'Visual Editor';
                    visualTab.style.padding = '10px 20px';
                    visualTab.style.cursor = 'pointer';
                    visualTab.style.backgroundColor = '#007bff';
                    visualTab.style.color = 'white';
                    visualTab.style.borderTopLeftRadius = '5px';
                    visualTab.style.borderTopRightRadius = '5px';
                    
                    jsonTab = document.createElement('div');
                    jsonTab.textContent = 'JSON Editor';
                    jsonTab.style.padding = '10px 20px';
                    jsonTab.style.cursor = 'pointer';
                    jsonTab.style.backgroundColor = '#f0f0f0';
                    jsonTab.style.borderTopLeftRadius = '5px';
                    jsonTab.style.borderTopRightRadius = '5px';
                    jsonTab.style.marginLeft = '5px';
                    
                    tabContainer.appendChild(visualTab);
                    tabContainer.appendChild(jsonTab);
                } else {
                    // ËàµÊú∫Âä®‰ΩúÔºöÂè™ÊòæÁ§∫JSON EditorÊ†áÁ≠æÈ°µ
                    jsonTab = document.createElement('div');
                    jsonTab.textContent = 'JSON Editor';
                    jsonTab.style.padding = '10px 20px';
                    jsonTab.style.cursor = 'pointer';
                    jsonTab.style.backgroundColor = '#007bff';
                    jsonTab.style.color = 'white';
                    jsonTab.style.borderTopLeftRadius = '5px';
                    jsonTab.style.borderTopRightRadius = '5px';
                    
                    tabContainer.appendChild(jsonTab);
                }
                
                // ÂàõÂª∫ÂÜÖÂÆπÂå∫Âüü
                const contentArea = document.createElement('div');
                contentArea.style.padding = '10px';
                
                // ÂàõÂª∫ÂèØËßÜÂåñÁºñËæëÂå∫Âüü
                const visualEditor = document.createElement('div');
                visualEditor.id = 'visual-editor';
                
                // ÂàõÂª∫Âä®‰ΩúÂêçÁß∞ËæìÂÖ•
                // Action Name input removed as requested
                
                // Create device list area
                const devicesContainer = document.createElement('div');
                devicesContainer.style.marginBottom = '20px';
                
                const devicesTitle = document.createElement('h3');
                devicesTitle.textContent = 'Device List';
                devicesTitle.style.marginBottom = '10px';
                
                const devicesList = document.createElement('div');
                devicesList.id = 'devices-list';
                devicesList.style.border = '1px solid #ccc';
                devicesList.style.borderRadius = '4px';
                devicesList.style.padding = '10px';
                devicesList.style.maxHeight = '200px';
                devicesList.style.overflowY = 'auto';
                
                // Extract device list
                const devices = action.payload && action.payload.message && 
                               action.payload.message.payload ? 
                               action.payload.message.payload : [];
                
                // Add devices to list
                devices.forEach((device, index) => {
                    const deviceItem = document.createElement('div');
                    deviceItem.style.padding = '10px';
                    deviceItem.style.marginBottom = '5px';
                    deviceItem.style.backgroundColor = '#f9f9f9';
                    deviceItem.style.borderRadius = '4px';
                    deviceItem.style.display = 'flex';
                    deviceItem.style.justifyContent = 'space-between';
                    deviceItem.style.alignItems = 'center';
                    
                    const deviceInfo = document.createElement('div');
                    deviceInfo.innerHTML = `<strong>${device.name}</strong> (${device.mac})`;
                    
                    const statesContainer = document.createElement('div');
                    statesContainer.style.display = 'flex';
                    statesContainer.style.gap = '5px';
                    
                    // ÊòæÁ§∫Áä∂ÊÄÅ
                    if (device.states && device.states.length > 0) {
                        device.states.forEach((state, stateIndex) => {
                            const stateTag = document.createElement('button');
                            stateTag.textContent = state;
                            stateTag.style.padding = '3px 12px';
                            stateTag.style.backgroundColor = '#007bff';
                            stateTag.style.color = 'white';
                            stateTag.style.border = 'none';
                            stateTag.style.borderRadius = '15px';
                            stateTag.style.cursor = 'pointer';
                            stateTag.style.transition = 'all 0.3s ease';
                            stateTag.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                            stateTag.style.marginRight = '5px';
                            stateTag.style.fontSize = '14px';
                            stateTag.style.fontFamily = 'Arial, sans-serif';
                            stateTag.style.minWidth = '60px';
                            stateTag.style.textAlign = 'center';
                            
                            // Add hover effects
                            stateTag.onmouseover = function() {
                                this.style.transform = 'scale(1.1)';
                                this.style.boxShadow = '0 3px 6px rgba(0,0,0,0.2)';
                                this.style.filter = 'brightness(110%)';
                            };
                            
                            stateTag.onmouseout = function() {
                                this.style.transform = 'scale(1)';
                                this.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                                this.style.filter = 'brightness(100%)';
                            };
                            stateTag.onclick = function() {
                                // Cycle through states: toggle -> on -> off -> ignore -> toggle
                                const states = ['toggle', 'on', 'off', 'ignore'];
                                const currentState = stateTag.textContent;
                                const currentIndex = states.indexOf(currentState);
                                const nextIndex = (currentIndex + 1) % states.length;
                                const nextState = states[nextIndex];
                                
                                // Update device state data
                                device.states[stateIndex] = nextState;
                                
                                // Update DOM display
                                stateTag.textContent = nextState;
                                
                                // Optional: Update tag style based on state
                                if (nextState === 'on') {
                                    stateTag.style.backgroundColor = '#28a745'; // Green
                                } else if (nextState === 'off') {
                                    stateTag.style.backgroundColor = '#dc3545'; // Red
                                } else if (nextState === 'ignore') {
                                    stateTag.style.backgroundColor = '#6c757d'; // Gray
                                } else {
                                    stateTag.style.backgroundColor = '#007bff'; // Blue (toggle)
                                }
                                
                                console.log(`Device ${device.name} state changed to: ${nextState}`);
                            };
                            statesContainer.appendChild(stateTag);
                        });
                    }
                    
                    deviceItem.appendChild(deviceInfo);
                    deviceItem.appendChild(statesContainer);
                    devicesList.appendChild(deviceItem);
                });
                
                devicesContainer.appendChild(devicesTitle);
                devicesContainer.appendChild(devicesList);
                
                // Ê∑ªÂä†Âà∞ÂèØËßÜÂåñÁºñËæëÂô®
                visualEditor.appendChild(devicesContainer);
                
                // ÂàõÂª∫JSONÁºñËæëÂô®
                const jsonEditor = document.createElement('textarea');
                jsonEditor.id = 'action-json-editor';
                jsonEditor.style.width = '100%';
                jsonEditor.style.height = '400px';
                jsonEditor.style.fontFamily = 'monospace';
                jsonEditor.style.fontSize = '14px';
                jsonEditor.style.padding = '10px';
                jsonEditor.style.marginBottom = '20px';
                jsonEditor.style.border = '1px solid #ccc';
                jsonEditor.style.borderRadius = '4px';
                jsonEditor.value = JSON.stringify(action, null, 2);
                
                // Ê†πÊçÆÊòØÂê¶‰∏∫ËàµÊú∫Âä®‰ΩúÂÜ≥ÂÆöÂàùÂßãÊòæÁ§∫Áä∂ÊÄÅ
                if (isServoAction) {
                    jsonEditor.style.display = 'block';
                    visualEditor.style.display = 'none';
                } else {
                    jsonEditor.style.display = 'none';
                    visualEditor.style.display = 'block';
                }
                
                // Ê∑ªÂä†ÁºñËæëÂô®Âà∞ÂÜÖÂÆπÂå∫Âüü
                contentArea.appendChild(visualEditor);
                contentArea.appendChild(jsonEditor);
                
                // Ê∑ªÂä†ÈÄâÈ°πÂç°ÂàáÊç¢ÂäüËÉΩÔºàÂè™ÊúâÈùûËàµÊú∫Âä®‰ΩúÊâçÈúÄË¶ÅÂàáÊç¢ÂäüËÉΩÔºâ
                if (!isServoAction && visualTab) {
                    visualTab.onclick = function() {
                        visualTab.style.backgroundColor = '#007bff';
                        visualTab.style.color = 'white';
                        jsonTab.style.backgroundColor = '#f0f0f0';
                        jsonTab.style.color = 'black';
                        visualEditor.style.display = 'block';
                        jsonEditor.style.display = 'none';
                    };
                }
                
                if (jsonTab) {
                    jsonTab.onclick = function() {
                        jsonTab.style.backgroundColor = '#007bff';
                        jsonTab.style.color = 'white';
                        if (visualTab) {
                            visualTab.style.backgroundColor = '#f0f0f0';
                            visualTab.style.color = 'black';
                        }
                        jsonEditor.style.display = 'block';
                        visualEditor.style.display = 'none';
                        
                        // ‰ªéÂèØËßÜÂåñÁºñËæëÂô®Êõ¥Êñ∞JSONÔºàÂè™ÊúâÈùûËàµÊú∫Âä®‰ΩúÊâçÈúÄË¶ÅÔºâ
                        if (!isServoAction) {
                            const updatedAction = {...action};
                            // ‰ΩøÁî®ÂéüÂßãÂä®‰ΩúÂêçÁß∞ÔºåÂõ†‰∏∫ËæìÂÖ•Ê°ÜÂ∑≤Ë¢´ÁßªÈô§
                            updatedAction.name = action.name || action.actionName;
                    
                            // Êõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄÅ
                            const deviceElements = devicesList.children;
                            for (let i = 0; i < deviceElements.length; i++) {
                                const stateTags = deviceElements[i].querySelectorAll('button:not([data-device-index])');
                                const states = Array.from(stateTags).map(tag => tag.textContent);
                                if (updatedAction.payload && updatedAction.payload.message && 
                                    updatedAction.payload.message.payload && updatedAction.payload.message.payload[i]) {
                                    updatedAction.payload.message.payload[i].states = states;
                                }
                            }
                    
                            jsonEditor.value = JSON.stringify(updatedAction, null, 2);
                        }
                    };
                }
                
                // ÂàõÂª∫ÊåâÈíÆÂÆπÂô®
                const buttonContainer = document.createElement('div');
                buttonContainer.style.display = 'flex';
                buttonContainer.style.justifyContent = 'flex-end';
                buttonContainer.style.gap = '10px';
                buttonContainer.style.marginTop = '20px';
                
                // Create save button
                const saveButton = document.createElement('button');
                saveButton.textContent = 'Save';
                saveButton.style.padding = '8px 16px';
                saveButton.style.backgroundColor = '#007bff';
                saveButton.style.color = 'white';
                saveButton.style.border = 'none';
                saveButton.style.borderRadius = '4px';
                saveButton.style.cursor = 'pointer';
                saveButton.onclick = function() {
                    try {
                        let updatedAction;
                        
                        // Ê†πÊçÆÂΩìÂâçÊøÄÊ¥ªÁöÑÁºñËæëÂô®Ëé∑ÂèñÊï∞ÊçÆ
                        if (jsonEditor.style.display === 'none') {
                            // ‰ªéÂèØËßÜÂåñÁºñËæëÂô®Ëé∑ÂèñÊï∞ÊçÆ
                            updatedAction = {...action};
                            // ‰ΩøÁî®ÂéüÂßãÂä®‰ΩúÂêçÁß∞ÔºåÂõ†‰∏∫ËæìÂÖ•Ê°ÜÂ∑≤Ë¢´ÁßªÈô§
                            updatedAction.name = action.name || action.actionName;
                            
                            // Êõ¥Êñ∞ËÆæÂ§áÁä∂ÊÄÅ
                            const deviceElements = devicesList.children;
                            for (let i = 0; i < deviceElements.length; i++) {
                                const stateTags = deviceElements[i].querySelectorAll('button:not([data-device-index])');
                                const states = Array.from(stateTags).map(tag => tag.textContent);
                                console.log(`ËÆæÂ§á ${i} Áä∂ÊÄÅ:`, states);
                                
                                // Á°Æ‰øùËÆæÂ§áÁä∂ÊÄÅÊï∞ÁªÑ‰∏ç‰∏∫Á©∫
                                if (states.length === 0) {
                                    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Áä∂ÊÄÅÊåâÈíÆÔºå‰øùÁïôÂéüÂßãÁä∂ÊÄÅ
                                    if (updatedAction.payload && updatedAction.payload.message && 
                                        updatedAction.payload.message.payload && updatedAction.payload.message.payload[i] &&
                                        updatedAction.payload.message.payload[i].states) {
                                        console.log(`‰øùÁïôËÆæÂ§á ${i} ÁöÑÂéüÂßãÁä∂ÊÄÅ:`, updatedAction.payload.message.payload[i].states);
                                    }
                                } else {
                                    // Âè™ÊúâÂú®ÊâæÂà∞Áä∂ÊÄÅÊåâÈíÆÊó∂ÊâçÊõ¥Êñ∞Áä∂ÊÄÅ
                                    if (updatedAction.payload && updatedAction.payload.message && 
                                        updatedAction.payload.message.payload && updatedAction.payload.message.payload[i]) {
                                        updatedAction.payload.message.payload[i].states = states;
                                        console.log(`Êõ¥Êñ∞ËÆæÂ§á ${i} Áä∂ÊÄÅ‰∏∫:`, states);
                                    }
                                }
                            }
                        } else {
                            // ‰ªéJSONÁºñËæëÂô®Ëé∑ÂèñÊï∞ÊçÆ
                            updatedAction = JSON.parse(jsonEditor.value);
                        }
                        
                        // Êõ¥Êñ∞localStorage‰∏≠ÁöÑÂä®‰Ωú
                        const actions = JSON.parse(localStorage.getItem('actions')) || [];
                        const actionIndex = actions.findIndex(a => a.name === actionName || a.actionName === actionName);
                        if (actionIndex !== -1) {
                            actions[actionIndex] = updatedAction;
                            localStorage.setItem('actions', JSON.stringify(actions));
                            
                            // ÊûÑÂª∫WebSocketÊ∂àÊÅØÈÄöÁü•ÁΩëÂÖ≥
                            try {
                                // ÊèêÂèñÂä®‰Ωú‰∏≠ÁöÑËÆæÂ§áÊï∞ÊçÆ
                                const devices = updatedAction.payload && updatedAction.payload.message && 
                                               updatedAction.payload.message.payload ? 
                                               updatedAction.payload.message.payload : [];
                                
                                // ÊûÑÂª∫‰øùÂ≠òÂä®‰ΩúÁöÑWebSocketÊ∂àÊÅØ
                                const saveActionMessage = {
                                    command: "saveAction",
                                    payload: {
                                        isBroadcast: true,
                                        message: {
                                            cmd: "groupState",
                                            payload: devices
                                        }
                                    },
                                    actionName: updatedAction.name || updatedAction.actionName
                                };
                                
                                console.log('ÂèëÈÄÅ‰øùÂ≠òÂä®‰ΩúÊ∂àÊÅØ:', saveActionMessage);
                                
                                // ÂèëÈÄÅWebSocketÊ∂àÊÅØ
                                if (window.deviceManager && window.deviceManager.sendWebSocketMessage) {
                                    window.deviceManager.sendWebSocketMessage(saveActionMessage);
                                    console.log('Â∑≤ÂèëÈÄÅ‰øùÂ≠òÂä®‰ΩúÊ∂àÊÅØ');
                                } else {
                                    console.error('deviceManagerÊàñsendWebSocketMessage‰∏çÂèØÁî®');
                                }
                            } catch (wsError) {
                                console.error('ÂèëÈÄÅWebSocketÊ∂àÊÅØÊó∂Âá∫Èîô:', wsError);
                                notificationManager.show(`Âä®‰ΩúÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Ôºå‰ΩÜÂêåÊ≠•Âà∞ÁΩëÂÖ≥Â§±Ë¥•: ${wsError.message}`, 'warning');
                            }
                            
                            // Âà∑Êñ∞Âä®‰ΩúÂàóË°®
                            loadActions();
                            
                            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                            document.body.removeChild(modal);
                            
                            notificationManager.show(`Âä®‰Ωú "${actionName}" Â∑≤Êõ¥Êñ∞`, 'success');
                        }
                    } catch (error) {
                        console.error('‰øùÂ≠òÂä®‰ΩúÊó∂Âá∫Èîô:', error);
                        notificationManager.show(`‰øùÂ≠òÂ§±Ë¥•: ${error.message}`, 'error');
                    }
                };
                
                // Create cancel button
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.style.padding = '8px 16px';
                cancelButton.style.backgroundColor = '#6c757d';
                cancelButton.style.color = 'white';
                cancelButton.style.border = 'none';
                cancelButton.style.borderRadius = '4px';
                cancelButton.style.cursor = 'pointer';
                cancelButton.style.marginRight = '10px';
                cancelButton.onclick = function() {
                    document.body.removeChild(modal);
                };
                
                // Ê∑ªÂä†ÊåâÈíÆÂà∞ÂÆπÂô®
                buttonContainer.appendChild(cancelButton);
                buttonContainer.appendChild(saveButton);
                
                // ÁªÑË£ÖÊ®°ÊÄÅÊ°Ü
                modalContent.appendChild(modalHeader);
                modalContent.appendChild(tabContainer);
                modalContent.appendChild(contentArea);
                modalContent.appendChild(buttonContainer);
                modal.appendChild(modalContent);
                
                // Ê∑ªÂä†Âà∞È°µÈù¢
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('ÁºñËæëÂä®‰ΩúÊó∂Âá∫Èîô:', error);
                notificationManager.show(`ÁºñËæëÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÊâßË°åActionÁöÑÂáΩÊï∞
        function executeAction(actionName) {
            console.log('ÊâßË°åÂä®‰Ωú:', actionName);
            
            try {
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                const action = actions.find(a => a.name === actionName || a.actionName === actionName);
                
                if (!action) {
                    console.error('Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑaction:', actionName);
                    notificationManager.show('Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑÂä®‰ΩúÊï∞ÊçÆ', 'error');
                    return;
                }
                
                // ÊûÑÂª∫WebSocketÊ∂àÊÅØ
                const message = {
                    command: "sendMessage",
                    payload: {
                        isBroadcast: true,
                        message: {
                            cmd: "groupState",
                            payload: action.payload?.message?.payload || []
                        }
                    }
                };
                
                console.log('ÂèëÈÄÅWebSocketÊ∂àÊÅØ:', message);
                
                // ÊòæÁ§∫ÊâßË°å‰∏≠Áä∂ÊÄÅ
                notificationManager.show(`Ê≠£Âú®ÊâßË°åÂä®‰Ωú: ${actionName}...`, 'info');
                
                // ÈÄöËøáWebSocketÂèëÈÄÅÊ∂àÊÅØ
                if (window.deviceManager && window.deviceManager.sendWebSocketMessage(message)) {
                    notificationManager.show(`Âä®‰Ωú "${actionName}" ÊâßË°åÊàêÂäü`, 'success');
                } else {
                    throw new Error('WebSocketÊú™ËøûÊé•ÊàñÂèëÈÄÅÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÊâßË°åÂä®‰ΩúÊó∂Âá∫Èîô:', error);
                notificationManager.show(`ÊâßË°åÂä®‰ΩúÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Âà†Èô§ActionÁöÑÂáΩÊï∞
        function deleteAction(actionName) {
            // ‰ΩøÁî®Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™ó
            const modal = document.getElementById('confirmationModal');
            const confirmationIcon = document.getElementById('confirmationIcon');
            const confirmationTitle = document.getElementById('confirmationTitle');
            const confirmationMessage = document.getElementById('confirmationMessage');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const deviceInfo = document.getElementById('deviceInfo');
            
            // ËÆæÁΩÆÂºπÁ™óÂÜÖÂÆπ
            confirmationIcon.className = 'confirmation-icon delete';
            confirmationIcon.innerHTML = 'üóëÔ∏è';
            confirmationTitle.textContent = 'Âà†Èô§Âä®‰Ωú';
            confirmationMessage.textContent = `Á°ÆÂÆöË¶ÅÂà†Èô§Âä®‰Ωú "${actionName}" ÂêóÔºü`;
            confirmBtn.textContent = 'Âà†Èô§';
            confirmBtn.className = 'confirmation-btn confirm';
            deviceInfo.style.display = 'none';
            
            // ÊòæÁ§∫ÂºπÁ™ó
            modal.classList.add('show');
            
            // Á°ÆËÆ§ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            confirmBtn.onclick = function() {
                // ‰ªélocalStorage‰∏≠Âà†Èô§
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                const updatedActions = actions.filter(action => (action.name || action.actionName) !== actionName);
                localStorage.setItem('actions', JSON.stringify(updatedActions));
                
                // ÂèëÈÄÅWebSocketÊ∂àÊÅØÂà∞ÁΩëÂÖ≥Âà†Èô§NVS‰∏≠ÁöÑÂä®‰Ωú
                const deleteMessage = {
                    command: "deleteAction",
                    actionName: actionName
                };
                
                if (window.deviceManager && window.deviceManager.sendWebSocketMessage) {
                    if (window.deviceManager.sendWebSocketMessage(deleteMessage)) {
                        console.log('ÂèëÈÄÅÂà†Èô§Âä®‰ΩúÊ∂àÊÅØ:', deleteMessage);
                        notificationManager.show(`Ê≠£Âú®Âà†Èô§Âä®‰Ωú: ${actionName}`, 'info');
                    } else {
                        console.error('ÂèëÈÄÅÂà†Èô§Ê∂àÊÅØÂ§±Ë¥•');
                        notificationManager.show('ÂèëÈÄÅÂà†Èô§Ê∂àÊÅØÂ§±Ë¥•', 'error');
                    }
                } else {
                    console.error('deviceManagerÊàñsendWebSocketMessage‰∏çÂèØÁî®');
                    notificationManager.show('WebSocketÊú™ËøûÊé•ÔºåÊó†Ê≥ïÂà†Èô§ÁΩëÂÖ≥‰∏≠ÁöÑÂä®‰Ωú', 'error');
                }
                
                // Âà∑Êñ∞Âä®‰ΩúÂàóË°®
                loadActions();
                notificationManager.show(`Âä®‰ΩúÂ∑≤Âà†Èô§: ${actionName}`, 'success');
                
                // ÈöêËóèÂºπÁ™ó
                modal.classList.remove('show');
            };
            
            // ÂèñÊ∂àÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            cancelBtn.onclick = function() {
                modal.classList.remove('show');
            };
            
            // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            return false;
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, navigation tabs initialized');
            
            // ÂàùÂßãÂåñSystem MonitorÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            initSystemMonitor();
        });

        // System MonitorÂäüËÉΩÂàùÂßãÂåñ
        function initSystemMonitor() {
            // Êü•ÊâæSystem MonitorÊåâÈíÆ
            const functionCards = document.querySelectorAll('.function-card');
            let systemMonitorBtn = null;
            
            functionCards.forEach(card => {
                const title = card.querySelector('h3');
                if (title && title.textContent.trim() === 'System Monitor') {
                    systemMonitorBtn = card.querySelector('.function-btn');
                }
            });
            
            if (systemMonitorBtn) {
                systemMonitorBtn.addEventListener('click', showSystemMonitor);
            }
            
            // ÁªëÂÆöFirmware UpdateÊåâÈíÆ‰∫ã‰ª∂
            let firmwareUpdateBtn = null;
            
            functionCards.forEach(card => {
                const title = card.querySelector('h3');
                if (title && title.textContent.trim() === 'Firmware Update') {
                    firmwareUpdateBtn = card.querySelector('.function-btn');
                }
            });
            
            if (firmwareUpdateBtn) {
                firmwareUpdateBtn.addEventListener('click', showOTAUpgrade);
            }
            
            // ÁªëÂÆöNetwork ConfigurationÊåâÈíÆ‰∫ã‰ª∂
            let networkConfigBtn = null;
            
            functionCards.forEach(card => {
                const title = card.querySelector('h3');
                if (title && title.textContent.trim() === 'Network Configuration') {
                    networkConfigBtn = card.querySelector('.function-btn');
                }
            });
            
            if (networkConfigBtn) {
                networkConfigBtn.addEventListener('click', showNetworkConfig);
            }
        }

        // ÊòæÁ§∫Á≥ªÁªüÁõëÊéß‰ø°ÊÅØ
        async function showSystemMonitor() {
            console.log('System Monitor button clicked');
            try {
                console.log('Fetching system monitor data...');
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/system_monitor`);
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const text = await response.text();
                console.log('Response text:', text);
                
                if (!text || text.trim() === '' || text === '{}') {
                    throw new Error('Empty response from server');
                }
                
                const data = JSON.parse(text);
                console.log('Parsed data:', data);
                displaySystemMonitorModal(data);
            } catch (error) {
                console.error('Failed to fetch system monitor data:', error);
                alert('Failed to load system information: ' + error.message);
                if (window.notificationManager) {
                    window.notificationManager.show('Failed to load system information: ' + error.message, 'error');
                }
            }
        }

        // ÊòæÁ§∫Á≥ªÁªüÁõëÊéßÊ®°ÊÄÅÊ°Ü
        function displaySystemMonitorModal(data) {
            const modalHtml = `
                <div id="systemMonitorModal" class="modal" onclick="closeSystemMonitorModal()">
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh; border-radius: 20px; overflow: hidden;" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h2>System Monitor</h2>
                        </div>
                        <div class="modal-body" style="max-height: calc(80vh - 120px); overflow-y: auto; padding-right: 10px;">
                            <div class="system-info-grid">
                                <div class="info-section">
                                    <h3>System Information</h3>
                                    <div class="info-item">
                                        <span class="label">Uptime:</span>
                                        <span class="value">${data.system?.uptime || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Chip Model:</span>
                                        <span class="value">${data.system?.chipModel || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">CPU Frequency:</span>
                                        <span class="value">${data.system?.cpuFreqMHz || 'N/A'} MHz</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Flash Size:</span>
                                        <span class="value">${formatBytes(data.system?.flashChipSize || 0)}</span>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>Memory Usage</h3>
                                    <div class="info-item">
                                        <span class="label">Total Heap:</span>
                                        <span class="value">${formatBytes(data.memory?.totalHeap || 0)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Free Heap:</span>
                                        <span class="value">${formatBytes(data.memory?.freeHeap || 0)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Used Heap:</span>
                                        <span class="value">${formatBytes(data.memory?.usedHeap || 0)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Usage:</span>
                                        <span class="value">${data.memory?.usagePercent || 0}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${data.memory?.usagePercent || 0}%"></div>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>Network Status</h3>
                                    <div class="info-item">
                                        <span class="label">Type:</span>
                                        <span class="value">${data.network?.type || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">IP Address:</span>
                                        <span class="value">${data.network?.ipAddress || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">MAC Address:</span>
                                        <span class="value">${data.network?.macAddress || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Link Status:</span>
                                        <span class="value ${data.network?.linkUp ? 'status-online' : 'status-offline'}">
                                            ${data.network?.linkUp ? 'Up' : 'Down'}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Link Speed:</span>
                                        <span class="value">${data.network?.linkSpeed || 'N/A'} Mbps</span>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>MQTT Status</h3>
                                    <div class="info-item">
                                        <span class="label">Connection:</span>
                                        <span class="value ${data.mqtt?.connected ? 'status-online' : 'status-offline'}">
                                            ${data.mqtt?.connected ? 'Connected' : 'Disconnected'}
                                        </span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Server:</span>
                                        <span class="value">${data.mqtt?.server || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Port:</span>
                                        <span class="value">${data.mqtt?.port || 'N/A'}</span>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>Mesh Network</h3>
                                    <div class="info-item">
                                        <span class="label">Connected Devices:</span>
                                        <span class="value">${data.mesh?.connectedDevices || 0}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Online Devices:</span>
                                        <span class="value">${data.mesh?.onlineDevices || 0}</span>
                                    </div>
                                </div>
                                
                                <div class="info-section">
                                    <h3>Storage (NVS)</h3>
                                    <div class="info-item">
                                        <span class="label">Total Entries:</span>
                                        <span class="value">${data.nvs?.totalEntries || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Used Entries:</span>
                                        <span class="value">${data.nvs?.usedEntries || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="label">Usage:</span>
                                        <span class="value">${data.nvs?.usagePercent || 0}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${data.nvs?.usagePercent || 0}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-actions" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                                <button onclick="refreshSystemMonitor()" class="btn btn-primary">Refresh</button>
                                <button onclick="rebootGateway()" class="btn btn-warning">Reboot Gateway</button>
                                <button onclick="clearNVS()" class="btn btn-danger">Clear NVS</button>
                                <button onclick="closeSystemMonitorModal()" class="btn btn-secondary">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÊ®°ÊÄÅÊ°Ü
            const existingModal = document.getElementById('systemMonitorModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Ê∑ªÂä†Êñ∞ÁöÑÊ®°ÊÄÅÊ°Ü
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modal = document.getElementById('systemMonitorModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // ÂÖ≥Èó≠Á≥ªÁªüÁõëÊéßÊ®°ÊÄÅÊ°Ü
        function closeSystemMonitorModal() {
            const modal = document.getElementById('systemMonitorModal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Âà∑Êñ∞Á≥ªÁªüÁõëÊéß‰ø°ÊÅØ
        function refreshSystemMonitor() {
            showSystemMonitor();
        }

        // ÈáçÂêØÁΩëÂÖ≥
        async function rebootGateway() {
            const confirmed = await confirmDialog.show(
                'Reboot Gateway',
                'Are you sure you want to reboot the gateway? This will temporarily disconnect all devices and may take up to 30 seconds to complete.',
                'Reboot Now',
                'Cancel',
                'warning'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/reboot`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    notificationManager.show('Gateway is rebooting...', 'info');
                    closeSystemMonitorModal();
                    // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥ÂêéÂ∞ùËØïÈáçÊñ∞ËøûÊé•
                    setTimeout(() => {
                        location.reload();
                    }, 10000);
                } else {
                    notificationManager.show('Failed to reboot gateway', 'error');
                }
            } catch (error) {
                console.error('Error rebooting gateway:', error);
                notificationManager.show('Error rebooting gateway', 'error');
            }
        }

        // Ê∏ÖÈô§NVSÂ≠òÂÇ®
        async function clearNVS() {
            const confirmed = await confirmDialog.show(
                'Clear NVS Storage',
                'Are you sure you want to clear NVS storage? This will permanently delete all saved configurations including WiFi settings, device configurations, and actions. The gateway will reboot automatically after clearing.',
                'Clear & Reboot',
                'Cancel',
                'danger'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/clear_nvs`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    notificationManager.show('NVS cleared. Gateway is rebooting...', 'info');
                    closeSystemMonitorModal();
                    // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥ÂêéÂ∞ùËØïÈáçÊñ∞ËøûÊé•
                    setTimeout(() => {
                        location.reload();
                    }, 15000);
                } else {
                    notificationManager.show('Failed to clear NVS', 'error');
                }
            } catch (error) {
                console.error('Error clearing NVS:', error);
                notificationManager.show('Error clearing NVS', 'error');
            }
        }

        // Ê†ºÂºèÂåñÂ≠óËäÇÊï∞
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™ó
        class ConfirmDialog {
            constructor() {
                this.isOpen = false;
            }

            show(title, message, confirmText = 'Confirm', cancelText = 'Cancel', type = 'warning') {
                return new Promise((resolve) => {
                    if (this.isOpen) {
                        resolve(false);
                        return;
                    }

                    this.isOpen = true;
                    const overlay = document.createElement('div');
                    overlay.className = 'confirm-overlay';
                    
                    const dialog = document.createElement('div');
                    dialog.className = `confirm-dialog ${type}`;
                    
                    const icon = this.getIcon(type);
                    
                    dialog.innerHTML = `
                        <div class="confirm-header">
                            <div class="confirm-icon">${icon}</div>
                            <h3 class="confirm-title">${title}</h3>
                        </div>
                        <div class="confirm-body">
                            <p class="confirm-message">${message}</p>
                        </div>
                        <div class="confirm-footer">
                            <button class="btn btn-secondary confirm-cancel">${cancelText}</button>
                            <button class="btn ${this.getButtonClass(type)} confirm-ok">${confirmText}</button>
                        </div>
                    `;

                    overlay.appendChild(dialog);
                    document.body.appendChild(overlay);

                    // Ê∑ªÂä†Âä®ÁîªÊïàÊûú
                    setTimeout(() => {
                        overlay.classList.add('show');
                        dialog.classList.add('show');
                    }, 10);

                    // ÁªëÂÆö‰∫ã‰ª∂
                    const cancelBtn = dialog.querySelector('.confirm-cancel');
                    const okBtn = dialog.querySelector('.confirm-ok');

                    const cleanup = () => {
                        this.isOpen = false;
                        overlay.classList.remove('show');
                        dialog.classList.remove('show');
                        setTimeout(() => {
                            if (overlay.parentNode) {
                                overlay.parentNode.removeChild(overlay);
                            }
                        }, 300);
                    };

                    cancelBtn.onclick = () => {
                        cleanup();
                        resolve(false);
                    };

                    okBtn.onclick = () => {
                        cleanup();
                        resolve(true);
                    };

                    // ESCÈîÆÂÖ≥Èó≠
                    const handleKeydown = (e) => {
                        if (e.key === 'Escape') {
                            cleanup();
                            resolve(false);
                            document.removeEventListener('keydown', handleKeydown);
                        }
                    };
                    document.addEventListener('keydown', handleKeydown);

                    // ÁÇπÂáªÈÅÆÁΩ©ÂÖ≥Èó≠
                    overlay.onclick = (e) => {
                        if (e.target === overlay) {
                            cleanup();
                            resolve(false);
                        }
                    };
                });
            }

            getIcon(type) {
                const icons = {
                    warning: '‚ö†Ô∏è',
                    danger: 'üö®',
                    info: '‚ÑπÔ∏è',
                    success: '‚úÖ'
                };
                return icons[type] || icons.warning;
            }

            getButtonClass(type) {
                const classes = {
                    warning: 'btn-warning',
                    danger: 'btn-danger',
                    info: 'btn-primary',
                    success: 'btn-success'
                };
                return classes[type] || 'btn-warning';
            }
        }

        // ÂàõÂª∫ÂÖ®Â±ÄÁ°ÆËÆ§ÂºπÁ™óÂÆû‰æã
        const confirmDialog = new ConfirmDialog();

        // Ê∂àÊÅØÊèêÁ§∫Á≥ªÁªü
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationContainer');
                this.notifications = [];
                this.notificationId = 0;
            }

            show(message, type = 'info', duration = 5000) {
                const notification = this.createNotification(message, type, duration);
                this.container.appendChild(notification);
                this.notifications.push(notification);

                // Ëß¶ÂèëÊòæÁ§∫Âä®Áîª
                setTimeout(() => {
                    notification.classList.add('show');
                }, 10);

                // Ëá™Âä®ÈöêËóè
                if (duration > 0) {
                    this.startProgressBar(notification, duration);
                    setTimeout(() => {
                        this.hide(notification);
                    }, duration);
                }

                return notification;
            }

            createNotification(message, type, duration) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.dataset.id = ++this.notificationId;

                const icon = this.getIcon(type);
                const title = this.getTitle(type);

                notification.innerHTML = `
                    <div class="notification-header">
                        <div class="notification-title">
                            <span class="notification-icon">${icon}</span>
                            ${title}
                        </div>
                        <button class="notification-close" onclick="notificationManager.hide(this.closest('.notification'))">&times;</button>
                    </div>
                    <div class="notification-message">${message}</div>
                    ${duration > 0 ? '<div class="notification-progress" style="width: 100%"></div>' : ''}
                `;

                return notification;
            }

            getIcon(type) {
                const icons = {
                    success: '‚úì',
                    warning: '‚ö†',
                    error: '‚úï',
                    info: '‚Ñπ'
                };
                return icons[type] || icons.info;
            }

            getTitle(type) {
                const titles = {
                    success: 'Success',
                    warning: 'Warning',
                    error: 'Error',
                    info: 'Information'
                };
                return titles[type] || titles.info;
            }

            startProgressBar(notification, duration) {
                const progressBar = notification.querySelector('.notification-progress');
                if (progressBar) {
                    progressBar.style.transition = `width ${duration}ms linear`;
                    setTimeout(() => {
                        progressBar.style.width = '0%';
                    }, 10);
                }
            }

            hide(notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                        this.notifications = this.notifications.filter(n => n !== notification);
                    }
                }, 300);
            }

            showDeviceOnline(deviceName, deviceMac) {
                console.log('=== showDeviceOnline called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', new Error().stack);
                console.log('===================================');
                
                this.show(`Device "${deviceName}" is now online`, 'success');
            }

            showDeviceOffline(deviceName, deviceMac) {
                console.log('=== showDeviceOffline called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', new Error().stack);
                console.log('====================================');
                
                this.show(`Device "${deviceName}" went offline`, 'warning');
            }

            showAutoDiscoveryEnabled(deviceName, deviceMac) {
                console.log('=== showAutoDiscoveryEnabled called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', new Error().stack);
                console.log('========================================');
                
                this.show(`Auto-discovery enabled for device "${deviceName}"`, 'info');
            }

            showAutoDiscoveryDisabled(deviceName, deviceMac) {
                console.log('=== showAutoDiscoveryDisabled called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', new Error().stack);
                console.log('=========================================');
                
                this.show(`Auto-discovery disabled for device "${deviceName}"`, 'info');
            }

            showDeviceDiscovered(deviceName, deviceMac) {
                // Ëé∑ÂèñË∞ÉÁî®Ê†à‰ø°ÊÅØ
                const stack = new Error().stack;
                console.log('=== showDeviceDiscovered called ===');
                console.log('Device Name:', deviceName);
                console.log('Device MAC:', deviceMac);
                console.log('Call Stack:', stack);
                console.log('=====================================');
                
                this.show(`New device discovered: "${deviceName}"`, 'success');
            }

            clear() {
                this.notifications.forEach(notification => {
                    this.hide(notification);
                });
            }
        }

        // ÂÖ®Â±ÄÊ∂àÊÅØÊèêÁ§∫ÁÆ°ÁêÜÂô®
        let notificationManager;

        // Ë°®Ê†ºÊ†áÈ¢òÊéíÂ∫èÂäüËÉΩ
        function handleHeaderClick(sortBy) {
            if (!window.deviceManager || !window.deviceManager.devices) {
                return;
            }
            
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂΩìÂâçÊéíÂ∫èÂàóÔºåÂàôÂàáÊç¢ÊéíÂ∫èÊñπÂêë
            if (window.deviceManager.currentSortBy === sortBy) {
                window.deviceManager.currentSortOrder = 
                    window.deviceManager.currentSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÊñ∞ÂàóÔºåÂàôËÆæÁΩÆ‰∏∫ÈôçÂ∫èÔºàÂêë‰∏äÁÆ≠Â§¥Ë°®Á§∫ÈôçÂ∫èÔºâ
                window.deviceManager.currentSortBy = sortBy;
                window.deviceManager.currentSortOrder = 'desc';
            }
            
            // Êõ¥Êñ∞ÊâÄÊúâË°®Ê†ºÊ†áÈ¢òÁöÑËßÜËßâÁä∂ÊÄÅ
            updateHeaderStates();
            
            // ÊâßË°åÊéíÂ∫èÂπ∂ÈáçÊñ∞Ê∏≤Êüì
            window.deviceManager.sortDevices(
                window.deviceManager.currentSortBy, 
                window.deviceManager.currentSortOrder
            );
            window.deviceManager.renderDevices();
        }

        // Êõ¥Êñ∞Ë°®Ê†ºÊ†áÈ¢òÁöÑËßÜËßâÁä∂ÊÄÅ
        function updateHeaderStates() {
            const headers = document.querySelectorAll('.sortable');
            headers.forEach(header => {
                const sortBy = header.getAttribute('data-sort');
                if (sortBy === window.deviceManager.currentSortBy) {
                    header.setAttribute('data-direction', window.deviceManager.currentSortOrder);
                } else {
                    header.setAttribute('data-direction', 'none');
                }
            });
        }

        // Âú®DemoDeviceManagerÁ±ª‰∏≠Ê∑ªÂä†ÊéíÂ∫èÊñπÊ≥ï
        DemoDeviceManager.prototype.sortDevices = function(sortBy, sortOrder) {
            this.devices.sort((a, b) => {
                let valueA, valueB;
                
                switch (sortBy) {
                    case 'name':
                        valueA = a.name.toLowerCase();
                        valueB = b.name.toLowerCase();
                        break;
                    case 'type':
                        valueA = (a.type || 'Unknown').toLowerCase();
                        valueB = (b.type || 'Unknown').toLowerCase();
                        break;
                    case 'status':
                        valueA = a.isOnline ? 1 : 0;
                        valueB = b.isOnline ? 1 : 0;
                        break;
                    case 'discovery':
                        valueA = a.hasBeenDiscovered ? 1 : 0;
                        valueB = b.hasBeenDiscovered ? 1 : 0;
                        break;
                    default:
                        return 0;
                }
                
                let comparison = 0;
                if (valueA > valueB) {
                    comparison = 1;
                } else if (valueA < valueB) {
                    comparison = -1;
                }
                
                return sortOrder === 'desc' ? -comparison : comparison;
            });
        };

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            // Ê∑ªÂä†È°µÈù¢Âä†ËΩΩË∞ÉËØï‰ø°ÊÅØ
            console.log('DOM Content Loaded');
            console.log('Coloris available:', typeof Coloris !== 'undefined');
            
            // ÂàùÂßãÂåñÈÄöÁü•ÁÆ°ÁêÜÂô®
            notificationManager = new NotificationManager();

            // Âª∂ËøüÂàùÂßãÂåñÈ¢úËâ≤ÈÄâÊã©Âô®ÔºåÁ≠âÂæÖÂèØËÉΩÁöÑÂ§áÁî®CDNÂä†ËΩΩ
            setTimeout(() => {
                initializeColorPicker();
            }, 500);
        });
        
        function initializeColorPicker() {
            console.log('Initializing color picker...');
            
            // ËÆæÁΩÆÈ¢úËâ≤È¢ÑËßàÂùóÁöÑÁÇπÂáª‰∫ã‰ª∂
            const onColorPreview = document.getElementById('onColorPreview');
            const offColorPreview = document.getElementById('offColorPreview');
            const onColorInput = document.getElementById('onColor');
            const offColorInput = document.getElementById('offColor');
            const onColorText = document.getElementById('onColorText');
            const offColorText = document.getElementById('offColorText');
            
            if (onColorPreview && onColorInput && onColorText) {
                onColorPreview.addEventListener('click', function() {
                    console.log('On color preview clicked');
                    onColorInput.click();
                });
                
                onColorInput.addEventListener('change', function() {
                    const color = this.value;
                    console.log('On color changed to:', color);
                    onColorPreview.style.backgroundColor = color;
                    onColorText.value = color.toUpperCase();
                });
                
                // ËÆæÁΩÆÈªòËÆ§È¢úËâ≤
                const defaultOnColor = '#FFFF00';
                onColorInput.value = defaultOnColor;
                onColorPreview.style.backgroundColor = defaultOnColor;
                onColorText.value = defaultOnColor;
            }
            
            if (offColorPreview && offColorInput && offColorText) {
                offColorPreview.addEventListener('click', function() {
                    console.log('Off color preview clicked');
                    offColorInput.click();
                });
                
                offColorInput.addEventListener('change', function() {
                    const color = this.value;
                    console.log('Off color changed to:', color);
                    offColorPreview.style.backgroundColor = color;
                    offColorText.value = color.toUpperCase();
                });
                
                // ËÆæÁΩÆÈªòËÆ§È¢úËâ≤
                const defaultOffColor = '#FF0000';
                offColorInput.value = defaultOffColor;
                offColorPreview.style.backgroundColor = defaultOffColor;
                offColorText.value = defaultOffColor;
            }
            
            console.log('Color picker initialized successfully');
        }
        
        // Ê∑ªÂä†Âä®‰ΩúÂáΩÊï∞
        function addAction() {
            openAddActionModal();
        }

        // ÊâìÂºÄAdd ActionÂºπÁ™ó
        function openAddActionModal() {
            console.log('=== openAddActionModal called ===');
            const modal = document.getElementById('addActionModal');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // Ê∑ªÂä†ËÆæÂ§áÁ±ªÂûã‰∏ãÊãâÂàóË°®ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            const deviceTypeSelect = document.getElementById('deviceType');
            const deviceSelect = document.getElementById('deviceSelect');
            
            console.log('deviceTypeSelect element:', deviceTypeSelect);
            console.log('deviceSelect element:', deviceSelect);
            
            if (!deviceTypeSelect || !deviceSelect) {
                console.error('Could not find dropdown elements in openAddActionModal!');
                return;
            }
            
            // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            deviceTypeSelect.removeEventListener('change', handleDeviceTypeChange);
            deviceSelect.removeEventListener('change', handleDeviceChange);
            
            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            deviceTypeSelect.addEventListener('change', handleDeviceTypeChange);
            deviceSelect.addEventListener('change', handleDeviceChange);
            
            console.log('Added event listeners to dropdown lists');
            
            // Á°Æ‰øùËÆæÂ§áÊï∞ÊçÆÂèØÁî®ÂêéÂÜçÂä†ËΩΩËÆæÂ§áÂàóË°®
            if (window.deviceManager && window.deviceManager.devices && window.deviceManager.devices.length > 0) {
                // Â¶ÇÊûúËÆæÂ§áÁÆ°ÁêÜÂô®ÊúâÊï∞ÊçÆÔºåÁ°Æ‰øùwindow.devicesData‰πüÊúâÊï∞ÊçÆ
                window.devicesData = window.deviceManager.devices;
                // console.log('Using existing device data from deviceManager');
                loadDevicesForModal();
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºåÂ∞ùËØïÂº∫Âà∂‰ªéÁΩëÂÖ≥Âä†ËΩΩ
                console.log('No device data available, forcing load from gateway...');
                if (window.deviceManager) {
                    window.deviceManager.loadDevicesFromGateway(true).then(() => {
                        // Âä†ËΩΩÂÆåÊàêÂêéÂÜçÂ°´ÂÖÖ‰∏ãÊãâÂàóË°®
                        setTimeout(() => {
                            window.devicesData = window.deviceManager.devices;
                            console.log('Device data loaded from gateway, calling loadDevicesForModal');
                            loadDevicesForModal();
                        }, 500);
                    }).catch((error) => {
                        console.error('Failed to load devices from gateway:', error);
                        // Â¶ÇÊûúWebSocketÊñπÂºèÂ§±Ë¥•ÔºåÂ∞ùËØïHTTPÊñπÂºè
                        loadDevicesForModal();
                    });
                } else {
                    // console.log('No deviceManager available, trying HTTP method');
                    // Â¶ÇÊûúËÆæÂ§áÁÆ°ÁêÜÂô®‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•Â∞ùËØïHTTPÊñπÂºè
                    loadDevicesForModal();
                }
            }
        }

        // ÂÖ≥Èó≠Add ActionÂºπÁ™ó
        function closeAddActionModal() {
            const modal = document.getElementById('addActionModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                // Ê∏ÖÁ©∫Ë°®Âçï
                document.getElementById('addActionForm').reset();
            }, 400);
        }

        // Âä†ËΩΩËÆæÂ§áÂàóË°®Âà∞‰∏ãÊãâÊ°Ü
        function loadDevicesForModal() {
            console.log('=== loadDevicesForModal called ===');
            
            const deviceSelect = document.getElementById('deviceSelect');
            const deviceTypeSelect = document.getElementById('deviceType');
            
            if (!deviceSelect || !deviceTypeSelect) {
                console.error('Could not find dropdown elements!');
                return;
            }
            
            console.log('Found dropdown elements, clearing options...');
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
            deviceSelect.innerHTML = '<option value="">Select a device...</option>';
            deviceTypeSelect.innerHTML = '<option value="">Select device type...</option>';
            
            // Áõ¥Êé•‰ªéAPIËé∑ÂèñÊúÄÊñ∞ÁöÑËÆæÂ§áÊï∞ÊçÆ
            console.log('Fetching fresh device data from API...');
            fetch(getGatewayUrl() + '/api/devices')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(devices => {
                    console.log('Fetched devices from server:', devices);
                    
                    if (!devices || devices.length === 0) {
                        console.log('No devices returned from API');
                        return;
                    }
                    
                    const deviceTypes = new Set();
                    let onlineDeviceCount = 0;
                    
                    devices.forEach((device, index) => {
                        console.log(`Processing device ${index}:`, {
                            name: device.name,
                            nodeId: device.nodeId,
                            type: device.type,
                            online: device.online
                        });
                        
                        // Âè™Ê∑ªÂä†Âú®Á∫øËÆæÂ§áÂà∞ËÆæÂ§áÂàóË°®
                        if (device.online === true) {
                            onlineDeviceCount++;
                            const option = document.createElement('option');
                            option.value = device.nodeId;
                            option.textContent = `${device.name || 'Device'} (${device.nodeId})`;
                            deviceSelect.appendChild(option);
                            console.log('Added online device to dropdown:', device.name);
                        }
                        
                        // Êî∂ÈõÜÊâÄÊúâËÆæÂ§áÁ±ªÂûãÔºàÂåÖÊã¨Á¶ªÁ∫øËÆæÂ§áÁöÑÁ±ªÂûãÔºâ
                        if (device.type && device.type !== 'Unknown' && device.type.trim() !== '') {
                            deviceTypes.add(device.type);
                            console.log('Added device type:', device.type);
                        }
                    });
                    
                    console.log('Total online devices added:', onlineDeviceCount);
                    console.log('Found device types:', Array.from(deviceTypes));
                    
                    // Ê∑ªÂä†ËÆæÂ§áÁ±ªÂûãÈÄâÈ°π
                    if (deviceTypes.size > 0) {
                        Array.from(deviceTypes).sort().forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            deviceTypeSelect.appendChild(option);
                            console.log('Added device type option:', type);
                        });
                    } else {
                        console.log('No device types found');
                    }
                })
                .catch(error => {
                    console.error('Error loading devices from API:', error);
                    
                    // Â¶ÇÊûúAPIË∞ÉÁî®Â§±Ë¥•ÔºåÂ∞ùËØï‰ΩøÁî®ÁºìÂ≠òÁöÑËÆæÂ§áÊï∞ÊçÆ
                    console.log('Falling back to cached device data...');
                    let devicesData = null;
                    if (window.deviceManager && window.deviceManager.devices && window.deviceManager.devices.length > 0) {
                        devicesData = window.deviceManager.devices;
                        // console.log('Using deviceManager.devices, count:', devicesData.length);
                    } else if (window.devicesData && window.devicesData.length > 0) {
                        devicesData = window.devicesData;
                        console.log('Using window.devicesData, count:', devicesData.length);
                    }
                    
                    if (devicesData && devicesData.length > 0) {
                        const deviceTypes = new Set();
                        let onlineDeviceCount = 0;
                        
                        devicesData.forEach((device, index) => {
                            // Âè™Ê∑ªÂä†Âú®Á∫øËÆæÂ§áÂà∞ËÆæÂ§áÂàóË°®
                            if (device.isOnline || device.online) {
                                onlineDeviceCount++;
                                const option = document.createElement('option');
                                option.value = device.nodeId;
                                option.textContent = `${device.name || 'Device'} (${device.nodeId})`;
                                deviceSelect.appendChild(option);
                            }
                            
                            // Êî∂ÈõÜÊâÄÊúâËÆæÂ§áÁ±ªÂûã
                            if (device.type && device.type !== 'Unknown' && device.type.trim() !== '') {
                                deviceTypes.add(device.type);
                            }
                        });
                        
                        // Ê∑ªÂä†ËÆæÂ§áÁ±ªÂûãÈÄâÈ°π
                        Array.from(deviceTypes).sort().forEach(type => {
                            const option = document.createElement('option');
                            option.value = type;
                            option.textContent = type;
                            deviceTypeSelect.appendChild(option);
                        });
                    }
                });
        }

        // Â§ÑÁêÜËÆæÂ§áÁ±ªÂûã‰∏ãÊãâÂàóË°®ÂèòÂåñ‰∫ã‰ª∂
        function handleDeviceTypeChange(event) {
            console.log('=== handleDeviceTypeChange triggered ===');
            const selectedType = event.target.value;
            console.log('Device type changed to:', selectedType);
            console.log('Event target:', event.target);
            
            if (selectedType) {
                // Ê†πÊçÆÈÄâÊã©ÁöÑËÆæÂ§áÁ±ªÂûãËøáÊª§ËÆæÂ§áÂàóË°®
                console.log('Filtering devices by type:', selectedType);
                filterDevicesByType(selectedType);
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©Á±ªÂûãÔºåÊòæÁ§∫ÊâÄÊúâÂú®Á∫øËÆæÂ§á
                console.log('No type selected, loading all devices');
                loadDevicesForModal();
            }
        }

        // Â§ÑÁêÜËÆæÂ§á‰∏ãÊãâÂàóË°®ÂèòÂåñ‰∫ã‰ª∂
        function handleDeviceChange(event) {
            console.log('=== handleDeviceChange triggered ===');
            const selectedDevice = event.target.value;
            console.log('Device changed to:', selectedDevice);
            console.log('Event target:', event.target);
            
            if (selectedDevice) {
                // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ËÆæÂ§áÈÄâÊã©ÂêéÁöÑÈÄªËæë
                const deviceData = getDeviceById(selectedDevice);
                if (deviceData) {
                    console.log('Selected device data:', deviceData);
                } else {
                    console.log('Could not find device data for ID:', selectedDevice);
                }
            }
        }

        // Ê†πÊçÆËÆæÂ§áÁ±ªÂûãËøáÊª§ËÆæÂ§áÂàóË°®
        function filterDevicesByType(deviceType) {
            console.log('Filtering devices by type:', deviceType);
            
            const deviceSelect = document.getElementById('deviceSelect');
            deviceSelect.innerHTML = '<option value="">Select a device...</option>';
            
            // Ëé∑ÂèñËÆæÂ§áÊï∞ÊçÆ
            let devicesData = null;
            if (window.deviceManager && window.deviceManager.devices && window.deviceManager.devices.length > 0) {
                devicesData = window.deviceManager.devices;
            } else if (window.devicesData && window.devicesData.length > 0) {
                devicesData = window.devicesData;
            }
            
            if (devicesData) {
                const filteredDevices = devicesData.filter(device => 
                    device.type === deviceType && (device.isOnline || device.online)
                );
                
                console.log(`Found ${filteredDevices.length} devices of type ${deviceType}`);
                
                filteredDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.nodeId;
                    option.textContent = `${device.name || 'Device'} (${device.nodeId})`;
                    deviceSelect.appendChild(option);
                });
            }
        }

        // Ê†πÊçÆËÆæÂ§áIDËé∑ÂèñËÆæÂ§áÊï∞ÊçÆ
        function getDeviceById(deviceId) {
            let devicesData = null;
            if (window.deviceManager && window.deviceManager.devices && window.deviceManager.devices.length > 0) {
                devicesData = window.deviceManager.devices;
            } else if (window.devicesData && window.devicesData.length > 0) {
                devicesData = window.devicesData;
            }
            
            if (devicesData) {
                return devicesData.find(device => device.nodeId == deviceId);
            }
            return null;
        }

        // ËÆæÁΩÆÂëΩ‰ª§Âà∞ËæìÂÖ•Ê°Ü
        function setCommand(command) {
            const commandInput = document.getElementById('commandInput');
            const currentValue = commandInput.value;

            if (currentValue === '') {
                // If empty, just set the command
                commandInput.value = command;
            } else {
                // If not empty...
                if (command === ',') {
                    // If the new command is a comma...
                    if (!currentValue.endsWith(',')) {
                        // and it doesn't already end with a comma, add it.
                        commandInput.value += ',';
                    }
                } else {
                    // If the new command is not a comma...
                    if (currentValue.endsWith(',')) {
                        // and the input already ends with a comma, just add the command.
                        commandInput.value += command;
                    } else {
                        // otherwise, add a comma separator then the command.
                        commandInput.value += ',' + command;
                    }
                }
            }
        }

        // Âà†Èô§‰∏ä‰∏ÄÊ¨°ËæìÂÖ•ÁöÑÂëΩ‰ª§
        function clearCommand() {
            const commandInput = document.getElementById('commandInput');
            const currentValue = commandInput.value;
            const commands = currentValue.split(',').filter(c => c.trim() !== ''); // split by comma and remove empty parts

            if (commands.length > 0) {
                commands.pop(); // remove the last command
                commandInput.value = commands.join(','); // join back with comma
            }
        }

        // Â∞ÜÂëΩ‰ª§ÊöÇÂ≠òÂà∞ÊöÇÂ≠òÂå∫
        function stageCommand() {
            const deviceTypeSelect = document.getElementById('deviceType');
            const deviceSelect = document.getElementById('deviceSelect');
            const actionTypeSelect = document.getElementById('actionType');
            const commandInput = document.getElementById('commandInput');
            const stagedCommandsList = document.getElementById('staged-commands-list');

            const deviceType = deviceTypeSelect.value;
            const deviceId = deviceSelect.value;
            const actionType = actionTypeSelect.value;
            const commandText = commandInput.value;

            if (!deviceType || !deviceId || !actionType || !commandText) {
                notificationManager.show('Please ensure "Device Type", "Device", "Action Type", and "Command" are all filled out.', 'error');
                return;
            }

            const selectedOption = deviceSelect.options[deviceSelect.selectedIndex];
            const deviceName = selectedOption.text.split(' (')[0];
            const command = commandInput.value;

            // Find the device to get the MAC address
            const deviceData = getDeviceById(deviceId);
            if (!deviceData) {
                console.error('Could not find device data for ID:', deviceId);
                notificationManager.show('Could not find device data. Please select a valid device.', 'error');
                return;
            }
            const macAddress = deviceData.macAddress;

            if (deviceId && command) {
                const stagedCommand = document.createElement('div');
                stagedCommand.classList.add('staged-command');
                stagedCommand.dataset.deviceId = deviceId; // Store deviceId
                stagedCommand.dataset.mac = macAddress; // Store mac address
                stagedCommand.dataset.name = deviceName; // Store clean name
                stagedCommand.innerHTML = `
                    <span><strong>${deviceName}</strong>: ${command}</span>
                    <div class="staged-command-buttons">
                        <button class="staged-command-btn staged-command-edit" onclick="editStagedCommand(this)">Edit</button>
                        <button class="staged-command-btn staged-command-delete" onclick="deleteStagedCommand(this)">Delete</button>
                    </div>
                `;
                stagedCommandsList.appendChild(stagedCommand);

                // Ê∏ÖÁ©∫ÂëΩ‰ª§ËæìÂÖ•Ê°Ü‰ª•‰æøËæìÂÖ•‰∏ã‰∏Ä‰∏™ÂëΩ‰ª§
                commandInput.value = '';
            }
        }

        // Á´ãÂç≥ÊâßË°åÂëΩ‰ª§
        function executeCommand() {
            const stagedCommandsList = document.getElementById('staged-commands-list');
            const stagedCommands = stagedCommandsList.querySelectorAll('.staged-command');

            if (stagedCommands.length === 0) {
                alert('No commands to execute.');
                return;
            }

            const payload = Array.from(stagedCommands).map(stagedCommand => {
                const deviceName = stagedCommand.dataset.name;
                const commandText = stagedCommand.querySelector('span').innerText.split(': ')[1];
                const macAddress = stagedCommand.dataset.mac;

                return {
                    name: deviceName,
                    mac: macAddress,
                    states: commandText.split(',').map(s => s.trim())
                };
            });

            const message = {
                command: "sendMessage",
                payload: {
                    isBroadcast: true,
                    message: {
                        cmd: "groupState",
                        payload: payload
                    }
                }
            };

            console.log('WebSocket message to send:', JSON.stringify(message));
            window.deviceManager.sendWebSocketMessage(message);
        }

        // ÁºñËæëÊöÇÂ≠òÁöÑÂëΩ‰ª§
        let currentEditingCommand = null;

        function editStagedCommand(button) {
            currentEditingCommand = button.closest('.staged-command');
            const commandText = currentEditingCommand.querySelector('span').innerText.split(': ')[1];
            
            const commandInput = document.getElementById('editCommandInput');
            commandInput.value = commandText;
            
            // Ê∏ÖÈô§‰ªª‰ΩïÈ™åËØÅÁä∂ÊÄÅÂíåÊ∂àÊÅØ
            commandInput.setCustomValidity('');
            commandInput.removeAttribute('required');
            
            // Ê∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨Âô®
            commandInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    saveStagedCommand(e);
                    return false;
                }
            });
            
            const modal = document.getElementById('editStagedCommandModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeEditStagedCommandModal() {
            const modal = document.getElementById('editStagedCommandModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 400);
            currentEditingCommand = null;
        }

        function saveStagedCommand(event) {
            // ÈòªÊ≠¢‰ªª‰ΩïÈªòËÆ§ÁöÑË°®ÂçïÊèê‰∫§Ë°å‰∏∫
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (currentEditingCommand) {
                const commandInput = document.getElementById('editCommandInput');
                // ÁßªÈô§‰ªª‰ΩïÂèØËÉΩÁöÑÈ™åËØÅÁä∂ÊÄÅ
                commandInput.setCustomValidity('');
                
                const newCommandText = commandInput.value.trim();
                if (newCommandText === '') {
                    // Â¶ÇÊûúÂëΩ‰ª§‰∏∫Á©∫Ôºå‰∏ç‰øùÂ≠òÂπ∂ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    closeEditStagedCommandModal();
                    return false;
                }
                const deviceName = currentEditingCommand.dataset.name;
                currentEditingCommand.querySelector('span').innerHTML = `<strong>${deviceName}</strong>: ${newCommandText}`;
            }
            closeEditStagedCommandModal();
            return false;
        }

        function setCommandInEdit(command) {
            const commandInput = document.getElementById('editCommandInput');
            const currentValue = commandInput.value.trim();

            if (currentValue === '') {
                commandInput.value = command;
            } else {
                if (command === ',') {
                    if (!currentValue.endsWith(',')) {
                        commandInput.value += ',';
                    }
                } else {
                    if (currentValue.endsWith(',')) {
                        commandInput.value += command;
                    } else {
                        commandInput.value += ',' + command;
                    }
                }
            }
        }

        function clearCommandInEdit() {
            const commandInput = document.getElementById('editCommandInput');
            const currentValue = commandInput.value;
            const commands = currentValue.split(',').filter(c => c.trim() !== '');

            if (commands.length > 0) {
                commands.pop();
                commandInput.value = commands.join(',');
            }
        }

        // Âà†Èô§ÊöÇÂ≠òÁöÑÂëΩ‰ª§
        function deleteStagedCommand(button) {
            button.parentElement.parentElement.remove();
        }

        // ‰øùÂ≠òÂä®‰Ωú
        function saveAction() {
            const stagedCommandsList = document.getElementById('staged-commands-list');
            const stagedCommands = stagedCommandsList.querySelectorAll('.staged-command');

            if (stagedCommands.length === 0) {
                notificationManager.show('No staged commands to save. Please add commands first.', 'error');
                return;
            }

            // Ëé∑ÂèñactionNameËæìÂÖ•Ê°ÜÁöÑÂÄº
            const actionNameInput = document.getElementById('actionName');
            const actionName = actionNameInput ? actionNameInput.value.trim() : '';

            // ÊûÑÂª∫payloadÊï∞ÁªÑÔºå‰ªéÊöÇÂ≠òÂëΩ‰ª§‰∏≠Ëé∑ÂèñÊï∞ÊçÆ
            const payload = Array.from(stagedCommands).map(stagedCommand => {
                const deviceName = stagedCommand.dataset.name;
                const commandText = stagedCommand.querySelector('span').innerText.split(': ')[1];
                const macAddress = stagedCommand.dataset.mac;

                return {
                    name: deviceName,
                    mac: macAddress,
                    states: commandText.split(',').map(s => s.trim())
                };
            });

            // ÊûÑÂª∫ÊåáÂÆöÊ†ºÂºèÁöÑJSON
            const jsonOutput = {
                command: "saveAction",
                payload: {
                    isBroadcast: true,
                    message: {
                        cmd: "groupState",
                        payload: payload
                    }
                }
            };

            // Â¶ÇÊûúÊèê‰æõ‰∫ÜactionNameÔºåÊ∑ªÂä†Âà∞JSON‰∏≠
            if (actionName.length > 0) {
                jsonOutput.actionName = actionName;
            }

            // ÊâìÂç∞Âà∞ÊéßÂà∂Âè∞
            console.log('Sending saveAction JSON:', JSON.stringify(jsonOutput));
            
            // ÂèëÈÄÅÂà∞ÁΩëÂÖ≥
            if (window.deviceManager && window.deviceManager.sendWebSocketMessage(jsonOutput)) {
                notificationManager.show('Action saved and sent to gateway successfully!', 'success');
                
                // Ê∑ªÂä†Âª∂ËøüÂêéËá™Âä®Âà∑Êñ∞Âä®‰ΩúÂàóË°®
                setTimeout(() => {
                    loadActions();
                    console.log('Auto-refreshing actions list after save');
                }, 500); // 500msÂª∂ËøüÁ°Æ‰øùÁΩëÂÖ≥ÊúâÊó∂Èó¥Â§ÑÁêÜËØ∑Ê±Ç
            } else {
                notificationManager.show('Action saved but failed to send to gateway. Check WebSocket connection.', 'warning');
            }
            
            closeAddActionModal();
        }

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠ÂºπÁ™ó
        window.onclick = function(event) {
            const modal = document.getElementById('addActionModal');
            if (event.target === modal) {
                closeAddActionModal();
            }
        }
        
        // ÈáçÂêØÁΩëÂÖ≥ÂáΩÊï∞
        function restartGateway() {
            if (confirm('Are you sure you want to restart the gateway? This will temporarily disconnect all devices.')) {
                notificationManager.show('Restarting gateway...', 'info');
                
                const gatewayUrl = getGatewayUrl();
                fetch(`${gatewayUrl}/restart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        notificationManager.show('Gateway restart initiated. The page will reload in 10 seconds.', 'success');
                        setTimeout(() => {
                            window.location.reload();
                        }, 10000);
                    } else {
                        throw new Error('Failed to restart gateway');
                    }
                })
                .catch(error => {
                    console.error('Error restarting gateway:', error);
                    notificationManager.show('Failed to restart gateway. Please try again.', 'error');
                });
            }
        }
    </script>

    <script>
        // ËÆæÂ§áÂàóË°®Ëá™Âä®ÊªöÂä®ÂäüËÉΩ
        let scrollInterval = null;
        const scrollSpeed = 1; // ÊªöÂä®ÈÄüÂ∫¶
        
        function startScroll(element) {
            if (element.scrollHeight > element.clientHeight) {
                // Âè™ÊúâÂΩìÂÜÖÂÆπË∂ÖÂá∫ÂèØËßÜÂå∫ÂüüÊó∂ÊâçÂêØÂä®ÊªöÂä®
                let scrollPosition = 0;
                let scrollDirection = 1; // 1Âêë‰∏ãÊªöÂä®Ôºå-1Âêë‰∏äÊªöÂä®
                
                scrollInterval = setInterval(() => {
                    scrollPosition += scrollDirection * scrollSpeed;
                    element.scrollTop = scrollPosition;
                    
                    // ÂΩìÊªöÂä®Âà∞Â∫ïÈÉ®Êó∂ÔºåÊîπÂèòÊñπÂêë
                    if (scrollPosition >= (element.scrollHeight - element.clientHeight)) {
                        scrollDirection = -1;
                    }
                    // ÂΩìÊªöÂä®Âà∞È°∂ÈÉ®Êó∂ÔºåÊîπÂèòÊñπÂêë
                    else if (scrollPosition <= 0) {
                        scrollDirection = 1;
                    }
                }, 50);
            }
        }
        
        function stopScroll(element) {
            if (scrollInterval) {
                clearInterval(scrollInterval);
                scrollInterval = null;
            }
        }
    </script>

    <div id="ledConfigModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>LED Configuration</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label for="onColor">On Color:</label>
                    <div class="color-input-container">
                        <div id="onColorPreview" class="color-preview" style="cursor: pointer;"></div>
                        <input type="color" id="onColor" name="onColor">
                        <input type="text" id="onColorText" name="onColorText" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                </div>
                <div class="config-item">
                    <label for="offColor">Off Color:</label>
                    <div class="color-input-container">
                        <div id="offColorPreview" class="color-preview" style="cursor: pointer;"></div>
                        <input type="color" id="offColor" name="offColor">
                        <input type="text" id="offColorText" name="offColorText" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                </div>
                <div class="config-item">
                    <label for="brightness_on">On Brightness: <span id="brightness_on_value">(0)</span></label>
                    <input type="range" id="brightness_on" name="brightness_on" min="0" max="255">
                </div>
                <div class="config-item">
                    <label for="brightness_off">Off Brightness: <span id="brightness_off_value">(0)</span></label>
                    <input type="range" id="brightness_off" name="brightness_off" min="0" max="255">
                </div>
                <div class="config-item" style="grid-column: 1 / span 2;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label for="isDaytime">Is Daytime:</label>
                            <input type="text" id="isDaytime" readonly style="width: 100%;">
                        </div>
                        <div>
                            <label for="linkedSensor">Linked Sensor:</label>
                            <select id="linkedSensor" style="width: 100%;"></select>
                        </div>
                        <div>
                            <label for="daylightThreshold">Daylight Threshold:</label>
                            <input type="number" id="daylightThreshold" style="width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
            <div class="button-container">
                <button id="cancelLedConfig" class="cancel-button">Cancel</button>
                <button id="saveLedConfig" class="save-button">Save</button>
            </div>
        </div>
    </div>

    <!-- Add Action Modal -->
    <div id="addActionModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Action</h2>
                <span class="close-modal" onclick="closeAddActionModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addActionForm">
                    <div class="form-group">
                        <label for="actionName">Action Name:</label>
                        <input type="text" id="actionName" name="actionName" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="deviceType">Device Type:</label>
                            <select id="deviceType" name="deviceType" required>
                                <option value="">Select device type...</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="deviceSelect">Device:</label>
                            <select id="deviceSelect" name="deviceSelect" required>
                                <option value="">Select a device...</option>
                                <!-- Options will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="actionType">Action Type:</label>
                        <select id="actionType" name="actionType" required>
                            <option value="">Select action type...</option>
                            <option value="action">Action</option>
                            <option value="servoControl">Servo Control</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="commandInput">Command:</label>
                        <input type="text" id="commandInput" name="commandInput" placeholder="Enter command..." required>
                    </div>

                    <div id="staged-commands-container" class="form-group">
                        <p><strong>Staged Commands:</strong></p>
                        <div id="staged-commands-list"></div>
                    </div>
                    
                    
                    <div class="form-group">
                        <div class="command-examples">
                            <p><strong>Command Examples:</strong></p>
                            <div class="example-section">
                                <span class="example-tag" onclick="setCommand('on')">on</span>
                                <span class="example-tag" onclick="setCommand('off')">off</span>
                                <span class="example-tag" onclick="setCommand('ignore')">ignore</span>
                                <span class="example-tag" onclick="setCommand('toggle')">toggle</span>
                                <span class="example-tag" onclick="setCommand('action')">action</span>
                                <span class="example-tag" onclick="setCommand('angle')">angle</span>
                                <span class="example-tag" onclick="setCommand('set_angle')">set_angle</span>
                                <span class="example-tag" onclick="setCommand('back_forth')">back_forth</span>
                                <span class="example-tag" onclick="setCommand('sequence')">sequence</span>
                                <span class="example-tag" onclick="setCommand('repeat')">repeat</span>
                                <span class="example-tag" onclick="setCommand('delay')">delay</span>
                                <span class="example-tag" onclick="setCommand(',')">,</span>
                                <span class="example-tag" onclick="clearCommand()">Delete</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-button" onclick="stageCommand()">Stage Command</button>
                <button type="button" class="modal-button" onclick="executeCommand()">Execute Immediately</button>
                <button type="button" class="modal-button" onclick="saveAction()">Save Action</button>
                <button type="button" class="modal-button cancel-button" onclick="closeAddActionModal()">Cancel</button>
            </div>
            </div>
        </div>
    </div>

    <!-- Edit Staged Command Modal -->
    <div id="editStagedCommandModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Staged Command</h2>
                <span class="close-button" onclick="closeEditStagedCommandModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="editCommandInput">Command:</label>
                    <input type="text" id="editCommandInput" class="form-control" autocomplete="off" spellcheck="false">
                </div>
                <div class="form-group">
                    <div class="command-examples">
                        <p><strong>Command Examples:</strong></p>
                        <div class="example-section">
                            <span class="example-tag" onclick="setCommandInEdit('on')">on</span>
                            <span class="example-tag" onclick="setCommandInEdit('off')">off</span>
                            <span class="example-tag" onclick="setCommandInEdit('ignore')">ignore</span>
                            <span class="example-tag" onclick="setCommandInEdit('toggle')">toggle</span>
                            <span class="example-tag" onclick="setCommandInEdit('action')">action</span>
                            <span class="example-tag" onclick="setCommandInEdit('angle')">angle</span>
                            <span class="example-tag" onclick="setCommandInEdit('set_angle')">set_angle</span>
                            <span class="example-tag" onclick="setCommandInEdit('scan')">scan</span>
                            <span class="example-tag" onclick="setCommandInEdit('round-trip')">round-trip</span>
                            <span class="example-tag" onclick="setCommandInEdit('continuous')">continuous</span>
                            <span class="example-tag" onclick="setCommandInEdit('repeat')">repeat</span>
                            <span class="example-tag" onclick="setCommandInEdit(',')">,</span>
                            <span class="example-tag" onclick="clearCommandInEdit()">Delete</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditStagedCommandModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStagedCommand()">Save</button>
            </div>
        </div>
    </div>

    <!-- OTA Upgrade Modal -->
    <div id="otaUpgradeModal" class="modal" onclick="closeOTAUpgradeModal()">
        <div class="modal-content" style="max-width: 600px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>OTA Firmware Upgrade</h2>
            </div>
            <div class="modal-body">
                <div id="otaUploadSection">
                    <div class="info-section">
                        <h3>Upload Firmware</h3>
                        <p>Select a firmware file (.bin) to upload to the device.</p>
                        
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="upload-icon">üìÅ</div>
                            <div class="upload-text">
                                <p>Drag and drop firmware file here or click to browse</p>
                                <p class="file-info">Supported format: .bin files</p>
                            </div>
                            <input type="file" id="firmwareFile" accept=".bin" style="display: none;">
                        </div>
                        
                        <div id="selectedFileInfo" class="selected-file-info" style="display: none;">
                            <div class="file-details">
                                <span class="file-name"></span>
                                <span class="file-size"></span>
                            </div>
                            <button class="remove-file-btn" onclick="removeSelectedFile()">√ó</button>
                        </div>
                        
                        <div class="upload-actions">
                            <button id="uploadBtn" class="btn btn-primary" onclick="startOTAUpload()" disabled>
                                Start Upload
                            </button>
                            <button class="btn btn-secondary" onclick="closeOTAUpgradeModal()">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="otaProgressSection" style="display: none;">
                    <div class="info-section">
                        <h3>Upload Progress</h3>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div id="otaProgressBar" class="progress-fill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="otaProgressPercent">0%</span>
                                <span id="otaProgressSize">0 / 0 bytes</span>
                            </div>
                        </div>
                        
                        <div class="upload-status">
                            <div class="status-item">
                                <span class="label">Status:</span>
                                <span id="otaStatus" class="value">Preparing...</span>
                            </div>
                            <div class="status-item">
                                <span class="label">Elapsed Time:</span>
                                <span id="otaElapsedTime" class="value">0s</span>
                            </div>
                            <div class="status-item">
                                <span class="label">File:</span>
                                <span id="otaFileName" class="value">-</span>
                            </div>
                        </div>
                        
                        <div id="otaErrorMessage" class="error-message" style="display: none;"></div>
                        
                        <div class="upload-actions">
                            <button id="otaCancelBtn" class="btn btn-danger" onclick="cancelOTAUpload()">
                                Cancel Upload
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="otaCompleteSection" style="display: none;">
                    <div class="info-section">
                        <div class="success-icon">‚úÖ</div>
                        <h3>Upload Complete</h3>
                        <p>Firmware has been successfully uploaded. The device will reboot automatically.</p>
                        
                        <div class="upload-actions">
                            <button class="btn btn-primary" onclick="closeOTAUpgradeModal()">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Configuration Modal -->
    <div id="networkConfigModal" class="modal" onclick="closeNetworkConfigModal()">
        <div class="modal-content" style="max-width: 700px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>Network Configuration</h2>
            </div>
            <div class="modal-body">
                <div class="config-section">
                    <h3>Gateway Configuration</h3>
                    <div class="form-group">
                        <label for="gatewayAddress">Gateway Address:</label>
                        <input type="text" id="gatewayAddress" class="form-control" placeholder="192.168.1.66" pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                        <small class="form-text text-muted">Enter the IP address for this gateway</small>
                    </div>
                    <div class="config-actions" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="saveGatewayConfig()">Save Gateway Configuration</button>
                    </div>
                </div>
                
                <div class="config-section" style="display: none;">
                    <h3>Mesh Network Settings</h3>
                    <div class="form-group">
                        <label for="meshName">Mesh Name:</label>
                        <input type="text" id="meshName" class="form-control" placeholder="Enter mesh network name">
                    </div>
                    <div class="form-group">
                        <label for="meshPassword">Mesh Password:</label>
                        <input type="password" id="meshPassword" class="form-control" placeholder="Enter mesh password">
                    </div>
                    <div class="form-group">
                        <label for="meshPort">Mesh Port:</label>
                        <input type="number" id="meshPort" class="form-control" placeholder="5555" min="1024" max="65535">
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>MQTT Configuration</h3>
                    <div class="form-group">
                        <label for="mqttEnabled">Enable MQTT:</label>
                        <input type="checkbox" id="mqttEnabled" class="form-checkbox">
                    </div>
                    <div id="mqttSettings" style="display: none;">
                        <div class="form-group">
                            <label for="mqttServer">MQTT Server:</label>
                            <input type="text" id="mqttServer" class="form-control" placeholder="192.168.1.250">
                        </div>
                        <div class="form-group">
                            <label for="mqttPort">MQTT Port:</label>
                            <input type="number" id="mqttPort" class="form-control" placeholder="1883" min="1" max="65535">
                        </div>
                        <div class="form-group">
                            <label for="mqttUsername">Username:</label>
                            <input type="text" id="mqttUsername" class="form-control" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label for="mqttPassword">Password:</label>
                            <input type="password" id="mqttPassword" class="form-control" placeholder="Optional">
                        </div>
                        <div class="form-group" style="display: none;">
                            <label for="mqttTopic">Base Topic:</label>
                            <input type="text" id="mqttTopic" class="form-control" placeholder="mesh/gateway">
                        </div>
                    </div>
                    <div class="config-actions" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="saveMqttConfig()">Save MQTT Configuration</button>
                    </div>
                </div>
                
                <div class="config-actions">
                    <button class="btn btn-secondary" onclick="closeNetworkConfigModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Action Details Modal -->
    <div id="deviceActionDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ËÆæÂ§áÂä®‰ΩúËØ¶ÊÉÖ</h2>
                <span class="close-button" onclick="closeDeviceActionDetailsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="deviceActionDetailsContent" style="background-color: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-button cancel-button" onclick="closeDeviceActionDetailsModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <style>
        /* JSONËØ≠Ê≥ïÈ´ò‰∫ÆÊ†∑Âºè */
        .json-key {
            color: #0066cc;
            font-weight: bold;
        }
        .json-string {
            color: #008000;
        }
        .json-number {
            color: #ff6600;
        }
        .json-boolean {
            color: #b22222;
            font-weight: bold;
        }
        .json-null {
            color: #808080;
            font-style: italic;
        }
        
        /* OTAÂçáÁ∫ßÊ†∑Âºè */
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }
        
        .file-upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        
        .file-upload-area.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        
        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .upload-text p {
            margin: 5px 0;
        }
        
        .file-info {
            color: #666;
            font-size: 14px;
        }
        
        .selected-file-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .file-details {
            display: flex;
            flex-direction: column;
        }
        
        .file-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .file-size {
            color: #666;
            font-size: 14px;
        }
        
        .remove-file-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-file-btn:hover {
            background: #c82333;
        }
        
        .upload-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }
        
        .upload-status {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .status-item:last-child {
            margin-bottom: 0;
        }
        
        .status-item .label {
            font-weight: bold;
        }
        
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }
        
        .success-icon {
            font-size: 64px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-primary:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
            transition: all 0.3s ease;
        }

        /* ‰∏∫ÊâÄÊúâÊåâÈíÆÊ∑ªÂä†Âü∫Á°ÄËøáÊ∏°ÊïàÊûú */
        .btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* ‰∏∫ÈáçÂêØÂíåÊ∏ÖÈô§NVSÊåâÈíÆÊ∑ªÂä†ÁâπÊÆäÁöÑÊÇ¨ÂÅúÊïàÊûú */
        .btn-warning:hover::before,
        .btn-danger:hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 0.6s ease-in-out;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Â¢ûÂº∫ÊåâÈíÆÁöÑÊ¥ªË∑ÉÁä∂ÊÄÅÊïàÊûú */
        .btn-warning:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(255, 193, 7, 0.4);
        }

        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);
        }

        /* Ëá™ÂÆö‰πâÁ°ÆËÆ§ÂºπÁ™óÊ†∑Âºè */
        .confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .confirm-overlay.show {
            opacity: 1;
        }

        .confirm-dialog {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.8) translateY(-20px);
            transition: all 0.3s ease;
        }

        .confirm-dialog.show {
            transform: scale(1) translateY(0);
        }

        .confirm-header {
            padding: 24px 24px 16px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .confirm-icon {
            font-size: 48px;
            margin-bottom: 12px;
            line-height: 1;
        }

        .confirm-title {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #495057;
        }

        .confirm-body {
            padding: 20px 24px;
        }

        .confirm-message {
            margin: 0;
            font-size: 16px;
            line-height: 1.5;
            color: #6c757d;
            text-align: center;
        }

        .confirm-footer {
            padding: 16px 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-footer .btn {
            min-width: 100px;
            padding: 10px 20px;
            font-weight: 500;
        }

        /* ‰∏çÂêåÁ±ªÂûãÁöÑÁ°ÆËÆ§ÂºπÁ™óÊ†∑Âºè */
        .confirm-dialog.warning .confirm-header {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .confirm-dialog.danger .confirm-header {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .confirm-dialog.info .confirm-header {
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .confirm-dialog.success .confirm-header {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
    </style>

    <script>
        // ÊòæÁ§∫ËÆæÂ§áÂä®‰ΩúËØ¶ÊÉÖ
        function showDeviceActionDetails(actionId, deviceIndex) {
            console.log('showDeviceActionDetails Ë¢´Ë∞ÉÁî®:', actionId, deviceIndex);
            
            try {
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                console.log('‰ªélocalStorageËé∑ÂèñÁöÑactions:', actions);
                
                // ‰ΩøÁî®actionIdÊü•ÊâæactionÔºåÂèØËÉΩÊòØnameÊàñactionName
                const action = actions.find(a => a.id === actionId || a.name === actionId || a.actionName === actionId);
                console.log('ÊâæÂà∞ÁöÑaction:', action);
                
                if (action && action.payload && action.payload.message && action.payload.message.payload) {
                    console.log('action.payload.message.payload:', action.payload.message.payload);
                    const deviceData = action.payload.message.payload[deviceIndex];
                    console.log('deviceIndex:', deviceIndex, 'ÂØπÂ∫îÁöÑdeviceData:', deviceData);
                    
                    if (deviceData) {
                        // Ê†ºÂºèÂåñJSONÊï∞ÊçÆ
                        const formattedJson = JSON.stringify(deviceData, null, 2);
                        
                        // ÁæéÂåñJSONÊòæÁ§∫
                        const coloredJson = syntaxHighlightJson(formattedJson);
                        document.getElementById('deviceActionDetailsContent').innerHTML = coloredJson;
                        
                        // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                        const modal = document.getElementById('deviceActionDetailsModal');
                        modal.style.display = 'block';
                        setTimeout(() => modal.classList.add('show'), 10);
                    } else {
                        console.error('deviceData‰∏çÂ≠òÂú®');
                    }
                } else {
                    console.error('actionÊï∞ÊçÆÁªìÊûÑ‰∏çÂÆåÊï¥');
                }
            } catch (error) {
                console.error('showDeviceActionDetailsÂá∫Èîô:', error);
            }
        }
        
        // ÊâßË°åËÆæÂ§áÂä®‰ΩúÁöÑÂáΩÊï∞
        function executeDeviceAction(actionId, deviceIndex) {
            console.log('executeDeviceAction Ë¢´Ë∞ÉÁî®:', actionId, deviceIndex);
            
            try {
                const actions = JSON.parse(localStorage.getItem('actions')) || [];
                console.log('‰ªélocalStorageËé∑ÂèñÁöÑactions:', actions);
                
                // ‰ΩøÁî®actionIdÊü•ÊâæactionÔºåÂèØËÉΩÊòØnameÊàñactionName
                const action = actions.find(a => a.id === actionId || a.name === actionId || a.actionName === actionId);
                console.log('ÊâæÂà∞ÁöÑactionÂØπË±°:', action);
                
                if (!action) {
                    console.error('Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑaction:', actionId);
                    notificationManager.show('Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑÂä®‰ΩúÊï∞ÊçÆ', 'error');
                    return;
                }
                
                // Ëé∑ÂèñactionNameÁî®‰∫éÊâßË°å
                const actionName = action.name || action.actionName;
                console.log('ÊâßË°åÁöÑactionName:', actionName);
                
                if (!actionName) {
                    console.error('Êó†Ê≥ïÁ°ÆÂÆöË¶ÅÊâßË°åÁöÑactionÂêçÁß∞');
                    notificationManager.show('Êó†Ê≥ïÁ°ÆÂÆöË¶ÅÊâßË°åÁöÑÂä®‰ΩúÂêçÁß∞', 'error');
                    return;
                }
                
                // Ëé∑ÂèñËÆæÂ§áÊï∞ÊçÆ
                if (!action.payload || !action.payload.message || !action.payload.message.payload || !Array.isArray(action.payload.message.payload)) {
                    console.error('actionÊï∞ÊçÆÁªìÊûÑ‰∏çÂÆåÊï¥');
                    notificationManager.show('Âä®‰ΩúÊï∞ÊçÆÁªìÊûÑ‰∏çÂÆåÊï¥', 'error');
                    return;
                }
                
                const deviceData = action.payload.message.payload[deviceIndex];
                console.log('ËÆæÂ§áÊï∞ÊçÆ:', deviceData);
                
                if (!deviceData) {
                    console.error(`Êú™ÊâæÂà∞Á¥¢Âºï‰∏∫${deviceIndex}ÁöÑËÆæÂ§áÊï∞ÊçÆ`);
                    notificationManager.show('Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑËÆæÂ§áÊï∞ÊçÆ', 'error');
                    return;
                }
                
                // ÊûÑÂª∫WebSocketÊ∂àÊÅØ
                const message = {
                    command: "sendMessage",
                    payload: {
                        isBroadcast: true,
                        message: {
                            cmd: "groupState",
                            payload: [
                                {
                                    name: deviceData.name,
                                    mac: deviceData.mac,
                                    states: deviceData.states || ["toggle", "toggle", "toggle"]
                                }
                            ]
                        }
                    }
                };
                
                console.log('ÂèëÈÄÅWebSocketÊ∂àÊÅØ:', message);
                
                // ÊòæÁ§∫ÊâßË°å‰∏≠Áä∂ÊÄÅ
                notificationManager.show(`Ê≠£Âú®ÊâßË°åÂä®‰Ωú: ${actionName}...`, 'info');
                
                // ÈÄöËøáWebSocketÂèëÈÄÅÊ∂àÊÅØ
                if (window.deviceManager && window.deviceManager.sendWebSocketMessage(message)) {
                    console.log('WebSocketÊ∂àÊÅØÂèëÈÄÅÊàêÂäü');
                    notificationManager.show(`Âä®‰Ωú "${actionName}" ÊâßË°åÊàêÂäü`, 'success');
                } else {
                    console.error('WebSocketÊ∂àÊÅØÂèëÈÄÅÂ§±Ë¥•');
                    notificationManager.show('WebSocketËøûÊé•Êú™Âª∫Á´ãÊàñÊ∂àÊÅØÂèëÈÄÅÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('ÊâßË°åËÆæÂ§áÂä®‰ΩúÊó∂Âá∫Èîô:', error);
                notificationManager.show(`ÊâßË°åËÆæÂ§áÂä®‰ΩúÊó∂Âá∫Èîô: ${error.message}`, 'error');
            }
        }
        
        // JSONËØ≠Ê≥ïÈ´ò‰∫ÆÂáΩÊï∞
        function syntaxHighlightJson(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        // ÂÖ≥Èó≠ËÆæÂ§áÂä®‰ΩúËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function closeDeviceActionDetailsModal() {
            const modal = document.getElementById('deviceActionDetailsModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 400);
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('deviceActionDetailsModal');
            if (event.target === modal) {
                closeDeviceActionDetailsModal();
            }
        });
        
        // =================================================================================
        // OTAÂçáÁ∫ßÂäüËÉΩ
        // =================================================================================
        let selectedFile = null;
        let otaUploadInterval = null;
        let otaStartTime = null;
        
        // ÊòæÁ§∫OTAÂçáÁ∫ßÊ®°ÊÄÅÊ°Ü
        function showOTAUpgrade() {
            console.log('OTA Upgrade button clicked');
            const modal = document.getElementById('otaUpgradeModal');
            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('show'), 10);
            
            // ÈáçÁΩÆÁïåÈù¢Áä∂ÊÄÅ
            resetOTAInterface();
            setupFileUploadEvents();
        }
        
        // ÂÖ≥Èó≠OTAÂçáÁ∫ßÊ®°ÊÄÅÊ°Ü
        function closeOTAUpgradeModal() {
            const modal = document.getElementById('otaUpgradeModal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 400);
            
            // Ê∏ÖÁêÜÁä∂ÊÄÅ
            if (otaUploadInterval) {
                clearInterval(otaUploadInterval);
                otaUploadInterval = null;
            }
            selectedFile = null;
        }
        
        // ÈáçÁΩÆOTAÁïåÈù¢
        function resetOTAInterface() {
            document.getElementById('otaUploadSection').style.display = 'block';
            document.getElementById('otaProgressSection').style.display = 'none';
            document.getElementById('otaCompleteSection').style.display = 'none';
            
            selectedFile = null;
            document.getElementById('selectedFileInfo').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
            
            // ÈáçÁΩÆËøõÂ∫¶Êù°
            document.getElementById('otaProgressBar').style.width = '0%';
            document.getElementById('otaProgressPercent').textContent = '0%';
            document.getElementById('otaProgressSize').textContent = '0 / 0 bytes';
            document.getElementById('otaStatus').textContent = 'Preparing...';
            document.getElementById('otaElapsedTime').textContent = '0s';
            document.getElementById('otaFileName').textContent = '-';
            document.getElementById('otaErrorMessage').style.display = 'none';
        }
        
        // ËÆæÁΩÆÊñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂
        function setupFileUploadEvents() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('firmwareFile');
            
            // ÁÇπÂáª‰∏ä‰º†Âå∫Âüü
            fileUploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // Êñá‰ª∂ÈÄâÊã©
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(e.target.files[0]);
                }
            });
            
            // ÊãñÊãΩ‰∫ã‰ª∂
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('dragover');
            });
            
            fileUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
            });
            
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    handleFileSelection(e.dataTransfer.files[0]);
                }
            });
        }
        
        // Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
        function handleFileSelection(file) {
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.name.toLowerCase().endsWith('.bin')) {
                alert('Please select a .bin firmware file');
                return;
            }
            
            selectedFile = file;
            
            // ÊòæÁ§∫Êñá‰ª∂‰ø°ÊÅØ
            document.querySelector('#selectedFileInfo .file-name').textContent = file.name;
            document.querySelector('#selectedFileInfo .file-size').textContent = formatBytes(file.size);
            document.getElementById('selectedFileInfo').style.display = 'flex';
            document.getElementById('uploadBtn').disabled = false;
            
            console.log('File selected:', file.name, formatBytes(file.size));
        }
        
        // ÁßªÈô§ÈÄâ‰∏≠ÁöÑÊñá‰ª∂
        function removeSelectedFile() {
            selectedFile = null;
            document.getElementById('selectedFileInfo').style.display = 'none';
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('firmwareFile').value = '';
        }
        
        // ÂºÄÂßãOTA‰∏ä‰º†
        async function startOTAUpload() {
            if (!selectedFile) {
                alert('Please select a firmware file first');
                return;
            }
            
            console.log('Starting OTA upload:', selectedFile.name);
            
            // ÂàáÊç¢Âà∞ËøõÂ∫¶ÁïåÈù¢
            document.getElementById('otaUploadSection').style.display = 'none';
            document.getElementById('otaProgressSection').style.display = 'block';
            
            // ËÆæÁΩÆÂàùÂßãÁä∂ÊÄÅ
            document.getElementById('otaFileName').textContent = selectedFile.name;
            document.getElementById('otaStatus').textContent = 'Uploading...';
            otaStartTime = Date.now();
            
            // ÂºÄÂßã‰∏ä‰º†ËøõÂ∫¶ÁõëÊéß
            startProgressMonitoring();
            
            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                
                const gatewayUrl = getGatewayUrl();
                
                // ÊâìÂç∞ËØ∑Ê±ÇËØ¶ÁªÜ‰ø°ÊÅØÂà∞ÊéßÂà∂Âè∞
                console.log('=== OTA Upload Request Details ===');
                console.log('Request URL:', `${gatewayUrl}/update_upload`);
                console.log('Request Method:', 'POST');
                console.log('File Name:', selectedFile.name);
                console.log('File Size:', selectedFile.size, 'bytes');
                console.log('File Type:', selectedFile.type);
                console.log('Request Headers:', {
                    'Content-Type': 'multipart/form-data'
                });
                console.log('FormData Contents:', {
                    file: {
                        name: selectedFile.name,
                        size: selectedFile.size,
                        type: selectedFile.type,
                        lastModified: selectedFile.lastModified
                    }
                });
                console.log('Request Timestamp:', new Date().toISOString());
                console.log('=====================================');
                
                const response = await fetch(`${gatewayUrl}/update_upload`, {
                    method: 'POST',
                    body: formData
                });
                
                let result = null;
                
                // Ê£ÄÊü•ÂìçÂ∫îÊòØÂê¶ÊúâÂÜÖÂÆπ
                if (response.status === 204 || response.headers.get('content-length') === '0') {
                    // 204 No Content ÊàñÁ©∫ÂìçÂ∫îÔºåÂàõÂª∫ÈªòËÆ§ÊàêÂäüÁªìÊûú
                    result = { success: true, message: 'Upload completed successfully' };
                } else {
                    // ÊúâÂìçÂ∫îÂÜÖÂÆπÔºåÂ∞ùËØïËß£ÊûêJSON
                    try {
                        result = await response.json();
                    } catch (jsonError) {
                        console.warn('Failed to parse JSON response, treating as success:', jsonError);
                        result = { success: response.ok, message: response.ok ? 'Upload completed' : 'Upload failed' };
                    }
                }
                
                // ÊâìÂç∞ÂìçÂ∫îËØ¶ÁªÜ‰ø°ÊÅØÂà∞ÊéßÂà∂Âè∞
                console.log('=== OTA Upload Response Details ===');
                console.log('Response Status:', response.status);
                console.log('Response Headers:', Object.fromEntries(response.headers.entries()));
                console.log('Response Data:', result);
                console.log('Response Timestamp:', new Date().toISOString());
                console.log('====================================');
                
                if (result.success) {
                    // ‰∏ä‰º†ÊàêÂäü
                    document.getElementById('otaStatus').textContent = 'Completed';
                    document.getElementById('otaProgressBar').style.width = '100%';
                    document.getElementById('otaProgressPercent').textContent = '100%';
                    
                    setTimeout(() => {
                        document.getElementById('otaProgressSection').style.display = 'none';
                        document.getElementById('otaCompleteSection').style.display = 'block';
                    }, 1000);
                    
                    if (window.notificationManager) {
                        window.notificationManager.show('Firmware uploaded successfully! Device will reboot.', 'success');
                    }
                } else {
                    // ‰∏ä‰º†Â§±Ë¥•
                    showOTAError(result.error || 'Upload failed');
                }
            } catch (error) {
                console.error('OTA upload error:', error);
                showOTAError('Network error: ' + error.message);
            } finally {
                if (otaUploadInterval) {
                    clearInterval(otaUploadInterval);
                    otaUploadInterval = null;
                }
            }
        }
        
        // ÂºÄÂßãËøõÂ∫¶ÁõëÊéß
        function startProgressMonitoring() {
            otaUploadInterval = setInterval(async () => {
                try {
                    const gatewayUrl = getGatewayUrl();
                    
                    // ÊâìÂç∞Áä∂ÊÄÅÊü•ËØ¢ËØ∑Ê±ÇËØ¶ÁªÜ‰ø°ÊÅØÂà∞ÊéßÂà∂Âè∞
                    console.log('=== OTA Status Request Details ===');
                    console.log('Request URL:', `${gatewayUrl}/api/ota_status`);
                    console.log('Request Method:', 'GET');
                    console.log('Request Timestamp:', new Date().toISOString());
                    console.log('===================================');
                    
                    const response = await fetch(`${gatewayUrl}/api/ota_status`);
                    const status = await response.json();
                    
                    // ÊâìÂç∞ÂìçÂ∫îËØ¶ÁªÜ‰ø°ÊÅØÂà∞ÊéßÂà∂Âè∞
                    console.log('=== OTA Status Response Details ===');
                    console.log('Response Status:', response.status);
                    console.log('Response Headers:', Object.fromEntries(response.headers.entries()));
                    console.log('Response Data:', status);
                    console.log('Response Timestamp:', new Date().toISOString());
                    console.log('====================================');
                    
                    // Êõ¥Êñ∞ËøõÂ∫¶
                    if (status.progress !== undefined) {
                        document.getElementById('otaProgressBar').style.width = status.progress + '%';
                        document.getElementById('otaProgressPercent').textContent = Math.round(status.progress) + '%';
                    }
                    
                    if (status.totalSize && status.uploadedSize !== undefined) {
                        document.getElementById('otaProgressSize').textContent = 
                            `${formatBytes(status.uploadedSize)} / ${formatBytes(status.totalSize)}`;
                    }
                    
                    // Êõ¥Êñ∞Áä∂ÊÄÅ
                    if (status.status) {
                        document.getElementById('otaStatus').textContent = status.status;
                    }
                    
                    // Êõ¥Êñ∞Êó∂Èó¥
                    if (otaStartTime) {
                        const elapsed = Math.floor((Date.now() - otaStartTime) / 1000);
                        document.getElementById('otaElapsedTime').textContent = elapsed + 's';
                    }
                    
                    // Ê£ÄÊü•ÈîôËØØ
                    if (status.error) {
                        showOTAError(status.error);
                        clearInterval(otaUploadInterval);
                        otaUploadInterval = null;
                    }
                    
                    // Ê£ÄÊü•ÂÆåÊàêÁä∂ÊÄÅ
                    if (status.status === 'completed' && !status.inProgress) {
                        clearInterval(otaUploadInterval);
                        otaUploadInterval = null;
                    }
                } catch (error) {
                    console.error('Error checking OTA status:', error);
                }
            }, 1000);
        }
        
        // ÊòæÁ§∫OTAÈîôËØØ
        function showOTAError(errorMessage) {
            document.getElementById('otaStatus').textContent = 'Error';
            document.getElementById('otaErrorMessage').textContent = errorMessage;
            document.getElementById('otaErrorMessage').style.display = 'block';
            
            if (window.notificationManager) {
                window.notificationManager.show('OTA Upload Error: ' + errorMessage, 'error');
            }
        }
        
        // ÂèñÊ∂àOTA‰∏ä‰º†
        function cancelOTAUpload() {
            if (otaUploadInterval) {
                clearInterval(otaUploadInterval);
                otaUploadInterval = null;
            }
            
            // ÈáçÁΩÆÂà∞ÂàùÂßãÁä∂ÊÄÅ
            resetOTAInterface();
            
            if (window.notificationManager) {
                window.notificationManager.show('OTA upload cancelled', 'info');
            }
        }
        
        // Ê†ºÂºèÂåñÂ≠óËäÇÊï∞
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Network Configuration Functions
        async function showNetworkConfig() {
            console.log('Network Configuration button clicked');
            
            // Áõ¥Êé•Âä†ËΩΩÁΩëÁªúÈÖçÁΩÆÔºå‰∏çÂÜçËøõË°åÁΩëÂÖ≥ÂèëÁé∞
            loadNetworkConfig();
            const modal = document.getElementById('networkConfigModal');
            modal.style.display = 'block';
            // Ê∑ªÂä†showÁ±ªÊù•Ëß¶ÂèëCSSÂä®ÁîªÂíåÊ≠£Á°ÆÊòæÁ§∫
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }

        function closeNetworkConfigModal() {
            const modal = document.getElementById('networkConfigModal');
            modal.classList.remove('show');
            // Á≠âÂæÖÂä®ÁîªÂÆåÊàêÂêéÈöêËóèÊ®°ÊÄÅÊ°Ü
            setTimeout(() => {
                modal.style.display = 'none';
            }, 400);
        }

        async function loadNetworkConfig() {
            try {
                // ‰ªélocalStorageËé∑Âèñ‰øùÂ≠òÁöÑÁΩëÂÖ≥Âú∞ÂùÄ
                const savedGatewayAddress = getSavedGatewayAddress();
                
                // ËÆæÁΩÆÁΩëÂÖ≥Âú∞ÂùÄÂ≠óÊÆµÔºàÈªòËÆ§‰∏∫Á©∫ÊàñÊòæÁ§∫‰øùÂ≠òÁöÑÂú∞ÂùÄÔºâ
                document.getElementById('gatewayAddress').value = savedGatewayAddress;
                
                // Â¶ÇÊûúÊúâ‰øùÂ≠òÁöÑÁΩëÂÖ≥Âú∞ÂùÄÔºåÂ∞ùËØï‰ªéÁΩëÂÖ≥Ëé∑ÂèñMQTTÈÖçÁΩÆ
                if (savedGatewayAddress) {
                    const gatewayUrl = getGatewayUrl();
                    const response = await fetch(`${gatewayUrl}/api/network_config`);
                    
                    if (response.ok) {
                        const config = await response.json();
                        console.log('Network config loaded:', config);
                        
                        // Â°´ÂÖÖMQTTËÆæÁΩÆ - Ê†πÊçÆMQTTËøûÊé•Áä∂ÊÄÅÂà§Êñ≠ÊòØÂê¶ÂêØÁî®
                        const mqttEnabled = config.mqtt_connected || (config.mqtt_server && config.mqtt_server !== '');
                        document.getElementById('mqttEnabled').checked = mqttEnabled;
                        toggleMqttSettings(mqttEnabled);
                        
                        if (mqttEnabled) {
                            document.getElementById('mqttServer').value = config.mqtt_server || '192.168.1.250';
                            document.getElementById('mqttPort').value = config.mqtt_port || '1883';
                            document.getElementById('mqttUsername').value = config.mqtt_user || '';
                            document.getElementById('mqttPassword').value = config.mqtt_pass || '';
                        }
                    } else {
                        console.log('Could not load MQTT configuration from gateway');
                        setDefaultMqttValues();
                    }
                } else {
                    console.log('No gateway address saved, using default MQTT values');
                    setDefaultMqttValues();
                }
            } catch (error) {
                console.error('Failed to load network configuration:', error);
                // Âç≥‰ΩøÂä†ËΩΩÂ§±Ë¥•Ôºå‰πüË¶ÅËÆæÁΩÆÁΩëÂÖ≥Âú∞ÂùÄÂ≠óÊÆµ
                const savedGatewayAddress = getSavedGatewayAddress();
                document.getElementById('gatewayAddress').value = savedGatewayAddress;
                setDefaultMqttValues();
            }
        }
        
        function setDefaultValues() {
            // ËÆæÁΩÆÈªòËÆ§ÂÄº
            document.getElementById('gatewayAddress').value = getSavedGatewayAddress();
            setDefaultMqttValues();
        }
        
        function setDefaultMqttValues() {
            // ËÆæÁΩÆMQTTÈªòËÆ§ÂÄº
            document.getElementById('mqttServer').value = '192.168.1.250';
            document.getElementById('mqttPort').value = 1883;
        }

        function toggleMqttSettings(enabled) {
            const mqttSettings = document.getElementById('mqttSettings');
            mqttSettings.style.display = enabled ? 'block' : 'none';
        }

        // ‰øùÂ≠òÁΩëÂÖ≥ÈÖçÁΩÆÔºà‰ªÖÊú¨Âú∞‰øùÂ≠òÔºâ
        function saveGatewayConfig() {
            console.log('saveGatewayConfig called');
            
            const newGatewayAddress = document.getElementById('gatewayAddress').value;
            
            if (!newGatewayAddress) {
                if (window.notificationManager) {
                    window.notificationManager.show('Please enter a gateway address', 'error');
                }
                return;
            }
            
            // È™åËØÅIPÂú∞ÂùÄÊ†ºÂºè
            const ipPattern = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/;
            if (!ipPattern.test(newGatewayAddress)) {
                if (window.notificationManager) {
                    window.notificationManager.show('Please enter a valid IP address', 'error');
                }
                return;
            }
            
            // Áõ¥Êé•‰ΩøÁî®localStorage‰øùÂ≠òÁΩëÂÖ≥Âú∞ÂùÄ
            localStorage.setItem('gateway_host', newGatewayAddress);
            console.log('Gateway address saved to localStorage:', newGatewayAddress);
            
            // ‰øùÂ≠òÂà∞localStorage
            localStorage.setItem('gateway_host', newGatewayAddress);
            
            if (window.notificationManager) {
                window.notificationManager.show('Gateway configuration saved locally', 'success');
            }
        }

        // Ëé∑Âèñ‰øùÂ≠òÁöÑÁΩëÂÖ≥Âú∞ÂùÄ
        function getSavedGatewayAddress() {
            return localStorage.getItem('gateway_host') || '';
        }

        // Ëé∑ÂèñWebSocket URL
        function getWebSocketUrl() {
            const savedAddress = getSavedGatewayAddress();
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            if (savedAddress) {
                return `${protocol}//${savedAddress}/ws`;
            }
            // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÂú∞ÂùÄÔºå‰ΩøÁî®ÈªòËÆ§Âú∞ÂùÄ
            return `${protocol}//192.168.1.66/ws`;
        }

        // Ëé∑ÂèñÁΩëÂÖ≥URL
        function getGatewayUrl() {
            const savedHost = getSavedGatewayAddress();
            if (savedHost) {
                return `http://${savedHost}:80`;
            }
            // Â¶ÇÊûúÊ≤°Êúâ‰øùÂ≠òÁöÑÂú∞ÂùÄÔºå‰ΩøÁî®ÈªòËÆ§Âú∞ÂùÄ
            return 'http://192.168.1.66:80';
        }

        // ‰øùÂ≠òMQTTÈÖçÁΩÆÔºàÂèëÈÄÅÁªôÁΩëÂÖ≥Ôºâ
        async function saveMqttConfig() {
            // ÂáÜÂ§áMQTTÈÖçÁΩÆÊï∞ÊçÆ
            const mqttConfig = {
                mqttEnabled: document.getElementById('mqttEnabled').checked,
                mqttServer: document.getElementById('mqttServer').value,
                mqttPort: parseInt(document.getElementById('mqttPort').value) || 1883,
                mqttUsername: document.getElementById('mqttUsername').value,
                mqttPassword: document.getElementById('mqttPassword').value
            };

            try {
                // ‰ΩøÁî®Êú¨Âú∞‰øùÂ≠òÁöÑÁΩëÂÖ≥Âú∞ÂùÄÂèëÈÄÅMQTTÈÖçÁΩÆ
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/network_config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(mqttConfig)
                });

                if (response.ok) {
                    if (window.notificationManager) {
                        window.notificationManager.show('MQTT configuration saved successfully', 'success');
                    }
                } else {
                    throw new Error('Failed to save MQTT configuration');
                }
            } catch (error) {
                console.error('Failed to save MQTT configuration:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('Failed to save MQTT configuration: ' + error.message, 'error');
                }
            }
        }

        // ‰øùÁïôÂéüÊúâÁöÑsaveNetworkConfigÂáΩÊï∞‰ª•Èò≤ÂÖ∂‰ªñÂú∞ÊñπË∞ÉÁî®
        async function saveNetworkConfig() {
            const newGatewayAddress = document.getElementById('gatewayAddress').value;
            
            // 1. È¶ñÂÖàÂ§ÑÁêÜÁΩëÂÖ≥Âú∞ÂùÄ - Âè™‰øùÂ≠òÂú®Êú¨Âú∞Ôºå‰∏çÂèëÈÄÅÁªôÁΩëÂÖ≥
            if (newGatewayAddress) {
                // ‰øùÂ≠òÂà∞localStorage
                localStorage.setItem('gateway_host', newGatewayAddress);
                console.log('Gateway address updated locally to:', newGatewayAddress);
            }
            
            // 2. ÂáÜÂ§áMQTTÈÖçÁΩÆÊï∞ÊçÆ - Âè™ÂèëÈÄÅMQTTÁõ∏ÂÖ≥‰ø°ÊÅØÁªôÁΩëÂÖ≥
            const mqttConfig = {
                mqttEnabled: document.getElementById('mqttEnabled').checked,
                mqttServer: document.getElementById('mqttServer').value,
                mqttPort: parseInt(document.getElementById('mqttPort').value) || 1883,
                mqttUsername: document.getElementById('mqttUsername').value,
                mqttPassword: document.getElementById('mqttPassword').value
            };

            try {
                // 3. ÂèëÈÄÅMQTTÈÖçÁΩÆÁªôÁΩëÂÖ≥
                const gatewayUrl = getGatewayUrl();
                const response = await fetch(`${gatewayUrl}/api/network_config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(mqttConfig)
                });

                if (response.ok) {
                    if (window.notificationManager) {
                        window.notificationManager.show('Network configuration saved successfully', 'success');
                    }
                    closeNetworkConfigModal();
                } else {
                    throw new Error('Failed to save MQTT configuration');
                }
            } catch (error) {
                console.error('Failed to save network configuration:', error);
                if (window.notificationManager) {
                    window.notificationManager.show('Failed to save network configuration: ' + error.message, 'error');
                }
            }
        }

        // MQTT checkbox change event
        document.addEventListener('DOMContentLoaded', function() {
            const mqttCheckbox = document.getElementById('mqttEnabled');
            if (mqttCheckbox) {
                mqttCheckbox.addEventListener('change', function() {
                    toggleMqttSettings(this.checked);
                });
            }
        });
    </script>
</body>
</html>